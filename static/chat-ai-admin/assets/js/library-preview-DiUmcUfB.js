import{b as $e,B as Mt,bt as bn,d as Ze,M as ge,dg as Sn,V as wn,E as Oe,Z as xn,dk as Pt,dl as Dt,k as pe,ds as Ft,dv as zt,bU as $n,bL as Nt,dw as Cn,bM as Ln,bN as qn,bP as On,dx as In,e as At,dy as En,a1 as Tn,bq as Rn,h as Mn,dz as Pn,df as It,dA as Dn,dB as Fn,bO as zn}from"../../index-uZrSGPJ2.js";import{M as h,N as l,W as n,k as t,S as o,u as Y,a1 as De,a2 as Fe,e as s,B as Ce,x as He,a7 as H,Z as X,F as _e,a0 as Se,z as Ge,a4 as Ke,d as ve,D as Bt,ai as it,Y as E,X as Pe,$ as he,G as ct,Q as j,a6 as Ht,a3 as Ut,a8 as Nn}from"./vue-chunks-Dagx-vSq.js";import{_ as An}from"./empty-CzGZrENG.js";import{P as Qt}from"./PlusOutlined-C4d6M8_0.js";import{S as Ve,a as Jt,c as We,C as jt,b as Bn,E as Hn}from"./edit-subsection-cG3aOyrO.js";import{Z as Un,f as Qn,a as Jn,P as jn,H as Gn,C as Vn,b as Wn}from"./cu-scroll-BO4GvUZt.js";import{S as Ue}from"./index-CM4FzrBV.js";import{M as rt,_ as ut}from"./index-DGr8yI5G.js";import{S as Gt}from"./SettingOutlined-D4VpY35h.js";import"./index-o3ZFs3wF.js";import{D as dt}from"./dropdown-DE5F1xap.js";import{S as Vt}from"./SyncOutlined-Ch07vr7Q.js";import{M as Wt}from"./MoreOutlined-kHjt-rxT.js";import{_ as Xe}from"./index-EWP4miKO.js";import{_ as Be}from"./cu-scroll-Bo1cIjk3.js";import{F as Zn,_ as Kn}from"./index-BuYscfp6.js";import{S as Zt,a as Kt}from"./index-CbTVyCU8.js";import{R as Xn}from"./rename-modal-4KS83veW.js";import{V as Et}from"./vue-pdf-embed-C14rZuMz.js";import{S as Yn,a as ea,D as ta,E as na}from"./edit-fragment-alert-CVWodMqe.js";import{C as aa}from"./ClockCircleFilled-B1dDXySF.js";import{_ as oa,a as la}from"./index-ByxtaxSL.js";import{B as sa,_ as ia}from"./index-Cq7Nz-OJ.js";import{L as ca}from"./LeftOutlined-q_SFvfQo.js";import{S as ra}from"./index-B8sjaOdJ.js";import{T as ua,_ as da}from"./index-CIQLI7yb.js";import{D as Tt}from"./DownOutlined-CJyYwwtm.js";import{_ as _a,a as pa}from"./RadioButton-B7NLGGfS.js";import"./axios-BZ84_VUH.js";import"./qs-CSiAN3u4.js";import"./crypto-js-DN0vhd75.js";import"./dayjs-CZ5VaChI.js";import"./index-Jtlfy8YK.js";import"./Input-CkgxEQH_.js";import"./FormItemContext-Cs8-ygLw.js";import"./index-CJgvF6wP.js";import"./inputProps-CFzerOIV.js";import"./Search-B1xKt77Y.js";import"./SearchOutlined--FowkdKA.js";import"./isPlainObject-CAcuZItg.js";import"./TextArea-CjFwG0DD.js";import"./index-BIs6ICi9.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./Password-DhHqQ7fn.js";import"./index-Bi5kf31a.js";import"./index-CLrhMurQ.js";import"./index-BpPh0jW3.js";import"./Trigger-DoXVYhN4.js";import"./DownloadOutlined-UDtYdZdd.js";import"./CheckOutlined-l1N7JgI5.js";import"./collapseMotion-D5mGic4t.js";import"./index-IWUv0U_C.js";import"./index-DZ2o5D62.js";import"./index-BMSQkwth.js";import"./index-C9RJKJL_.js";import"./index-BThAHFbp.js";import"./UpOutlined-BXhmIP9E.js";import"./pull-up.esm-D94Swpvl.js";import"./observe-dom.esm-CyCedSm-.js";import"./shallowequal-CI97GdPH.js";import"./slide-BIPMUmGB.js";import"./RightOutlined-BOG0y4Nw.js";import"./move-Cj-Coe07.js";import"./colors-Bq--hzfJ.js";import"./responsiveObserve-FU3Dn2XC.js";import"./QuestionCircleOutlined-DaqtyhFd.js";import"./model-select-CZ-kRbBO.js";import"./index-B4Fh64Os.js";import"./index-CveYuLtq.js";import"./index-Dcu1AEuu.js";import"./useMaxLevel-G_tCMKFf.js";import"./CaretDownFilled-DFwBTbBj.js";import"./index-BQH61rer.js";import"./css-DbBMd65r.js";import"./fromPairs-Dx9PT-t0.js";import"./index-DvpvmHbh.js";import"./Checkbox-SbuG5kqh.js";import"./index-BZeZ1Fpr.js";import"./CaretDownOutlined-BrBGZpG7.js";import"./pick-aPNHTXm1.js";const _t=x=>(De("data-v-8eb7d862"),x=x(),Fe(),x),fa={class:"empty-box"},ma=_t(()=>n("img",{src:An,alt:""},null,-1)),va=_t(()=>n("div",{class:"title"},"知识库文档为空，请添加分段",-1)),ha=_t(()=>n("span",null,"添加分段",-1)),ga={__name:"empty",props:{detailsInfo:{type:Object}},emits:["openEditSubscription"],setup(x,{emit:oe}){const $=oe,U=()=>{$("openEditSubscription",{})};return(r,m)=>{const g=Mt;return l(),h("div",fa,[ma,va,n("div",null,[t(g,{type:"primary",onClick:U},{icon:o(()=>[t(Y(Qt))]),default:o(()=>[ha]),_:1})])])}}},st=$e(ga,[["__scopeId","data-v-8eb7d862"]]),ka=x=>(De("data-v-f0ead6c0"),x=x(),Fe(),x),ya={class:"chart-wrapper"},ba=ka(()=>n("div",{class:"chart-mini-map",id:"chatMap"},null,-1)),Sa={class:"zoom-toolbar-wrapper"},wa={__name:"chart-box",emits:["nodeClick"],setup(x,{expose:oe,emit:$}){const U=$,r=s(null);let m=null;const g=Ce({nodes:[],edges:[]}),M=s(1),T={},C=()=>{m&&m.destroy();const f={layout:"forceDirected",initialZoom:M.value,disableTelemetry:!0,maxZoom:10,minZoom:.1,minimapContainer:document.getElementById("chatMap"),styling:{minimapViewportBoxColor:"#4399FF",selectedBorderColor:"rgba(255, 255, 255, 1)"}},p=document.getElementById("chartBox");m=new Qn(p,g.nodes,g.edges,f,T);const w=new Jn(m);new jn(m),w.updateCallback("onZoom",I=>{M.value=Number(I.toFixed(1))}),new Gn(m,{drawShadowOnHover:!0}),new Vn(m,{selectOnClick:!0}).updateCallback("onNodeClick",I=>{U("nodeClick",I)})},V=f=>{M.value=f,m&&m.setZoom(f)},i=({nodes:f,edges:p})=>{g.nodes=[g.nodes,...f],g.edges=[g.edges,...p],m&&m.addElementsToGraph(f,p)},N=({nodes:f,edges:p})=>{g.nodes=[g.nodes,...f],g.edges=[g.edges,...p],m&&m.addAndUpdateElementsInGraph(f,p)},ee=({nodes:f,edges:p})=>{g.nodes=f,g.edges=p,m&&m.updateElementsInGraph(f,p)},L=()=>{m&&m.destroy()},Q=({nodes:f,edges:p})=>{g.nodes=f,g.edges=p,C()};return He(()=>{}),oe({render:Q,add:i,addAndUpdate:N,update:ee,destroy:L}),(f,p)=>(l(),h("div",ya,[n("div",{class:"chart",id:"chartBox",ref_key:"chartBox",ref:r},null,512),ba,n("div",Sa,[t(Un,{value:M.value,onChange:V},null,8,["value"])])]))}},xa=$e(wa,[["__scopeId","data-v-f0ead6c0"]]),Qe=x=>(De("data-v-bb7b1011"),x=x(),Fe(),x),$a={key:0,class:"popup-wrapper entity-details-wrapper"},Ca={class:"popup-header"},La=Qe(()=>n("div",{class:"popup-title"},"实体详情",-1)),qa={key:0,class:"popup-body"},Oa={class:"popup-content"},Ia={class:"entity-details"},Ea={class:"entity-item"},Ta=Qe(()=>n("div",{class:"entity-item-header"},[n("div",{class:"entity-item-label"},"实体")],-1)),Ra={class:"entity-name"},Ma={class:"entity-item",style:{"margin-bottom":"8px"}},Pa=Qe(()=>n("div",{class:"entity-item-header"},[n("div",{class:"entity-item-label"},"归属文档")],-1)),Da={class:"file-info"},Fa={class:"file-name"},za={class:"entity-item"},Na=Qe(()=>n("div",{class:"entity-item-header"},[n("div",{class:"entity-item-label"},"分段")],-1)),Aa={class:"doc-item"},Ba={class:"fragment-content"},Ha={class:"entity-item"},Ua=Qe(()=>n("div",{class:"entity-item-header"},[n("div",{class:"entity-item-label"},"子图")],-1)),Qa={key:0,class:""},Ja={class:"fragment-content"},ja={__name:"entity-details",setup(x,{expose:oe}){const $=Ce({show:!1,node:null,fromNodes:[]}),U=()=>{$.show=!1};return oe({open:(m,g)=>{$.node=m,$.fromNodes=g,$.show?($.show=!1,Ge(()=>{$.show=!0})):$.show=!0},close:U}),(m,g)=>{const M=Ze;return $.show?(l(),h("div",$a,[n("div",Ca,[La,t(Y(bn),{class:"close-btn",onClick:U})]),$.node?(l(),h("div",qa,[t(Wn,null,{default:o(()=>[n("div",Oa,[n("div",Ia,[n("div",Ea,[Ta,n("div",Ra,X($.node.name),1)]),n("div",Ma,[Pa,n("div",Da,[t(M,{class:"file-icon",name:"doc-file",style:{}}),n("span",Fa,X($.node.file_name),1)])]),n("div",za,[Na,n("div",null,[n("div",Aa,[n("div",Ba,X($.node.content),1)])])]),n("div",Ha,[Ua,n("div",null,[$.fromNodes.length==0?(l(),h("div",Qa,"无")):H("",!0),(l(!0),h(_e,null,Se($.fromNodes,T=>(l(),h("div",{class:"subgraph-item",key:T.id},[n("div",Ja,X(T.name),1)]))),128))])])])])]),_:1})])):H("",!0)])):H("",!0)}}},Ga=$e(ja,[["__scopeId","data-v-bb7b1011"]]),Va={class:"graph-model-body"},Wa={key:0,class:"loading-wrapper"},Za={class:"right-box"},Ka={__name:"index",setup(x,{expose:oe}){const $=s(!1),U=s(null),r=s(null),m=s(null),g=s(!1),M=Ce({file_id:"",data_id:""}),T=Ce({edges:[],nodes:[]});let C={};const V=()=>{i()},i=()=>{g.value=!0,Sn({file_id:M.file_id,data_id:M.data_id,search_term:M.search_term}).then(f=>{g.value=!1;let p=f.data.edges||[],w=f.data.nodes||[];const k=new Map;p=p.filter(y=>{const D=`${y.from_id}_${y.to_id}`,se=`${y.to_id}_${y.from_id}`;return k.has(D)||k.has(se)?!1:(k.set(D,!0),!0)}),p.forEach(y=>{y.id=y.id.toString(),y.from=y.from_id.toString(),y.to=y.to_id.toString(),y.caption=y.label});const I=new Set(p.map(y=>y.from)),ne=new Set(p.map(y=>y.to));w.forEach(y=>{y.caption=y.name,y.id=y.id.toString(),y.nodeType=I.has(y.id)&&ne.has(y.id)?"both":I.has(y.id)?"from":ne.has(y.id)?"to":"normal",y.nodeType==="from"?(y.size=35,y.color="#FFB1B2"):y.nodeType==="to"?(y.size=45,y.color="#005AFF"):(y.size=30,y.color="#69E9BE")});let le={edges:p,nodes:w};T.edges=le.edges,T.nodes=le.nodes,setTimeout(()=>{r.value.render(le)},0),C={},p.forEach(y=>{C[y.to]||(C[y.to]=[]),C[y.to].push(y.from)})}).catch(f=>{g.value=!1})},N=f=>{let p=C[f.id]||[],w=[];for(let k=0;k<T.nodes.length;k++)p.indexOf(T.nodes[k].id)>-1&&w.push(T.nodes[k]);m.value.open(f,w)},ee=()=>{r.value.destroy(),$.value=!1},L=()=>{$.value=!1};return oe({open:f=>{M.file_id=f.file_id,M.data_id=f.id,$.value=!0,setTimeout(()=>{V()},350)}}),(f,p)=>{const w=Ue,k=ge;return l(),h("div",{ref_key:"mymodal",ref:U},[t(k,{wrapClassName:"graph-model-wrapper",zIndex:99999,centered:"",open:$.value,"onUpdate:open":p[0]||(p[0]=I=>$.value=I),title:"知识图谱",width:"90vw",footer:null,onOk:L,onCancel:ee},{default:o(()=>[n("div",Va,[g.value?(l(),h("div",Wa,[t(w)])):H("",!0),t(xa,{ref_key:"chartBoxRef",ref:r,loading:g.value,onNodeClick:N},null,8,["loading"]),n("div",Za,[t(Ga,{ref_key:"entityDetailsRef",ref:m},null,512)])])]),_:1},8,["open"])],512)}}},Xa=$e(Ka,[["__scopeId","data-v-56e1b6be"]]),Ya=x=>(De("data-v-1dcfe3b0"),x=x(),Fe(),x),eo={class:"subsection-box-title"},to=["onClick"],no={class:"top-block"},ao={class:"title"},oo={class:"title-block"},lo={class:"status-box"},so={class:"cfb363f"},io={class:"split-err"},co={key:0},ro={class:"cfb363f"},uo={class:"right-opration"},_o={class:"hover-btn-box"},po=["onClick"],fo=Ya(()=>n("div",null,"精选设置",-1)),mo=["onClick"],vo=["onClick"],ho={class:"hover-btn-box"},go={class:"hover-btn-box"},ko=["onClick"],yo=["onClick"],bo={key:0,class:"content-box"},So={key:1,class:"content-box"},wo=["onMouseup","innerHTML"],xo={key:2,class:"fragment-img"},$o=["src"],Co={__name:"subsection-box",props:{paragraphLists:{type:Array,default:()=>[]},detailsInfo:{type:Object,default:()=>{}},total:{type:[Number,String],default:0}},emits:["handleDelParagraph","handleScrollTargetPage","openEditSubscription","handleConvert","getStatrList","handleSplit","handleSplitNext","handleSplitUp","handleSplitDelete","handleSegmentation"],setup(x,{expose:oe,emit:$}){const U=Ke(),r=$,m=x,g=(u,d)=>{let{id:A,title:R,content:ue,question:K,answer:G,images:ie,category_id:_}=u,ce=u.similar_questions||[];ge.confirm({title:"重新转换确认",icon:null,content:`确定要重新转换【分段${d+1}】吗?`,onOk(){return new Promise(z=>{Ft({id:A,title:R,content:ue,question:K,answer:G,images:ie,category_id:_,similar_questions:JSON.stringify(ce)}).then(()=>{r("handleConvert",u),z()}).catch(()=>{z()})})},onCancel(){}})},M=u=>{r("openEditSubscription",u)},T=u=>{ge.confirm({title:"提示",icon:t(Oe),content:"确认是否删除该分段?",onOk(){return new Promise(d=>{zt({id:u}).then(()=>{pe.success("删除成功"),r("handleDelParagraph",u),d()}).catch(()=>{d()})})},onCancel(){}})},C=(u,d,A)=>{window.getSelection().toString().trim()||(r("handleScrollTargetPage",{page_num:u.page_num,index:d}),we(A))},V=u=>{r("handleSegmentation",u)},i=s([]),N=()=>{let u={file_id:U.query.id};Pt(u).then(d=>{i.value=d.data||[],r("getStatrList",d.data||[])})};N();const ee=s(null),L=()=>{ee.value.show()},Q=u=>{var A;let d=(A=i.value.filter(R=>R.id==u.category_id)[0])==null?void 0:A.type;return d?We[d]:""},f=(u,d={})=>{Dt({id:u.id,category_id:d.id||0}).then(()=>{pe.success("设置成功"),u.category_id=d.id,N()})},p=s(null),w=u=>{p.value.open(u)},k=s(null),I=s(!1),ne=s({x:0,y:0}),le=s(""),y=s(null),D=s({text:"",parentIndex:-1,originalHtml:""}),se=ve(()=>{if(!I.value)return{};const u=162;let d=ne.value.x,A=ne.value.y;const R=k.value.getBoundingClientRect(),ue=window.innerWidth;d<10?d=10:d+u>ue-50&&(d=ue-u-50);const K=d-R.left,G=A;return{left:`${K}px`,top:`${G}px`}}),F=(u,d)=>{setTimeout(()=>{const A=window.getSelection(),R=A.toString().trim();if(R){u.stopPropagation(),D.value={text:R,parentIndex:d,originalHtml:m.paragraphLists[d].content},le.value=R,y.value=A.getRangeAt(0).cloneRange();const K=A.getRangeAt(0).getBoundingClientRect(),G=k.value.getBoundingClientRect();ne.value={x:K.left+K.width/2,y:K.top-G.top-50},I.value=!0}else I.value=!1},50)},J=u=>{const{parentIndex:d}=D.value;switch(u){case"separate":Ee(d);break;case"merge-next":S(d);break;case"merge-prev":ye(d);break;case"delete":Ie(d);break}I.value=!1,window.getSelection().removeAllRanges()},ke=(u,d,A)=>{if(d===0&&A===u.textContent.length&&u.textContent.trim().length>0)return["",u.innerHTML,""];const ue=document.createTreeWalker(u,NodeFilter.SHOW_TEXT);let K,G=0,ie,_,ce,z;for(;K=ue.nextNode();){const O=K.nodeValue.length;if(!ie&&G+O>=d&&(ie=K,ce=d-G),!_&&G+O>=A){_=K,z=A-G;break}G+=O}const be=document.createRange();be.setStart(ie,ce),be.setEnd(_,z);const Le=document.createRange();Le.setStart(u,0),Le.setEnd(ie,ce);const a=document.createRange();return a.setStart(_,z),a.setEnd(u,u.childNodes.length),[fe(Le),fe(be),fe(a)]},fe=u=>{const d=document.createElement("div");return d.appendChild(u.cloneContents()),d.innerHTML},Ee=u=>{const d=m.paragraphLists[u].content,R=window.getSelection().getRangeAt(0);R.toString()&&ge.confirm({title:"单独分段",icon:t(Oe),content:"确认将该分段内容单独分段么？分段后，原分段的内容会被删除",onOk(){const K=document.createElement("div");K.innerHTML=d;const[G,ie,_]=ke(K,R.startOffset,R.endOffset),ce=G.replace(/<[^>]+>/g,"").trim()==="",z=_.replace(/<[^>]+>/g,"").trim()==="";ce&&z?r("handleSplit",{index:u,beforeContent:"",selectedContent:ie,afterContent:"",isFullSelection:!0}):r("handleSplit",{index:u,beforeContent:G,selectedContent:ie,afterContent:_,originalSelection:{start:R.startOffset,end:R.endOffset,parentIndex:u}})}})},S=u=>{if(u>=m.paragraphLists.length-1)return pe.error("没有下一个分段");const d=m.paragraphLists[u].content,R=window.getSelection().getRangeAt(0);R.toString()&&ge.confirm({title:"合并到下一个分段",icon:t(Oe),content:"确认将该分段内容合并到下一个分段么？分段后，原分段的内容会被删除",onOk(){const K=document.createElement("div");K.innerHTML=d;const[G,ie,_]=ke(K,R.startOffset,R.endOffset),ce=G.replace(/<[^>]+>/g,"").trim()==="",z=_.replace(/<[^>]+>/g,"").trim()==="";ce&&z?r("handleSplitNext",{index:u,beforeContent:"",selectedContent:ie,afterContent:"",isFullSelection:!0}):r("handleSplitNext",{index:u,beforeContent:G,selectedContent:ie,afterContent:_,originalSelection:{start:R.startOffset,end:R.endOffset,parentIndex:u}})}})},ye=u=>{if(u<=0)return pe.error("没有上一个分段");const d=m.paragraphLists[u].content,R=window.getSelection().getRangeAt(0);R.toString()&&ge.confirm({title:"合并到上一个分段",icon:t(Oe),content:"确认将该分段内容合并到上一个分段么？分段后，原分段的内容会被删除",onOk(){const K=document.createElement("div");K.innerHTML=d;const[G,ie,_]=ke(K,R.startOffset,R.endOffset),ce=G.replace(/<[^>]+>/g,"").trim()==="",z=_.replace(/<[^>]+>/g,"").trim()==="";ce&&z?r("handleSplitUp",{index:u,beforeContent:"",selectedContent:ie,afterContent:"",isFullSelection:!0}):r("handleSplitUp",{index:u,beforeContent:G,selectedContent:ie,afterContent:_,originalSelection:{start:R.startOffset,end:R.endOffset,parentIndex:u}})}})},Ie=u=>{const d=m.paragraphLists[u].content,R=window.getSelection().getRangeAt(0);R.toString()&&ge.confirm({title:"删除",icon:t(Oe),content:"确认将该分段内容删除么？",onOk(){const K=document.createElement("div");K.innerHTML=d;const[G,ie,_]=ke(K,R.startOffset,R.endOffset),ce=G.replace(/<[^>]+>/g,"").trim()==="",z=_.replace(/<[^>]+>/g,"").trim()==="";ce&&z?r("handleSplitDelete",{index:u,beforeContent:"",selectedContent:"",afterContent:"",isFullSelection:!0}):r("handleSplitDelete",{index:u,beforeContent:G,selectedContent:"",afterContent:_,originalSelection:{start:R.startOffset,end:R.endOffset,parentIndex:u}})}})},we=u=>{I.value&&!u.target.closest(".bubble-card")&&(I.value=!1)};return He(()=>{document.addEventListener("click",we)}),Bt(()=>{document.removeEventListener("click",we)}),oe({handleOpenEditModal:M}),(u,d)=>{const A=Xe,R=ut,ue=rt,K=dt,G=Ze,ie=it("viewer");return l(),h("div",{class:"subsection-box content-container",ref_key:"containerRef",ref:k},[n("div",eo,[E(" 分段预览 "),n("span",null,"共"+X(m.total)+"个分段",1)]),(l(!0),h(_e,null,Se(m.paragraphLists,(_,ce)=>(l(),h("div",{class:"list-item",key:_.id,onClick:he(z=>C(_,ce,z),["stop"]),style:Pe({"--status-color":Q(_)})},[n("div",no,[n("div",ao,[E(" 分段"+X(ce+1)+" ",1),n("div",oo,X(_.title),1),n("span",null,"共"+X(_.word_total)+"个字符",1),n("span",lo,[E(" 嵌入状态："+X(_.status_text),1),_.status==3?(l(),j(Y(wn),{key:0})):H("",!0),_.status==2&&_.errmsg?(l(),j(A,{key:1,title:_.errmsg},{default:o(()=>[n("strong",so,[E("原因"),t(Y(Oe),{class:"err-icon cfb363f"})])]),_:2},1032,["title"])):H("",!0),_.split_status==4&&_.split_err_msg?(l(),j(A,{key:2,title:_.split_err_msg},{default:o(()=>[n("div",io,[t(Y(xn),{style:{"margin-left":"0"},class:"cfb363f"}),E(" 分段失败 ")])]),_:2},1032,["title"])):H("",!0)]),x.detailsInfo.graph_switch?(l(),h("span",co,[E(" 知识图谱状态："+X(_.graph_status_text)+" ",1),_.graph_status==3&&_.graph_err_msg?(l(),j(A,{key:0,title:_.graph_err_msg},{default:o(()=>[n("strong",ro,[E("原因"),t(Y(Oe),{class:"err-icon cfb363f"})])]),_:2},1032,["title"])):H("",!0)])):H("",!0)]),n("div",uo,[t(K,null,{overlay:o(()=>[t(ue,null,{default:o(()=>[(l(!0),h(_e,null,Se(i.value,z=>(l(),j(R,{key:z.id},{default:o(()=>[n("div",{class:"start-item",onClick:he(be=>f(_,z),["stop"])},[t(Y(Ve),{style:Pe({color:Y(We)[z.type]})},null,8,["style"]),n("div",null,X(z.name||"-"),1)],8,po)]),_:2},1024))),128)),t(R,null,{default:o(()=>[n("div",{class:"start-item",onClick:he(L,["stop"])},[t(Y(Gt)),fo])]),_:1})]),_:2},1024)]),default:o(()=>[n("div",_o,[_.category_id>0?(l(),j(Y(Ve),{key:0,onClick:he(z=>f(_,{}),["stop"]),style:Pe({color:Q(_),"font-size":"16px"})},null,8,["onClick","style"])):(l(),j(Y(Jt),{key:1,onClick:z=>f(_,i.value[0]),style:{"font-size":"16px",color:"#595959"}},null,8,["onClick"]))])]),_:2},1024),t(A,null,{title:o(()=>[E("重新分段")]),default:o(()=>[n("div",{class:"hover-btn-box",onClick:he(z=>V(_),["stop"])},[t(G,{name:"segmentation-icon",style:{"font-size":"16px"}})],8,mo)]),_:2},1024),x.detailsInfo.graph_switch?(l(),j(A,{key:0},{title:o(()=>[E("知识图谱")]),default:o(()=>[n("div",{class:"hover-btn-box",onClick:z=>w(_)},[t(G,{name:"graph-icon",style:{"font-size":"16px",color:"#595959"}})],8,vo)]),_:2},1024)):H("",!0),t(A,null,{title:o(()=>[E("重新转换")]),default:o(()=>[n("div",ho,[t(Y(Vt),{onClick:he(z=>g(_,ce),["stop"])},null,8,["onClick"])])]),_:2},1024),t(K,{placement:"bottomRight"},{overlay:o(()=>[t(ue,null,{default:o(()=>[t(R,null,{default:o(()=>[n("div",{onClick:he(z=>M(_),["stop"])},"编辑",8,ko)]),_:2},1024),t(R,null,{default:o(()=>[n("div",{onClick:he(z=>T(_.id),["stop"])},"删除",8,yo)]),_:2},1024)]),_:2},1024)]),default:o(()=>[n("div",go,[t(Y(Wt),{style:{"font-size":"16px",color:"#595959"}})])]),_:2},1024)])]),_.question?(l(),h("div",bo,"Q："+X(_.question),1)):H("",!0),_.answer?(l(),h("div",So,"A："+X(_.answer),1)):H("",!0),n("div",{class:"content-box",onMouseup:he(z=>F(z,ce),["stop"]),innerHTML:_.content},null,40,wo),_.images.length>0?ct((l(),h("div",xo,[(l(!0),h(_e,null,Se(_.images,(z,be)=>(l(),h("img",{key:be,src:z,alt:""},null,8,$o))),128))])),[[ie]]):H("",!0)],12,to))),128)),t(jt,{onOk:N,ref_key:"classificationMarkModalRef",ref:ee},null,512),t(Xa,{ref_key:"graphModelRef",ref:p},null,512),I.value?(l(),h("div",{key:0,class:"bubble-card",style:Pe(se.value)},[n("button",{class:"bubble-item",onClick:d[0]||(d[0]=he(_=>J("separate"),["stop"]))},[t(G,{name:"segmentation",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),E(" 单独成段 ")]),n("button",{class:"bubble-item",onClick:d[1]||(d[1]=he(_=>J("merge-prev"),["stop"]))},[t(G,{name:"segmentation-up",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),E(" 合并到上一分段 ")]),n("button",{class:"bubble-item",onClick:d[2]||(d[2]=he(_=>J("merge-next"),["stop"]))},[t(G,{name:"segmentation-down",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),E(" 合并到下一分段 ")]),n("button",{class:"bubble-item",onClick:d[3]||(d[3]=he(_=>J("delete"),["stop"]))},[t(G,{name:"delete",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),E(" 删除 ")])],4)):H("",!0)],512)}}},Rt=$e(Co,[["__scopeId","data-v-1dcfe3b0"]]),Lo={class:"mode-box"},qo=["innerHTML"],Oo={class:"tag-item"},Io={__name:"segmentation-mode",props:{detailsInfo:{type:Object}},setup(x){const oe=x,$=s(""),U=ve(()=>{const{is_table_file:r,is_qa_doc:m,is_diy_split:g,question_lable:M,answer_lable:T,separators:C,chunk_size:V,chunk_overlap:i,question_column:N,answer_column:ee,qa_index_type:L,doc_type:Q}=oe.detailsInfo;if(r!=1&&m!=1&&g!=1)return Q==3?($.value=`分段模式：手动分段
文档类型：普通文档`,"自定义：普通文档"):($.value=`分段模式：智能分段
文档类型：普通文档`,"智能分段：普通文档");if(r!=1&&m==1)return Q==3?($.value=`分段模式：手动分段
文档类型：QA文档`,"自定义：QA文档"):($.value=`分段模式：智能分段
文档类型：QA文档
问题开始标识符："${M}"
答案开始标识符："${T}"`,"智能分段：QA文档");if(r!=1&&m!=1&&g==1)return $.value=`分段模式：自定义分段
文档标识符：${C}
分段最大长度：${V}字符
文段重叠长度：${i}字符`,"自定义分段";if(r==1&&m!=1)return $.value=`分段模式：智能分段
文档类型：普通表格`,"智能分段：普通表格";if(r==1&&m==1){let f=L==1?"问题与答案一起生成索引":"仅对问题生成索引";return $.value=`分段模式：智能分段
文档类型：QA文档
问题所在列："${N}"
答案所在列："${ee}"
索引方式：${f}`,"智能分段：QA文档"}});return(r,m)=>{const g=Xe;return l(),h("div",Lo,[t(g,null,{title:o(()=>[n("div",{class:"tooltip-text-box",innerHTML:$.value},null,8,qo)]),default:o(()=>[n("div",Oo,X(U.value),1)]),_:1})])}}},Eo=$e(Io,[["__scopeId","data-v-e8649c10"]]),To={__name:"update-frequency",emits:["ok"],setup(x,{expose:oe,emit:$}){const U=$,r=s(!1),m=s(!1),g=Ce({doc_auto_renew_frequency:1,id:""}),M=C=>{let{doc_auto_renew_frequency:V,id:i}=C;g.doc_auto_renew_frequency=+V,g.id=i,r.value=!0},T=()=>{m.value=!0,$n({...g}).then(C=>{U("ok",g.doc_auto_renew_frequency),r.value=!1,pe.success("设置成功")}).finally(()=>{m.value=!1})};return oe({open:M}),(C,V)=>{const i=Kt,N=Zt,ee=Kn,L=Zn,Q=ge;return l(),h("div",null,[t(Q,{open:r.value,"onUpdate:open":V[1]||(V[1]=f=>r.value=f),"confirm-loading":m.value,maskClosable:!1,title:"设置更新频率",onOk:T},{default:o(()=>[t(L,{style:{margin:"32px 0"},layout:"vertical",model:g},{default:o(()=>[t(ee,{name:"doc_auto_renew_frequency",label:"更新频率",required:""},{default:o(()=>[t(N,{value:g.doc_auto_renew_frequency,"onUpdate:value":V[0]||(V[0]=f=>g.doc_auto_renew_frequency=f),style:{width:"100%"}},{default:o(()=>[t(i,{value:1},{default:o(()=>[E("不自动更新")]),_:1}),t(i,{value:2},{default:o(()=>[E("每天")]),_:1}),t(i,{value:3},{default:o(()=>[E("每3天")]),_:1}),t(i,{value:4},{default:o(()=>[E("每7天")]),_:1}),t(i,{value:5},{default:o(()=>[E("每30天")]),_:1})]),_:1},8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open","confirm-loading"])])}}},Ro={class:"loading"},Mo={__name:"pdf-preview",props:{source:{type:[String],required:!0},pageSize:{type:Number,default:10}},emits:["onScrollEnd","select","rendered","scroll","getTotalPage"],setup(x,{expose:oe,emit:$}){const U=x,r=$,m=s(null),g=s([]),M=s(0),T=s(!1),C=ve(()=>T.value?null:{"border-bottom":"2px solid #d9d9d9"}),V=s({fade:!1,scrollbarTrackClickable:!0,interactive:!0,minSize:40});He(async()=>{const p=await Et.getDocument(U.source).promise;M.value=p.numPages,r("getTotalPage",M.value),i()});const i=(p=null)=>{const w=g.value.length;if(w>=M.value||T.value)return;T.value=!0;const k=[];for(let I=1;I<=U.pageSize&&w+I<=M.value;I++)k.push(w+I);g.value.push(...k),Ge(()=>{typeof p=="function"&&p()})},N=p=>{i(),r("onScrollEnd",p)},ee=p=>{Ge(()=>{p===g.value[g.value.length-1]&&(T.value=!1,r("rendered",p,M.value))})},L=p=>{r("select",p)},Q=()=>m.value,f=p=>{r("scroll",p)};return oe({loadMore:i,getScrollInstance:Q}),(p,w)=>{const k=Ue;return l(),j(Be,{scrollbar:V.value,ref_key:"scrollRef",ref:m,onScroll:f,onOnScrollEnd:N},{default:o(()=>[(l(!0),h(_e,null,Se(g.value,I=>(l(),j(Y(Et),{onClick:ne=>L(I),key:I,source:x.source,page:I,onRendered:()=>ee(I),style:Pe(C.value)},null,8,["onClick","source","page","onRendered","style"]))),128)),n("div",Ro,[T.value?(l(),j(k,{key:0})):H("",!0)])]),_:1},8,["scrollbar"])}}},Po=$e(Mo,[["__scopeId","data-v-8520f2eb"]]),Do=x=>(De("data-v-7dfdd770"),x=x(),Fe(),x),Fo={key:0,class:"loading-wrap"},zo={class:"document-segmentation"},No={class:"page-container"},Ao={class:"page-left"},Bo={class:"page-right"},Ho={class:"document-fragment-preview"},Uo={class:"preview-header"},Qo=Do(()=>n("span",{class:"label-text"},"分段预览",-1)),Jo={class:"fragment-number"},jo={key:1,class:"loading-box"},Go="你是一位文章分段助手，根据文章内容的语义进行合理分段，确保每个分段表述一个完整的语义，每个分段字数控制在500字左右，最大不超过1000字。请严格按照文章内容进行分段，不要对文章内容进行加工，分段完成后输出分段后的内容。",Vo={__name:"document-segmentation-model",props:{pdfState:{type:Object,default:()=>{}},currentData:{type:Object,default:()=>{}},paragraphType:{type:String,default:""}},emits:["ok","finish","loading"],setup(x,{expose:oe,emit:$}){const U=Ke(),r=$,{id:m}=U.query,g=s(!0),M=s(1);let T=!1;const C=x,V=s(1);let i={id:m,separators_no:"",chunk_size:512,chunk_overlap:50,is_qa_doc:0,question_lable:"",answer_lable:"",enable_extract_image:!0,ai_chunk_size:5e3,ai_chunk_model:"",ai_chunk_model_config_id:"",ai_chunk_prumpt:Go,ai_chunk_task_id:""};const N=s(null),ee=a=>{typeof a.separators_no=="object"&&(a.separators_no=a.separators_no.join(",")),i={...i,...a},T?ge.confirm({title:"提醒",icon:t(Oe),content:"文档片段已被编辑重新获取文档片段会丢失当前修改过的文档片段内容，确定要重新获取吗？",okText:"确定",okType:"danger",cancelText:"取消",onOk(){T=!1,fe("create")},onCancel(){}}):(T=!1,fe("create"))};let L=60*10,Q=0;const f=s({}),p=s(0),w=()=>{g.value||(g.value=!0),Nt({id:m}).then(async a=>{const{status:O}=a.data;if(p.value=a.data.library_type,f.value=a.data,i={...i,separators_no:a.data.separators_no||"11,12",chunk_size:+a.data.chunk_size||512,ai_chunk_size:+a.data.ai_chunk_size||5e3,chunk_overlap:+a.data.chunk_overlap||50,is_qa_doc:p.value==2?1:0,question_lable:a.data.question_lable,answer_lable:a.data.answer_lable,question_column:a.data.question_column,answer_column:a.data.answer_column,enable_extract_image:a.data.enable_extract_image=="true",qa_index_type:+a.data.qa_index_type,chunk_type:+a.data.chunk_type,semantic_chunk_size:+a.data.semantic_chunk_size||512,semantic_chunk_overlap:+a.data.semantic_chunk_overlap||50,semantic_chunk_threshold:+a.data.semantic_chunk_threshold||90,semantic_chunk_use_model:a.data.semantic_chunk_use_model||"",ai_chunk_prumpt:a.data.ai_chunk_prumpt||"",ai_chunk_model:a.data.ai_chunk_model||"",semantic_chunk_model_config_id:a.data.semantic_chunk_model_config_id>0?a.data.semantic_chunk_model_config_id:"",ai_chunk_model_config_id:a.data.ai_chunk_model_config_id>0?a.data.ai_chunk_model_config_id:"",ai_chunk_task_id:a.data.ai_chunk_task_id||""},a.data.chunk_type==0&&(i={...i,separators_no:a.data.normal_chunk_default_separators_no,chunk_size:a.data.normal_chunk_default_chunk_size,chunk_overlap:a.data.normal_chunk_default_chunk_overlap,chunk_type:+a.data.default_chunk_type,semantic_chunk_size:+a.data.semantic_chunk_default_chunk_size,semantic_chunk_overlap:+a.data.semantic_chunk_default_chunk_overlap,semantic_chunk_threshold:+a.data.semantic_chunk_default_threshold,semantic_chunk_use_model:a.data.default_use_model||"",semantic_chunk_model_config_id:a.data.default_model_config_id>0?a.data.default_model_config_id:""}),O==0){if(Q++,Q>L){ge.error({title:"提醒",content:"文档解析速度慢请稍后再试"});return}setTimeout(()=>{w()},1e3)}else(O==4||O==2)&&(g.value=!1,M.value=parseInt(a.data.is_table_file),a.data.library_id,p.value==2?(i.question_lable||i.question_column)&&fe():fe());a.data.is_table_file==1&&I()})};He(async()=>{await w()});const k=s([]),I=()=>{qn({id:m}).then(a=>{let O=[];for(let ae in a.data)O.push({lable:a.data[ae],value:ae});k.value=O})},ne=s(!1),le=s(!1),y=s(""),D=s(null);let se=null;const F=s([]),J=s(0),ke=ve(()=>J.value<=0),fe=a=>{var re;r("loading",!0);let O={...i,semantic_chunk_model_config_id:i.semantic_chunk_model_config_id?+i.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:i.ai_chunk_model_config_id?+i.ai_chunk_model_config_id:0,...C.pdfState};i.chunk_type==3&&(i.ai_chunk_task_id&&!a&&(O.ai_chunk_task_id=i.ai_chunk_task_id),O.ai_chunk_task_id&&a&&a==="create"&&delete O.ai_chunk_task_id);let ae=Ln;return C.paragraphType&&C.paragraphType==="paragraphsSegmented"&&a=="create"&&(ae=In,delete O.id),C.paragraphType&&C.paragraphType==="paragraphsSegmented"&&!a?(F.value=C.currentData.list||[],J.value=C.currentData.list.length,i.chunk_type==3&&(y.value=((re=C.currentData.split_params)==null?void 0:re.ai_chunk_task_id)||"",le.value=!0,N.value.reLoading=!0,D.value=null,!i.ai_chunk_task_id&&M.value!=1||a&&a==="create"?(F.value=[],J.value=0,Ie()):(le.value=!1,N.value.reLoading=!1)),i.chunk_type!=3&&(N.value.reLoading=!1,N.value.saveLoading=!1),r("loading",!1),!1):ae(O).then(xe=>{var qe;F.value=xe.data.list||[],J.value=xe.data.list.length||0,i.chunk_type==3&&(y.value=((qe=xe.data.split_params)==null?void 0:qe.ai_chunk_task_id)||"",le.value=!0,N.value.reLoading=!0,N.value.saveLoading=!0,D.value=null,!i.ai_chunk_task_id&&M.value!=1||a&&a==="create"?(F.value=[],J.value=0,Ie()):(le.value=!1,N.value.reLoading=!1,N.value.saveLoading=!1))}).finally(()=>{i.chunk_type!=3&&(N.value.reLoading=!1,N.value.saveLoading=!1),r("loading",!1)})},Ee=a=>{V.value=a},S=async()=>{var a;try{const O=await we();return O.data.err_msg?(D.value=O.data.err_msg,!0):((a=O.data.list)==null?void 0:a.length)>0?(F.value=O.data.list||[],J.value=O.data.list.length||0,!0):!1}catch{return D.value="请求异常，停止轮询",!0}};function ye(a){return a.split("message:")[1]}const Ie=()=>{const a=async()=>{if(!await S())se=setTimeout(a,3e3);else if(le.value=!1,N.value.reLoading=!1,N.value.saveLoading=!1,se!==null&&(clearTimeout(se),se=null),ne.value&&z(),D.value){let ae=ye(D.value);ge.error({title:"分段失败提示",content:ae?`模型调用失败，失败原因：${ae}`:"模型调用失败"})}};a()},we=()=>On({id:i.id,task_id:y.value}),u=s(null);let d=null;const A=({title:a,content:O,question:ae,answer:re,images:xe},qe)=>{d=qe,u.value.open({title:a,content:O,question:ae,answer:re,images:xe})},R=({title:a,content:O,question:ae,answer:re,images:xe})=>{(F.value[d].title!=a||F.value[d].content!=O||F.value[d].question!=ae||F.value[d].answer!=re)&&(T=!0),F.value[d].title=a,F.value[d].content=O,F.value[d].question=ae,F.value[d].answer=re,F.value[d].images=xe,F.value[d].word_total=re.length+ae.length+O.length},ue=a=>{ge.confirm({title:"提醒",icon:t(Oe),content:"确定要删除这个片段吗?",okText:"确定",okType:"danger",cancelText:"取消",onOk(){T=!0,F.value.splice(a,1)},onCancel(){}})},K=s(""),G=a=>{K.value=a},ie=s(!1),_=()=>{let a=N.value.formState;a=JSON.parse(JSON.stringify(a)),typeof a.separators_no=="object"&&(a.separators_no=a.separators_no.join(",")),i={...i,...a}},ce=a=>{let O=0;return a.forEach(ae=>{O+=parseInt(ae.word_total)}),O},z=async()=>{if((J.value<=0||i.chunk_type!=V.value)&&(_(),await fe()),_(),K.value)return pe.error(K.value);if(i.chunk_type==3&&!F.value.length)return ne.value=!0,!1;y.value&&(i.ai_chunk_task_id=y.value);let a={...i,semantic_chunk_model_config_id:i.semantic_chunk_model_config_id?+i.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:i.ai_chunk_model_config_id?+i.ai_chunk_model_config_id:0,is_table_file:M.value,...C.pdfState};delete a.id;let O={file_id:m,word_total:ce(F.value),split_params:JSON.stringify(a),list:JSON.stringify(F.value),...C.pdfState};a.is_qa_doc==1&&(O.qa_index_type=a.qa_index_type),ie.value=!0,C.paragraphType&&C.paragraphType==="paragraphsSegmented"&&(O.data_id=O.data_ids,delete O.data_ids),Cn(O).then(()=>{r("ok"),r("finish")}).finally(()=>{ie.value=!1}).catch(ae=>{ae.data&&ae.data.index&&Le(ae.data.index),r("finish")})},be=s(null),Le=a=>{a=a-1;let O=be.value.querySelectorAll(".fragment-item");O.length>=a&&O[a].scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})};return Bt(()=>{se&&(clearTimeout(se),se=null)}),oe({handleSaveLibFileSplit:z}),(a,O)=>{const ae=Ue;return l(),h(_e,null,[g.value?(l(),h("div",Fo,[t(ae)])):H("",!0),n("div",zo,[n("div",No,[n("div",Ao,[t(Yn,{excellQaLists:k.value,libFileInfo:f.value,library_type:p.value,mode:M.value,hideSave:!0,status:"paragraphsSegmented",ref_key:"segmentationSettingRef",ref:N,onChange:ee,onChangeChunkType:Ee,onSave:z,onValidate:G},null,8,["excellQaLists","libFileInfo","library_type","mode"])]),n("div",Bo,[n("div",Ho,[n("div",Uo,[Qo,n("span",Jo,"共"+X(J.value)+"个分段",1)]),ke.value&&!le.value?(l(),j(ea,{key:0})):H("",!0),le.value?(l(),h("div",jo,[t(ae),E("数据处理中...")])):H("",!0),n("div",{class:"preview-box",ref_key:"previewBoxRef",ref:be},[(l(!0),h(_e,null,Se(F.value,(re,xe)=>(l(),h("div",{class:"fragment-item",key:re.number},[t(ta,{status:"paragraphsSegmented",currentData:x.currentData,number:re.number,title:re.title,content:re.content,total:re.word_total,question:re.question,answer:re.answer,images:re.images,onDelete:qe=>ue(xe),onEdit:qe=>A(re,xe)},null,8,["currentData","number","title","content","total","question","answer","images","onDelete","onEdit"])]))),128))],512)])])]),t(na,{ref_key:"editFragmentAlertRef",ref:u,onOk:R},null,512)])],64)}}},Xt=$e(Vo,[["__scopeId","data-v-7dfdd770"]]),Wo={class:"select-box"},Zo=["onClick"],Ko={class:"title"},Xo={class:"desc"},Yo={key:0,class:"card-switch"},el={class:"main-content-box"},tl={__name:"re-segmentation-page",props:{detailsInfo:{type:Object,default:()=>{}}},emits:["ok","enable"],setup(x,{expose:oe,emit:$}){const U=At(),r=ve(()=>{var J;return((J=U.companyInfo)==null?void 0:J.ali_ocr_switch)=="1"}),m=Ke().query,g=Ut(),M=x,T=s(!1),C=s(!1),V=s(""),i=$;let N={};const ee=s([{title:"图文OCR解析",desc:"通过OCR文字识别提取pdf文件内容，可以兼容扫描件，但是解析速度较慢。",icon:"pdf-ocr",pdf_parse_type:2},{title:"纯文本解析",desc:"只提取Pdf中的文字内容，如果文档为扫描件可能提取不到内容。",icon:"pdf-text",pdf_parse_type:1},{title:"图文解析",desc:"提取PDF文档中的图片和文字",icon:"pdf-img",pdf_parse_type:3}]),L=Ce({pdf_parse_type:2,pdf_page_num:0}),Q=()=>{ee.value=ee.value.filter(J=>J.pdf_parse_type!=4),i("enable")},f=s(!1),p=J=>{f.value=J},w=J=>{N={...J},L.pdf_parse_type=2,L.pdf_page_num=J.pdf_page_num,J.type==1&&(V.value=`当页(${J.pdf_page_num})重新分段`),J.type==2&&(V.value="将文档重新分段"),J.type==3&&(V.value="重新学习文档",ee.value.push({title:"阿里云OCR解析",desc:"通过阿里云文档智能接口解析提取图片和文字",icon:"ali-ocr",pdf_parse_type:4})),T.value=!0},k=()=>{window.open("#/user/aliocr")},I=J=>{if(J.pdf_parse_type==4&&!r.value)return!1;L.pdf_parse_type=J.pdf_parse_type},ne=s(!1),le=()=>{if(N.type==3){if(L.pdf_parse_type==1){g.push("/library/document-segmentation?document_id="+m.id+"&source=preview");return}ne.value=!0,En({id:m.id,pdf_parse_type:L.pdf_parse_type}).then(J=>{pe.success("重新学习成功"),(L.pdf_parse_type==2||L.pdf_parse_type==3||L.pdf_parse_type==4)&&g.push({path:"/library/details/knowledge-document",query:{id:M.detailsInfo.library_id}}),L.pdf_parse_type==1&&g.push("/library/document-segmentation?document_id="+m.id+"&source=preview"),T.value=!1}).finally(()=>{ne.value=!1});return}T.value=!1,C.value=!0},y=s(null),D=()=>{ne.value=!0,y.value.handleSaveLibFileSplit()},se=()=>{pe.success("保存成功"),C.value=!1,i("ok",N.type)},F=()=>{ne.value=!1};return oe({show:w}),(J,ke)=>{const fe=Ze,Ee=ge;return l(),h("div",null,[t(Ee,{open:T.value,"onUpdate:open":ke[0]||(ke[0]=S=>T.value=S),title:V.value,onOk:le,onCancel:Q,width:720,confirmLoading:ne.value},{default:o(()=>[n("div",Wo,[(l(!0),h(_e,null,Se(ee.value,S=>(l(),h("div",{class:Ht(["select-list-item",{active:S.pdf_parse_type==L.pdf_parse_type},{disabled:S.pdf_parse_type==4&&!r.value}]),onClick:ye=>I(S),key:S.pdf_parse_type},[n("div",Ko,[t(fe,{name:S.icon,style:{"font-size":"16px"}},null,8,["name"]),E(" "+X(S.title),1)]),n("div",Xo,X(S.desc),1),S.pdf_parse_type==4&&!r.value?(l(),h("div",Yo,[E(" 未开启阿里云OCR "),n("div",{class:"card-switch-btn",onClick:he(k,["stop"])},"去开启")])):H("",!0)],10,Zo))),128))])]),_:1},8,["open","title","confirmLoading"]),t(Ee,{open:C.value,"onUpdate:open":ke[1]||(ke[1]=S=>C.value=S),onCancel:Q,title:V.value,maskClosable:!1,"ok-text":f.value?"文档解析中,请稍候...":"确定",confirmLoading:ne.value||f.value,onOk:D,width:1e3},{default:o(()=>[n("div",el,[C.value?(l(),j(Xt,{key:0,onOk:se,onFinish:F,onLoading:p,pdfState:L,ref_key:"documentSegmentationModalRef",ref:y},null,8,["pdfState"])):H("",!0)])]),_:1},8,["open","title","ok-text","confirmLoading"])])}}},nl=$e(tl,[["__scopeId","data-v-ed67085d"]]),Ye=x=>(De("data-v-b1f3fb5c"),x=x(),Fe(),x),al={class:"subsection-box"},ol={class:"qa-list-box"},ll={class:"list-item"},sl=Ye(()=>n("div",{class:"list-label"},"问题",-1)),il={class:"list-content"},cl={key:0,class:"list-item"},rl=Ye(()=>n("div",{class:"list-label"},"相似问法",-1)),ul={class:"list-content"},dl={class:"list-item"},_l=Ye(()=>n("div",{class:"list-label"},"答案",-1)),pl={class:"list-content"},fl={class:"fragment-img"},ml=["src"],vl={key:0,class:"status-tag"},hl={key:1,class:"status-tag complete"},gl={class:"status-tag status-error"},kl={key:3,class:"status-tag running"},yl={class:"right-opration"},bl={class:"hover-btn-box"},Sl=["onClick"],wl=Ye(()=>n("div",null,"标记设置",-1)),xl=["onClick"],$l={class:"hover-btn-box"},Cl=["onClick"],Ll=["onClick"],ql={__name:"qa-subsection-box",props:{paragraphLists:{type:Array,default:()=>[]},total:{type:[Number,String],default:0}},emits:["handleDelParagraph","handleScrollTargetPage","openEditSubscription","handleConvert","getStatrList"],setup(x,{expose:oe,emit:$}){const U=$,r=x,m=(L,Q)=>{let{id:f,title:p,content:w,question:k,answer:I,images:ne,category_id:le}=L,y=L.similar_questions||[];ge.confirm({title:"重新转换确认",icon:null,content:`确定要重新转换【分段${Q+1}】吗?`,onOk(){return new Promise((D,se)=>{Ft({id:f,title:p,content:w,question:k,answer:I,images:ne,category_id:le,similar_questions:JSON.stringify(y)}).then(F=>{U("handleConvert",L),D()}).catch(()=>{D()})})},onCancel(){}})},g=L=>{U("openEditSubscription",L)},M=L=>{ge.confirm({title:"提示",icon:t(Oe),content:"确认是否删除该分段?",onOk(){return new Promise((Q,f)=>{zt({id:L}).then(p=>{pe.success("删除成功"),U("handleDelParagraph",L),Q()}).catch(()=>{Q()})})},onCancel(){}})},T=s([]),C=()=>{Pt().then(L=>{T.value=L.data||[],U("getStatrList",L.data||[])})};C();const V=s(null),i=()=>{V.value.show()},N=L=>{var f;let Q=(f=T.value.filter(p=>p.id==L.category_id)[0])==null?void 0:f.type;return Q?We[Q]:"#F4EA2A"},ee=(L,Q={})=>{Dt({id:L.id,category_id:Q.id||0}).then(f=>{pe.success("设置成功"),L.category_id=Q.id})};return oe({handleOpenEditModal:g}),(L,Q)=>{const f=oa,p=Xe,w=Ue,k=ut,I=rt,ne=dt,le=la,y=it("viewer");return l(),h("div",al,[t(le,{"data-source":x.paragraphLists,pagination:!1},{default:o(()=>[t(f,{key:"id","data-index":"id",width:1148},{title:o(()=>[E("问答（共"+X(r.total)+"个）",1)]),default:o(({record:D})=>[n("div",ol,[n("div",ll,[sl,n("div",il,X(D.question),1)]),D.similar_questions&&D.similar_questions.length?(l(),h("div",cl,[rl,n("div",ul,X(D.similar_questions.join("/")),1)])):H("",!0),n("div",dl,[_l,n("div",pl,X(D.answer),1)]),ct((l(),h("div",fl,[(l(!0),h(_e,null,Se(D.images,(se,F)=>(l(),h("img",{key:F,src:se,alt:""},null,8,ml))),128))])),[[y]])])]),_:1}),t(f,{title:"嵌入状态",key:"status_text","data-index":"status_text",width:128},{default:o(({record:D})=>[D.status==0?(l(),h("span",vl,[t(Y(aa)),E(" 未转换")])):H("",!0),D.status==1?(l(),h("span",hl,[t(Y(Tn)),E(" 已转换")])):H("",!0),D.status==2?(l(),j(p,{key:2,placement:"top"},{title:o(()=>[n("span",null,X(D.errmsg),1)]),default:o(()=>[n("span",null,[n("span",gl,[t(Y(Rn)),E(" 转换异常")])])]),_:2},1024)):H("",!0),D.status==3?(l(),h("span",kl,[t(w,{size:"small"}),E(" 转换中")])):H("",!0)]),_:1}),t(f,{title:"操作",key:"action","data-index":"action",width:120},{default:o(({record:D,index:se})=>[n("div",yl,[t(ne,null,{overlay:o(()=>[t(I,null,{default:o(()=>[(l(!0),h(_e,null,Se(T.value,F=>(l(),j(k,{key:F.id},{default:o(()=>[n("div",{class:"start-item",onClick:J=>ee(D,F)},[t(Y(Ve),{style:Pe({color:Y(We)[F.type]})},null,8,["style"]),n("div",null,X(F.name||"-"),1)],8,Sl)]),_:2},1024))),128)),t(k,null,{default:o(()=>[n("div",{class:"start-item",onClick:i},[t(Y(Gt)),wl])]),_:1})]),_:2},1024)]),default:o(()=>[n("div",bl,[D.category_id>0?(l(),j(Y(Ve),{key:0,onClick:F=>ee(D,{}),style:Pe({color:N(D),"font-size":"16px"})},null,8,["onClick","style"])):(l(),j(Y(Jt),{key:1,onClick:F=>ee(D,T.value[0]),style:{"font-size":"16px"}},null,8,["onClick"]))])]),_:2},1024),t(p,null,{title:o(()=>[E("重新转换")]),default:o(()=>[n("div",{class:"hover-btn-box",onClick:F=>m(D,se)},[t(Y(Vt))],8,xl)]),_:2},1024),t(ne,{placement:"bottomRight"},{overlay:o(()=>[t(I,null,{default:o(()=>[t(k,null,{default:o(()=>[n("div",{onClick:he(F=>g(D),["stop"])},"编辑",8,Cl)]),_:2},1024),t(k,null,{default:o(()=>[n("div",{onClick:he(F=>M(D.id),["stop"])},"删除",8,Ll)]),_:2},1024)]),_:2},1024)]),default:o(()=>[n("div",$l,[t(Y(Wt))])]),_:2},1024)])]),_:1})]),_:1},8,["data-source"]),t(jt,{onOk:C,ref_key:"classificationMarkModalRef",ref:V},null,512)])}}},Ol=$e(ql,[["__scopeId","data-v-b1f3fb5c"]]),Il={class:"main-content-box"},El={__name:"segmentation-setting-modal",emits:["ok","enable"],setup(x,{expose:oe,emit:$}){const U=s(!1),r=s("重新分段"),m=$;let g={};const M=Ce({data_ids:0,file_id:0}),T={0:"未转换",1:"已转换",2:"转换异常",3:"转换中",4:"分段失败",10:"分段中"},C=Ce({status:"",errmsg:"",status_text:""}),V=()=>{m("enable")},i=s(!1),N=k=>{i.value=k},ee=k=>{U.value=!0,M.data_ids=k.id,M.file_id=k.file_id,C.list=[{content:k.content,number:k.number,title:k.title,word_total:k.word_total,question:k.question,answer:k.answer,images:k.images}],C.status=k.status,C.errmsg=k.errmsg,C.status_text=T[k.status]},L=s(!1),Q=s(null),f=()=>{L.value=!0,Q.value.handleSaveLibFileSplit()},p=()=>{pe.success("保存成功"),U.value=!1,m("ok",g.type)},w=()=>{L.value=!1};return oe({show:ee}),(k,I)=>{const ne=ge;return l(),h("div",null,[t(ne,{open:U.value,"onUpdate:open":I[0]||(I[0]=le=>U.value=le),onCancel:V,title:r.value,maskClosable:!1,"ok-text":i.value?"文档解析中,请稍候...":"确定",confirmLoading:L.value||i.value,onOk:f,width:1084},{default:o(()=>[n("div",Il,[U.value?(l(),j(Xt,{key:0,onOk:p,onFinish:w,onLoading:N,paragraphType:"paragraphsSegmented",pdfState:M,currentData:C,ref_key:"documentSegmentationModalRef",ref:Q},null,8,["pdfState","currentData"])):H("",!0)])]),_:1},8,["open","title","ok-text","confirmLoading"])])}}},Tl=$e(El,[["__scopeId","data-v-e57c7bfa"]]),et=x=>(De("data-v-ac322fc6"),x=x(),Fe(),x),Rl={class:"library-preview-page"},Ml={class:"breadcrumb-block"},Pl={class:"library-line1"},Dl={class:"selct-star-box"},Fl={class:"document-title-block",style:{height:"22px"}},zl={class:"title"},Nl={class:"search-content-block"},Al={class:"preview-box"},Bl=et(()=>n("span",null,"添加分段",-1)),Hl={key:0,class:"page-loading-box"},Ul={class:"content-block"},Ql={class:"content-block"},Jl={key:1,class:"pdf-view-box"},jl={key:0,class:"pdf-mode-switch"},Gl={key:0},Vl={key:1,class:"segmentation-btn"},Wl=et(()=>n("div",null,"将当页重新分段",-1)),Zl=et(()=>n("div",null,"将文档重新分段",-1)),Kl=et(()=>n("div",null,"重新学习文档",-1)),Xl={class:"view-content-box",style:{"padding-top":"60px"}},Yl=["onClick"],es={key:0,class:"content-box"},ts={key:1,class:"content-box"},ns=["innerHTML"],as={class:"fragment-img"},os=["src"],ls={class:"right-contnt-box"},ss={key:0,class:"right-tabs-box"},is={class:"content-block"},cs="你是一位文章分段助手，根据文章内容的语义进行合理分段，确保每个分段表述一个完整的语义，每个分段字数控制在500字左右，最大不超过1000字。请严格按照文章内容进行分段，不要对文章内容进行加工，分段完成后输出分段后的内容。",rs={__name:"library-preview",setup(x){const oe=At(),$=ve(()=>{var e;return((e=oe.companyInfo)==null?void 0:e.neo4j_status)=="true"}),U=s(!1),r=s(null),m=s(0),g=s(0),M={0:"待生成",4:"生成中",2:"生成成功",3:"生成失败"},T=s([]),C=e=>{T.value=e},V=s({fade:!1,scrollbarTrackClickable:!0,interactive:!0,minSize:40}),i=Ke(),N=Ut(),ee=Mn(),L=ve(()=>w.value.is_table_file=="1"),Q=ve(()=>w.value.doc_type),f=ve(()=>{let e=w.value.status;return!(e=="1"||e=="2")||S.value.length==0}),p=ve(()=>w.value.is_qa_doc=="1"),w=s({}),k=Ce({status:-1,graph_status:-1,category_id:-1}),I=s(1),ne=ve(()=>"/manage/getLibRawFile?id="+i.query.id+"&token="+ee.getToken),le=()=>{N.back()},y=s(null),D=s(null);let se=-1;const F=(e,c=1)=>{let v,q;c==1?(v=".subsection-box .list-item",q=D.value):(v=".view-content-box .list-item",q=y.value);const B=document.querySelectorAll(v)[e];B.classList.add("flash-border"),se>=0&&document.querySelectorAll(v)[se].classList.remove("flash-border"),setTimeout(()=>{se=-1,B.classList.remove("flash-border")},2500),se=e,q.scrollToElement({el:B,time:1e3})},J=s(!0),ke=s(0),fe=s({page:1,size:10}),Ee=s({}),S=s([]),ye=s(0),Ie={0:"未转换",1:"已转换",2:"转换异常",3:"转换中..."},we=Ce({split_status_exception:0,total:0,vector_status_converted:0,vector_status_converting:0,vector_status_exception:0,vector_status_initial:0}),u=Ce([{value:-1,label:"全部",num:ve(()=>we.total)},{value:4,label:"分段失败",num:ve(()=>we.split_status_exception)},{value:0,label:"未转换",num:ve(()=>we.vector_status_initial)},{value:3,label:"转换中",num:ve(()=>we.vector_status_converting)},{value:2,label:"转换异常",num:ve(()=>we.vector_status_exception)},{value:1,label:"已转换",num:ve(()=>we.vector_status_converted)}]),d=s(1);let A={id:i.query.id,separators_no:"",chunk_size:512,chunk_overlap:50,is_qa_doc:0,question_lable:"",similar_label:"",answer_lable:"",enable_extract_image:!0,ai_chunk_size:5e3,ai_chunk_model:"",ai_chunk_model_config_id:"",ai_chunk_prumpt:cs,ai_chunk_task_id:""};const R=s(!1);let ue=!0;(async()=>{Nt({id:i.query.id}).then(e=>{ke.value=e.data.library_type,w.value={...e.data,graph_switch:e.data.graph_switch=="1"&&$.value};let c=e.data.status;c==1||c==2?be():J.value=!1,A={...A,separators_no:e.data.separators_no||"11,12",chunk_size:+e.data.chunk_size||512,ai_chunk_size:+e.data.ai_chunk_size||5e3,chunk_overlap:+e.data.chunk_overlap||50,is_qa_doc:ke.value==2?1:0,question_lable:e.data.question_lable,similar_label:e.data.similar_label,answer_lable:e.data.answer_lable,question_column:e.data.question_column,similar_column:e.data.similar_column,answer_column:e.data.answer_column,enable_extract_image:e.data.enable_extract_image=="true",qa_index_type:+e.data.qa_index_type,chunk_type:+e.data.chunk_type,semantic_chunk_size:+e.data.semantic_chunk_size||512,semantic_chunk_overlap:+e.data.semantic_chunk_overlap||50,semantic_chunk_threshold:+e.data.semantic_chunk_threshold||90,semantic_chunk_use_model:e.data.semantic_chunk_use_model||"",ai_chunk_prumpt:e.data.ai_chunk_prumpt||"",ai_chunk_model:e.data.ai_chunk_model||"",semantic_chunk_model_config_id:e.data.semantic_chunk_model_config_id>0?e.data.semantic_chunk_model_config_id:"",ai_chunk_model_config_id:e.data.ai_chunk_model_config_id>0?e.data.ai_chunk_model_config_id:"",ai_chunk_task_id:e.data.ai_chunk_task_id||""},e.data.chunk_type==0&&(A={...A,separators_no:e.data.normal_chunk_default_separators_no,chunk_size:+e.data.normal_chunk_default_chunk_size,chunk_overlap:+e.data.normal_chunk_default_chunk_overlap,chunk_type:+e.data.default_chunk_type,semantic_chunk_size:+e.data.semantic_chunk_default_chunk_size,semantic_chunk_overlap:+e.data.semantic_chunk_default_chunk_overlap,semantic_chunk_threshold:+e.data.semantic_chunk_default_threshold,semantic_chunk_use_model:e.data.default_use_model||"",semantic_chunk_model_config_id:e.data.default_model_config_id>0?e.data.default_model_config_id:""}),(c==4||c==2)&&(d.value=parseInt(e.data.is_table_file))})})();const G=()=>{Pn({file_id:i.query.id}).then(e=>{Object.assign(we,e.data)})},ie=()=>{window.location.reload()},_=()=>{fe.value.page=1,ye.value=0,S.value=[],be()},ce=e=>{k.category_id=e,_()},z=(e=null)=>{fe.value.page++,be(e)},be=(e=null)=>{ue=!0,It({file_id:i.query.id,...fe.value,...k}).then(c=>{var b,P;J.value=!1,ue=!1;let v=c.data,q=v.list||[],B=((b=v.info)==null?void 0:b.is_qa_doc)=="1"&&((P=v.info)==null?void 0:P.is_table_file)=="1";q.forEach(me=>{me.status_text=Ie[me.status],me.graph_status_text=M[me.graph_status],me.isExcelQa=B,me.similar_questions&&(me.similar_questions=JSON.parse(me.similar_questions))}),Ee.value=v.info,fe.value.page==1&&(S.value=[]),S.value=[...S.value,...q],ye.value=v.total,typeof e=="function"&&e()})},Le=()=>{ue||S.value.length>=ye.value||(z(),r.value&&r.value.loadMore())},a=()=>{re()};let O=null;function ae(){clearInterval(O),S.value.filter(c=>c.status==3).length?O=setInterval(()=>{re()},5e3):clearInterval(O)}const re=()=>{It({file_id:i.query.id,page:1,size:S.value.length,...k}).then(e=>{var B,b;let c=e.data,v=c.list||[],q=((B=c.info)==null?void 0:B.is_qa_doc)=="1"&&((b=c.info)==null?void 0:b.is_table_file)=="1";v.forEach(P=>{P.status_text=Ie[P.status],P.graph_status_text=M[P.graph_status],P.isExcelQa=q,P.similar_questions&&(P.similar_questions=JSON.parse(P.similar_questions))}),S.value=v,ae()})},xe=e=>{if(!e.id){fe.value.page=1,be();return}let c=S.value,v=c.findIndex(q=>q.id==e.id);if(v>-1){let q=c[v];q.title=e.title,q.content=e.content,q.question=e.question,q.answer=e.answer,q.images=e.images,q.category_id=e.category_id,q.word_total=e.question.length+e.answer.length+e.content.length,q.similar_questions=e.similar_questions.length?JSON.parse(e.similar_questions):[],c.splice(v,1,q),S.value=c}},qe=e=>{let c=S.value,v=c.findIndex(q=>q.id==e);v>-1&&(c.splice(v,1),S.value=c,ye.value=ye.value--)},pt=s(null),Me=e=>{pt.value.showModal(JSON.parse(JSON.stringify(e)))},ft=s(null),Yt=()=>{Dn({id:i.query.id}).then(()=>pe.success("操作完成"))},en=()=>{Fn({id:i.query.id}).then(()=>pe.success("操作完成"))},mt=s(null),tn=()=>{mt.value.show(w.value)},vt=()=>{N.push("/library/document-segmentation?document_id="+i.query.id+"&source=preview")},nn=()=>{ft.value.open({id:i.query.id,doc_auto_renew_frequency:w.value.doc_auto_renew_frequency})},an=e=>{w.value.doc_auto_renew_frequency=e},on=e=>{w.value.file_name=e},ln=e=>{const c=()=>{for(let v in S.value)if(S.value[v].page_num==e){F(v);return}};if(e>S.value[S.value.length-1].page_num){pe.warning("分段数据正在加载，请稍后...");const v=()=>{e<=S.value[S.value.length-1].page_num?(pe.success("加载完成"),Ge(()=>{c()})):z(v)};z(v)}else c()},sn=(e,c)=>{g.value=c,m.value=e,S.value[S.value.length-1].page_num<e&&z()},ht=e=>{var c;if(((c=w.value)==null?void 0:c.file_ext)=="pdf"&&I.value==1){const v=e.page_num-1,q=()=>document.querySelectorAll(".pdf-render-box > .scroll-content .vue-pdf-embed")[v],B=()=>{const P=q();P.classList.add("flash-border"),setTimeout(()=>P.classList.remove("flash-border"),2500),r.value.getScrollInstance().scrollToElement({el:P,time:1e3})};if(q())B();else{pe.warning("PDF正在加载，请稍后...");const P=()=>{q()?(pe.success("加载完成"),B()):r.value&&r.value.loadMore()};r.value&&r.value.loadMore(P)}}else F(e.index,2)},tt=s(1);let nt=null;const Je=s(0),cn=e=>{Je.value=e},rn=({y:e})=>{if(!nt){const v=document.querySelectorAll(".pdf-render-box > .scroll-content .vue-pdf-embed")[0];nt=v&&v.clientHeight}let c=Math.floor(Math.abs(e)/nt)+1;tt.value=Math.max(c,1)},at=s(null),ot=s(null),un=e=>{let{key:c}=e;r.value&&r.value.getScrollInstance().disable(),c==1&&at.value.show({type:c,pdf_page_num:tt.value}),c==2&&vt(),c==3&&at.value.show({type:c,pdf_page_num:0})},gt=e=>{ot.value&&ot.value.show(e)},kt=()=>{r.value&&r.value.getScrollInstance().enable()},dn=()=>{kt(),_()},yt=()=>{U.value=!U.value},lt=(e,c)=>{let v=JSON.parse(JSON.stringify(e));return v.content=c,v.word_total=c.length,v},Te=s(!1),Re=s(1),bt=({index:e,beforeContent:c,selectedContent:v,afterContent:q,isFullSelection:B})=>{const b=[...S.value];Te.value=B,Re.value=1,B?(b.splice(e+1,0,lt(b[e],v)),b.splice(e,1)):(b[e].content=c||"",b[e].word_total=c.length||0,q.trim()&&b.splice(e+1,0,lt(b[e],q)),b.splice(e+1,0,lt(b[e],v)),b[e+1].images=[]),S.value=b,ze(b,e)},St=({index:e,beforeContent:c,selectedContent:v,afterContent:q,isFullSelection:B})=>{const b=[...S.value];Te.value=B,Re.value=2;let P=b[e+1].word_total;B?(b[e+1].content=+v,b[e+1].word_total=parseInt(P)+v.length,b.splice(e,1),S.value=b,ze(b,e)):(b[e].content=c||"",b[e].word_total=c.length||0,b[e+1].content+=v,b[e+1].word_total=parseInt(P)+v.length,q.trim()&&(b[e].content+=q||"",b[e].word_total+=q.length||0),S.value=b,ze(b,e+1))},wt=({index:e,beforeContent:c,selectedContent:v,afterContent:q,isFullSelection:B})=>{const b=[...S.value];Te.value=B,Re.value=3;let P=b[e-1].word_total;B?(b[e-1].content+=v,b[e-1].word_total=parseInt(P)+v.length,b.splice(e,1),S.value=b,ze(b,e)):(b[e].content=c||"",b[e].word_total=c.length||0,b[e-1].content+=v,b[e-1].word_total=parseInt(P)+v.length,q.trim()&&(b[e].content+=q||"",b[e].word_total+=q.length||0),S.value=b,ze(b,e-1))},xt=({index:e,beforeContent:c,afterContent:v,isFullSelection:q})=>{const B=[...S.value];Te.value=q,Re.value=4,q?B.splice(e,1):(B[e].content=c||"",B[e].word_total=c.length||0,v.trim()&&(B[e].content+=v||"",B[e].word_total+=v.length||0)),S.value=B,ze(B,e)};function _n(e,c,v={},q){let B=q+1;if(!Array.isArray(e)||!Array.isArray(c))return JSON.stringify([]);const b=e.map((P,me)=>{const W={};for(const Z of c){const Ae=v[Z]||Z,de=P[Ae];if(Object.prototype.hasOwnProperty.call(P,Ae))if(Z==="number")W[Z]=me+1;else if(Z==="page_num"||Z==="word_total")W[Z]=+de;else if(Z==="content"){if(!de)return null;W[Z]=de}else Z==="images"?Re.value==1?Te.value?(B==W.number,W[Z]=de):B+1==W.number?W[Z]=[]:W[Z]=de:Re.value==2?(Te.value,B==W.number,W[Z]=de):Re.value==3?Te.value?(B-1==W.number,W[Z]=de):(B==W.number,W[Z]=de):Re.value==4&&(Te.value,W[Z]=de):W[Z]=de}return W}).filter(P=>P!==null&&P.content!==void 0&&P.content!=="");return JSON.stringify(b)}const pn={similar_question_list:"similar_questions"},ze=async(e,c)=>{let v={...A,semantic_chunk_model_config_id:A.semantic_chunk_model_config_id?+A.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:A.ai_chunk_model_config_id?+A.ai_chunk_model_config_id:0,is_table_file:d.value};delete v.id;let q={id:i.query.id,word_total:ye.value,split_params:JSON.stringify(v),list:_n(e,["number","page_num","title","content","question","similar_question_list","answer","word_total","images"],pn,c)};v.is_qa_doc==1&&(q.qa_index_type=v.qa_index_type),R.value=!0,zn(q).then(B=>{pe.success("操作成功");const b=B.data;for(let P=0;P<b.length;P++){const me=b[P],W=S.value[P];if(P<S.value.length)W.id=me.toString(),W.status="0",W.status_text=Ie[W.status];else break}}).finally(()=>{R.value=!1})};return He(()=>{G(),i.query.graph_status&&(k.graph_status=i.query.graph_status,_())}),(e,c)=>{var Ct,Lt,qt;const v=Nn("router-link"),q=ia,B=sa,b=Ze,P=Mt,me=Kt,W=Zt,Z=ut,Ae=rt,de=dt,fn=ra,mn=Ue,je=Xe,$t=pa,vn=_a,hn=da,gn=ua,kn=it("viewer");return l(),h("div",Rl,[n("div",Ml,[t(B,null,{default:o(()=>[t(q,null,{default:o(()=>[t(v,{to:"/library/list"},{default:o(()=>[E(" 知识库管理 ")]),_:1})]),_:1}),t(q,null,{default:o(()=>[t(v,{to:{path:"/library/details/knowledge-document",query:{id:w.value.library_id}}},{default:o(()=>[n("div",Pl,X(w.value.library_name)+"知识库",1)]),_:1},8,["to"])]),_:1}),t(q,null,{default:o(()=>[E("知识库详情")]),_:1})]),_:1}),n("div",Dl,[t(Bn,{startLists:T.value,onChange:ce},null,8,["startLists"])])]),n("div",Fl,[t(Y(ca),{onClick:le}),n("span",zl,X(w.value.file_name),1),t(Eo,{detailsInfo:w.value},null,8,["detailsInfo"])]),n("div",Nl,[n("div",Al,[U.value?(l(),j(P,{key:1,onClick:c[1]||(c[1]=te=>yt())},{default:o(()=>[t(b,{class:"preview-box-icon",name:"expand"}),E(" 展开预览")]),_:1})):(l(),j(P,{key:0,onClick:c[0]||(c[0]=te=>yt())},{default:o(()=>[t(b,{class:"preview-box-icon",name:"put-away"}),E(" 收起预览")]),_:1}))]),t(fn,null,{default:o(()=>[p.value?(l(),j(W,{key:0,value:k.status,"onUpdate:value":c[2]||(c[2]=te=>k.status=te),placeholder:"请选择",style:{width:"160px"},onChange:_},{default:o(()=>[t(me,{value:-1},{default:o(()=>[E("全部嵌入状态")]),_:1}),(l(),h(_e,null,Se(Ie,(te,Ne)=>t(me,{key:te,value:Ne},{default:o(()=>[E(X(te),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])):H("",!0),w.value.graph_switch?(l(),j(W,{key:1,value:k.graph_status,"onUpdate:value":c[3]||(c[3]=te=>k.graph_status=te),placeholder:"请选择",onChange:_,style:{width:"160px"}},{default:o(()=>[t(me,{value:-1},{default:o(()=>[E("全部知识图谱状态")]),_:1}),(l(),h(_e,null,Se(M,(te,Ne)=>t(me,{key:te,value:Ne},{default:o(()=>[E(X(te),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])):H("",!0),t(de,null,{overlay:o(()=>[t(Ae,null,{default:o(()=>[t(Z,{onClick:Yt},{default:o(()=>[E("重新嵌入向量")]),_:1}),w.value.graph_switch?(l(),j(Z,{key:0,onClick:en},{default:o(()=>[E("重新抽取知识图谱")]),_:1})):H("",!0),t(Z,{onClick:tn},{default:o(()=>[E("重命名")]),_:1}),Q.value==2?(l(),j(Z,{key:1,onClick:nn},{default:o(()=>[E("设置更新频率")]),_:1})):H("",!0)]),_:1})]),default:o(()=>[t(P,null,{default:o(()=>[E("其他操作 "),t(Y(Tt))]),_:1})]),_:1}),Q.value!=3?(l(),j(P,{key:2,onClick:vt},{default:o(()=>[E("重新分段")]),_:1})):H("",!0),t(P,{onClick:c[4]||(c[4]=te=>Me({})),type:"primary"},{icon:o(()=>[t(Y(Qt))]),default:o(()=>[Bl]),_:1})]),_:1})]),J.value?(l(),h("div",Hl,[t(mn)])):(l(),h(_e,{key:1},[p.value?(l(),h(_e,{key:0},[f.value?(l(),j(st,{key:0,onOpenEditSubscription:Me})):(l(),j(Be,{key:1,scrollbar:{minSize:0},onOnScrollEnd:Le},{default:o(()=>[n("div",Ul,[t(Ol,{ref:"subsectionBoxRef",total:ye.value,paragraphLists:S.value,detailsInfo:w.value,onOpenEditSubscription:Me,onHandleDelParagraph:qe,onHandleConvert:a,onGetStatrList:C},null,8,["total","paragraphLists","detailsInfo"])])]),_:1}))],64)):(l(),h(_e,{key:1},[L.value||Q.value==3?(l(),h(_e,{key:0},[f.value?(l(),j(st,{key:0,onOpenEditSubscription:Me})):(l(),j(Be,{key:1,scrollbar:{minSize:0},onOnScrollEnd:Le,disableMouse:!0},{default:o(()=>[n("div",Ql,[t(Rt,{ref:"subsectionBoxRef",total:ye.value,detailsInfo:w.value,paragraphLists:S.value,onOpenEditSubscription:Me,onHandleDelParagraph:qe,onHandleConvert:a,onHandleScrollTargetPage:ht,onGetStatrList:C,onHandleSplit:bt,onHandleSplitNext:St,onHandleSplitUp:wt,onHandleSplitDelete:xt,onHandleSegmentation:gt},null,8,["total","detailsInfo","paragraphLists"])])]),_:1}))],64)):(l(),h("div",Jl,[n("div",{class:Ht(["view-content-wrap",{collapsed:U.value}])},[((Ct=w.value)==null?void 0:Ct.file_ext)=="pdf"?(l(),h("div",jl,[t(vn,{value:I.value,"onUpdate:value":c[5]||(c[5]=te=>I.value=te)},{default:o(()=>[t($t,{value:1},{default:o(()=>[t(je,{placement:"right",title:"原文预览模式下，会展示pdf原始文件内容，手动编辑分段的不会展示。您可以通过原文预览模式，校验分段准确性，然后手动编辑分段。"},{default:o(()=>[E(" 原文预览 "),I.value==1&&Je.value>0?(l(),h("span",Gl,"("+X(tt.value)+" / "+X(Je.value)+")",1)):H("",!0)]),_:1})]),_:1}),t($t,{value:2},{default:o(()=>[E("纯文本预览")]),_:1})]),_:1},8,["value"])])):H("",!0),((Lt=w.value)==null?void 0:Lt.file_ext)=="pdf"?(l(),h("div",Vl,[t(de,null,{overlay:o(()=>[t(Ae,{onClick:un},{default:o(()=>[I.value==1&&Je.value>0?(l(),j(Z,{key:1},{default:o(()=>[t(je,{placement:"right",title:"将当前页重新解析并分段"},{default:o(()=>[Wl]),_:1})]),_:1})):H("",!0),(l(),j(Z,{key:2},{default:o(()=>[t(je,{placement:"right",title:"将整个文档重新分段，注意，重新分段并不会重新提取文档的内容，只是将内容重新分段。"},{default:o(()=>[Zl]),_:1})]),_:1})),(l(),j(Z,{key:3},{default:o(()=>[t(je,{placement:"right",title:"将整个文档重新学习，包含重新解析并提取文档内容，重新分段。"},{default:o(()=>[Kl]),_:1})]),_:1}))]),_:1})]),default:o(()=>[t(P,null,{default:o(()=>[E(" 重新分段 "),t(Y(Tt))]),_:1})]),_:1})])):H("",!0),((qt=w.value)==null?void 0:qt.file_ext)=="pdf"&&I.value==1?(l(),j(Po,{key:2,ref_key:"pdfRef",ref:r,class:"scroll-box pdf-render-box",source:ne.value,onSelect:ln,onScroll:rn,onRendered:sn,onGetTotalPage:cn},null,8,["source"])):(l(),j(Be,{key:3,scrollbar:V.value,ref_key:"leftScrollRef",ref:y,class:"scroll-box",onOnScrollEnd:Le},{default:o(()=>[n("div",Xl,[(l(!0),h(_e,null,Se(S.value,(te,Ne)=>(l(),h("div",{class:"list-item",onClick:Ot=>F(Ne),key:Ne},[te.question?(l(),h("div",es,X(te.question),1)):H("",!0),te.answer?(l(),h("div",ts,X(te.answer),1)):H("",!0),n("div",{class:"content-box",innerHTML:te.content},null,8,ns),ct((l(),h("div",as,[(l(!0),h(_e,null,Se(te.images,(Ot,yn)=>(l(),h("img",{key:yn,src:Ot,alt:""},null,8,os))),128))])),[[kn]])],8,Yl))),128))])]),_:1},8,["scrollbar"]))],2),n("div",ls,[p.value?H("",!0):(l(),h("div",ss,[t(gn,{activeKey:k.status,"onUpdate:activeKey":c[6]||(c[6]=te=>k.status=te),style:{"background-color":"#f2f4f7",padding:"0px 16px","border-radius":"6px"},onChange:_},{default:o(()=>[(l(!0),h(_e,null,Se(u,te=>(l(),j(hn,{key:te.value,tab:`${te.label} (${te.num})`},null,8,["tab"]))),128))]),_:1},8,["activeKey"])])),f.value?(l(),j(st,{key:1,onOpenEditSubscription:Me})):(l(),j(Be,{key:2,scrollbar:V.value,disableMouse:!0,ref_key:"rightScrollRef",ref:D,onOnScrollEnd:Le},{default:o(()=>[n("div",is,[t(Rt,{ref:"subsectionBoxRef",total:ye.value,detailsInfo:w.value,paragraphLists:S.value,onOpenEditSubscription:Me,onHandleDelParagraph:qe,onHandleConvert:a,onHandleScrollTargetPage:ht,onGetStatrList:C,onHandleSplit:bt,onHandleSplitNext:St,onHandleSplitUp:wt,onHandleSplitDelete:xt,onHandleSegmentation:gt},null,8,["total","detailsInfo","paragraphLists"])])]),_:1},8,["scrollbar"]))])]))],64))],64)),t(Hn,{detailsInfo:w.value,onHandleEdit:xe,ref_key:"editSubscriptionRef",ref:pt},null,8,["detailsInfo"]),t(To,{onOk:an,ref_key:"updateFrequencyRef",ref:ft},null,512),t(Xn,{onOk:on,ref_key:"renameModalRef",ref:mt},null,512),t(nl,{onOk:dn,onEnable:kt,detailsInfo:w.value,ref_key:"reSegmentationPageRef",ref:at},null,8,["detailsInfo"]),t(Tl,{ref_key:"segmentationSettingModalRef",ref:ot,onOk:ie},null,512)])}}},Di=$e(rs,[["__scopeId","data-v-ac322fc6"]]);export{Di as default};
