import{M as s,N as t,W as e,a7 as y,a6 as K,F as q,a0 as O,Z as g,d as X,e as x,k as l,S as m,Q as J,u as w,Y as L,G as Z,H as Ie,z as le,a1 as ee,a2 as te,aa as ne,ai as me,w as ge,B as Me,a3 as Le,a4 as ue,a9 as Ee,x as Oe,D as Re,a8 as Be}from"./vue-chunks-DKljrDvA.js";import{u as Ae}from"./useEventBus-BwH2zX88.js";import{u as ve}from"./chat-DFxPh-Nt.js";import{b as N,U as de,d as ae,al as De,bs as he,M as Pe,h as Fe,B as He,by as Ne,k as Ue}from"../../index-G9f-mAi5.js";import{_ as pe}from"./useIM-BVpliyjO.js";import{S as fe}from"./index-BCVTZqK2.js";import{_ as ye}from"./index-iB9ppu1z.js";import{_ as be}from"./cu-scroll-D0dESsq_.js";import{_ as Qe}from"./TextArea-DCKr3Wuq.js";import{Q as H}from"./QuestionCircleOutlined-nxul5uCX.js";import{_ as ke}from"./index-KZiYQ650.js";import{a as je}from"./index-BhykvU14.js";import{V as ze}from"./vue-pdf-embed-fWY1zK5b.js";import{q as Ve}from"./index-C9szxrK8.js";import{u as Je}from"./robot-GAXT284R.js";import{B as Ke,_ as Ge}from"./index-zvO7saP4.js";import{P as Ye}from"./PlusOutlined-7esb8SyJ.js";import"./axios-BZ84_VUH.js";import"./qs-DB0tj3pA.js";import"./crypto-js-fJpLWOEv.js";import"./dayjs-BpZi_McX.js";import"./index-A28_4Xy6.js";import"./Trigger-BW7irFFi.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./colors-6QtHC0k-.js";import"./pull-up.esm-D94Swpvl.js";import"./observe-dom.esm-CyCedSm-.js";import"./FormItemContext-BeRgkpjf.js";import"./index-LTvy7D4z.js";import"./index-BGI9PV4t.js";import"./inputProps-BSdok6V2.js";import"./dropdown-pozH9rVN.js";import"./RightOutlined-D-3gHNct.js";import"./move-ChuBBc75.js";import"./slide-WaU3Tqer.js";import"./index-BZceli48.js";import"./shallowequal-CthuG9FU.js";import"./collapseMotion-CxHtxgWr.js";import"./DownOutlined-Bpohg83O.js";const We={class:"guess-you-want"},Ze={class:"message-tabs"},Xe={key:1,class:"v-line"},et={key:0,class:"message-menus"},tt=["onClick"],st={key:1,class:"message-menus"},ot=["onClick"],nt={__name:"guess-you-want",props:{item:{type:Object,default:()=>{}},common_question_list:{type:Object,default:()=>[]},enable_common_question:{type:Boolean,default:!1}},emits:["clickMeun"],setup(p,{emit:E}){const b=E,o=p,f=(k,c)=>{k.question_tabkey=c},S=k=>{b("clickMeun",k)};return(k,c)=>(t(),s("div",We,[e("div",Ze,[o.item.guess_you_want?(t(),s("div",{key:0,onClick:c[0]||(c[0]=_=>f(o.item,1)),class:K(["tab-item",{active:o.item.question_tabkey==1}])}," 猜你想问 ",2)):y("",!0),o.item.guess_you_want&&o.common_question_list&&o.enable_common_question?(t(),s("div",Xe)):y("",!0),o.common_question_list&&o.enable_common_question?(t(),s("div",{key:2,onClick:c[1]||(c[1]=_=>f(o.item,2)),class:K(["tab-item",{active:o.item.question_tabkey==2}])}," 常见问题 ",2)):y("",!0)]),o.item.question_tabkey==1?(t(),s("div",et,[(t(!0),s(q,null,O(o.item.guess_you_want,(_,u)=>(t(),s("div",{onClick:r=>S(_),class:"menu-item",key:u},g(_),9,tt))),128))])):(t(),s("div",st,[(t(!0),s(q,null,O(p.common_question_list,(_,u)=>(t(),s("div",{onClick:r=>S(_),class:"menu-item",key:u},g(_),9,ot))),128))]))]))}},lt=N(nt,[["__scopeId","data-v-9c22a890"]]),at=p=>(ee("data-v-a04d3aa0"),p=p(),te(),p),it={class:"message-list-wrapper"},ct={class:"message-list"},rt=["id"],_t={class:"itme-left"},ut=["src"],dt={class:"itme-right"},pt={class:"item-body"},mt={class:"message-content"},gt=["id"],vt={class:"itme-left"},ht=["src"],ft={class:"itme-right"},yt={class:"label-flex-block"},bt=["onClick"],kt=at(()=>e("span",{class:"label-text"},"正在检索知识库...",-1)),$t={class:"label-text"},wt=["onClick"],qt={class:"label-text"},St={class:"item-body"},Ct={key:0,class:"file-items"},xt=["onClick"],Tt={class:"file-name"},It={key:0},Mt={key:1},Lt={key:1,class:"thinking-content"},Et={class:"message-content"},Ot={class:"message-menus"},Rt=["onClick"],Bt=["innerHTML"],At={class:"message-menus"},Dt=["onClick"],Pt={key:4,class:"message-content"},Ft=["src"],Ht={key:5,class:"message-action-wrap"},Nt={key:0,class:"message-action"},Ut={class:"action-btn"},Qt=["onClick"],jt={__name:"message-list",props:{messages:{type:Array,default:()=>[]},robotInfo:{type:Object,default:()=>{}}},emits:["clickMsgMeun","scroll","scrollStart","scrollEnd","openPromptLog","openLibrary"],setup(p,{expose:E,emit:b}){const o=b,f=p,S=d=>{d.show_reasoning=!d.show_reasoning},k=d=>{d.show_quote_file=!d.show_quote_file},c=X(()=>f.robotInfo.common_question_list.length?JSON.parse(f.robotInfo.common_question_list):[]),_=X(()=>f.robotInfo.chat_type==1||f.robotInfo.chat_type==3),u=d=>{o("clickMsgMeun",d)},r=x(null),a={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let I=null,A=!1;function Q(d){A||(I&&(clearTimeout(I),I=null),I=setTimeout(()=>{a.scrollTop-d.target.scrollTop>0&&(a.scrollDirection="up"),a.scrollTop-d.target.scrollTop<0&&(a.scrollDirection="down"),a.scrollTop=d.target.scrollTop,a.scrollHeight=d.target.scrollHeight,a.clientHeight=d.target.clientHeight,o("scroll",{...a}),Math.abs(a.scrollTop)<=a.scrollStartDiff&&a.scrollDirection==="up"&&j(),Math.abs(a.scrollHeight-a.scrollTop-a.clientHeight)<=a.scrollEndDiff&&a.scrollDirection==="down"&&P()},50))}function j(){f.messages.length!=0&&o("scrollStart",{msg:f.messages[0]})}function P(){f.messages.length!=0&&o("scrollEnd",{msg:f.messages[f.messages.length-1]})}const W=()=>{r.value&&le(()=>{A=!0,r.value.scrollTop=r.value.scrollHeight+1,setTimeout(()=>{a.scrollTop=r.value.scrollTop,A=!1},50)})};function G(d,T){le(()=>{A=!0,T||(T="top");let M=r.value,i=document.querySelector("#msg-"+d);T=="top"?M.scrollTop=i.offsetTop:M.scrollTop=i.offsetTop-M.clientHeight+i.clientHeight,setTimeout(()=>{a.scrollTop=r.value.scrollTop,A=!1},50)})}function v(){a.scrollTop=0,a.scrollDirection=""}function $(d){return!!(d.quote_file&&d.quote_file.length>0||d.debug&&d.debug.length>0)}function D(d){o("openPromptLog",ne(d))}function R(d,T,M){let i=ne(d);T.message_id=T.message_id||M,i.forEach(B=>{B.message_id=B.message_id||M}),o("openLibrary",i,ne(T))}return E({scrollToBottom:W,scrollToMessage:G,resetScroll:v}),(d,T)=>{const M=fe,i=ae,B=ye,z=me("viewer");return t(),s("div",it,[e("div",{class:"scroll-box",ref_key:"scrollBoxRef",ref:r,onScroll:Q},[e("div",ct,[(t(!0),s(q,null,O(f.messages,n=>(t(),s(q,{key:n.uid},[n.is_customer==1?(t(),s("div",{key:0,class:"message-item user-message",id:"msg-"+n.uid},[e("div",_t,[e("img",{class:"user-avatar",src:n.avatar},null,8,ut)]),e("div",dt,[e("div",pt,[e("div",mt,g(n.content),1)])])],8,rt)):(t(),s("div",{key:1,class:"message-item robot-message",id:"msg-"+n.uid},[e("div",vt,[l(M,{size:"small",spinning:n.loading},{default:m(()=>[e("img",{class:"robot-avatar",src:n.robot_avatar},null,8,ht)]),_:2},1032,["spinning"])]),e("div",ft,[e("div",yt,[n.msg_type==1&&_.value?(t(),s("div",{key:0,class:K(["thinking-label-wrapper",{reasoning_open:n.show_quote_file}])},[e("div",{class:"thinking-label",onClick:C=>k(n)},[n.quote_loading?(t(),s(q,{key:0},[l(w(de),{class:"loading"}),kt],64)):(t(),s(q,{key:1},[l(i,{class:"think-icon",name:"quote-file"}),e("span",$t,"检索到"+g(n.quote_file.length)+"个知识库文档",1)],64)),n.quote_file.length?(t(),J(i,{key:2,name:"arrow-down",class:"arrow-down"})):y("",!0)],8,bt)],2)):y("",!0),n.reasoning_content?(t(),s("div",{key:1,class:K(["thinking-label-wrapper",{reasoning_open:n.show_reasoning}])},[e("div",{class:"thinking-label",onClick:C=>S(n)},[n.reasoning_status?(t(),J(w(de),{key:0,class:"loading"})):(t(),J(i,{key:1,class:"think-icon",name:"think"})),e("span",qt,g(n.reasoning_status?"深度思考中...":"已完成深度思考"),1),n.reasoning_status?y("",!0):(t(),J(i,{key:2,name:"arrow-down",class:"arrow-down"}))],8,wt),l(B,null,{title:m(()=>[L("在应用设置中关闭推理过程开关，将不再显示推理过程")]),default:m(()=>[l(w(De),{class:"tip"})]),_:1})],2)):y("",!0)]),e("div",St,[n.show_quote_file&&n.quote_file&&n.quote_file.length>0?(t(),s("div",Ct,[(t(!0),s(q,null,O(n.quote_file,C=>(t(),s("div",{class:"file-item",key:C.id,onClick:V=>R(n.quote_file,C,n.id)},[e("a",Tt,[l(i,{class:"think-icon",name:"quote-file"}),C.file_name?(t(),s("span",It,g(C.file_name),1)):(t(),s("span",Mt,g(C.library_name)+"-精选",1))])],8,xt))),128))])):y("",!0),n.show_reasoning?(t(),s("div",Lt,[l(pe,{content:n.reasoning_content},null,8,["content"])])):y("",!0),n.msg_type==1?(t(),s(q,{key:2},[Z((t(),s("div",Et,[l(pe,{content:n.content},null,8,["content"])])),[[z]]),e("div",Ot,[(t(!0),s(q,null,O(n.question,(C,V)=>(t(),s("div",{class:"menu-item",onClick:se=>u(C),key:V},g(C),9,Rt))),128))])],64)):y("",!0),n.msg_type==2?(t(),s(q,{key:3},[e("div",{class:"message-content",innerHTML:n.menu_json.content},null,8,Bt),e("div",At,[(t(!0),s(q,null,O(n.menu_json.question,(C,V)=>(t(),s("div",{class:"menu-item",onClick:se=>u(C),key:V},g(C),9,Dt))),128))])],64)):y("",!0),n.msg_type==3?(t(),s("div",Pt,[Z(e("img",{class:"msg-img",src:n.content,alt:""},null,8,Ft),[[z]])])):y("",!0),$(n)?Z((t(),s("div",Ht,[n.debug&&n.debug.length>0?(t(),s("div",Nt,[e("div",Ut,[e("span",null,[e("a",{onClick:C=>D(n)},"Prompt 日志",8,Qt)])])])):y("",!0)],512)),[[Ie,!n.question]]):y("",!0)]),(n.guess_you_want&&n.guess_you_want.length||c.value.length&&f.robotInfo.enable_common_question=="true")&&n.question_tabkey>0?(t(),J(lt,{key:0,item:n,enable_common_question:f.robotInfo.enable_common_question=="true",common_question_list:c.value,onClickMeun:u},null,8,["item","enable_common_question","common_question_list"])):y("",!0)])],8,gt))],64))),128))])],544)])}}},zt=N(jt,[["__scopeId","data-v-a04d3aa0"]]),Vt={class:"chat-list-box"},Jt=["onClick"],Kt={class:"chat-item-title"},Gt={__name:"chat-list",props:{list:{type:Array,default:()=>[]},active:{type:[String,Number],default:""}},emits:["openChat","onScrollEnd"],setup(p,{emit:E}){const b=E,o=p,f=x(null),S=c=>{b("openChat",c)},k=()=>{b("onScrollEnd")};return ge(()=>o.list,()=>{le(()=>{f.value.refresh()})}),(c,_)=>{const u=ae;return t(),s("div",Vt,[l(be,{ref_key:"scroller",ref:f,onOnScrollEnd:k},{default:m(()=>[e("div",null,[(t(!0),s(q,null,O(o.list,r=>(t(),s("div",{class:K(["chat-list-item",{active:r.id==o.active}]),onClick:a=>S(r),key:r.id},[l(u,{class:"chat-item-icon",name:"message"}),e("span",Kt,g(r.subject||r.last_chat_message),1)],10,Jt))),128))])]),_:1},512)])}}},Yt=N(Gt,[["__scopeId","data-v-8a5dd127"]]),Wt=p=>(ee("data-v-47f207c0"),p=p(),te(),p),Zt={class:"message-input-wrapper"},Xt={class:"message-action"},es={class:"loading-action"},ts=["disabled"],ss=Wt(()=>e("span",null,"发送",-1)),os=[ss],ns={__name:"message-input",props:{value:{type:String,default:""},loading:{type:Boolean,default:!1}},emits:["send","update:value"],setup(p,{emit:E}){const b=E,o=p,f=X(()=>o.loading||o.value.trim().length===0),S=_=>{b("update:value",_.target.value.trim())},k=_=>{if(_.key==="Enter"&&!_.shiftKey){if(!_.target.value.trim())return;_.preventDefault(),c()}else _.key==="Enter"&&_.shiftKey&&(_.preventDefault(),b("update:value",o.value+`
`))},c=()=>{b("send",o.value.trim())};return(_,u)=>{const r=Qe,a=fe;return t(),s("div",Zt,[l(r,{value:p.value,"auto-size":{minRows:5,maxRows:5},placeholder:"在此输入您想了解的内容，Shift+Enter换行",onChange:S,onKeydown:k},null,8,["value"]),e("div",Xt,[e("span",es,[l(a,{spinning:p.loading},null,8,["spinning"])]),p.loading?y("",!0):(t(),s("button",{key:0,class:"send-msg-btn",disabled:f.value,onClick:c},os,8,ts))])])}}},ls=N(ns,[["__scopeId","data-v-47f207c0"]]),U=p=>(ee("data-v-c821359c"),p=p(),te(),p),as={class:"prompt-log-content"},is={class:"prompt-log-items"},cs={class:"prompt-log-label"},rs=U(()=>e("span",null,"SYSTEM ",-1)),_s={class:"prompt-log-item"},us={class:"prompt-log-items"},ds={class:"prompt-log-label"},ps=U(()=>e("span",null,"上下文 ",-1)),ms={class:"prompt-log-items"},gs={class:"prompt-log-label"},vs=U(()=>e("span",null,"USER ",-1)),hs={class:"prompt-log-item"},fs={class:"prompt-log-items"},ys={class:"prompt-log-label"},bs=U(()=>e("span",null,"ASSISTANT ",-1)),ks={class:"prompt-log-item"},$s={key:0,class:"prompt-log-items"},ws={class:"prompt-log-label"},qs=U(()=>e("span",null,"Recall time ",-1)),Ss={class:"prompt-log-item"},Cs={key:1,class:"prompt-log-items"},xs={class:"prompt-log-label"},Ts=U(()=>e("span",null,"Request time ",-1)),Is={class:"prompt-log-item"},Ms={class:"prompt-log-items"},Ls={class:"prompt-log-label"},Es=U(()=>e("span",null,"Error ",-1)),Os={class:"prompt-log-item"},Rs={__name:"prompt-log-alert",setup(p,{expose:E}){const b=x(!1),o=Me({prompt:"",library:[],context_qa:[],cur_question:"",cur_answer:"",error:""}),f=()=>{b.value=!1},S=()=>{o.prompt="",o.library=[],o.context_qa=[],o.cur_question="",o.cur_answer="",o.error="",o.recall_time="",o.request_time=""};return E({open:c=>{S(),o.error=c.error,o.recall_time=c.recall_time?(c.recall_time/1e3).toFixed(2):"",o.request_time=c.request_time?(c.request_time/1e3).toFixed(2):"";let _=c.debug||[];for(let u=0;u<_.length;u++){let r=_[u];r.type=="library"?o.library.push(r.content):r.type=="context_qa"?o.context_qa.push(r):o[r.type]=r.content}b.value=!0}}),(c,_)=>{const u=ye,r=ke;return t(),J(r,{class:"prompt-log-alert",open:b.value,"onUpdate:open":_[0]||(_[0]=a=>b.value=a),title:"Prompt 日志",placement:"right",width:"746px",closable:!1},{extra:m(()=>[e("span",{class:"close-btn",onClick:f},[l(w(he))])]),default:m(()=>[e("div",as,[e("div",is,[e("div",cs,[rs,l(u,null,{title:m(()=>[L("系统提示词和文档分段。")]),default:m(()=>[l(w(H),{class:"question-icon"})]),_:1})]),e("div",_s,[e("p",null,g(o.prompt),1)]),(t(!0),s(q,null,O(o.library,(a,I)=>(t(),s("div",{class:"prompt-log-item",key:I},[e("p",null,g(a),1)]))),128))]),e("div",us,[e("div",ds,[ps,l(u,null,{title:m(()=>[L("传递的历史提问消息")]),default:m(()=>[l(w(H),{class:"question-icon"})]),_:1})]),(t(!0),s(q,null,O(o.context_qa,(a,I)=>(t(),s("div",{class:"prompt-log-item",key:I},[e("p",null,"Q："+g(a.question),1),e("p",null,"A："+g(a.answer),1)]))),128))]),e("div",ms,[e("div",gs,[vs,l(u,null,{title:m(()=>[L("本次用户的提问")]),default:m(()=>[l(w(H),{class:"question-icon"})]),_:1})]),e("div",hs,[e("p",null,g(o.cur_question),1)])]),e("div",fs,[e("div",ys,[bs,l(u,null,{title:m(()=>[L("语言模型输出的答案")]),default:m(()=>[l(w(H),{class:"question-icon"})]),_:1})]),e("div",ks,[e("p",null,g(o.cur_answer),1)])]),o.recall_time>0?(t(),s("div",$s,[e("div",ws,[qs,l(u,null,{title:m(()=>[L("从知识库中检索到有效分段所需要的时间，包括对分段进行排序时间。")]),default:m(()=>[l(w(H),{class:"question-icon"})]),_:1})]),e("div",Ss,[e("p",null,g(o.recall_time)+"s",1)])])):y("",!0),o.request_time>0?(t(),s("div",Cs,[e("div",xs,[Ts,l(u,null,{title:m(()=>[L("从发送问题和上下文信息给大模型到大模型开始返回答案的时间。")]),default:m(()=>[l(w(H),{class:"question-icon"})]),_:1})]),e("div",Is,[e("p",null,g(o.request_time)+"s",1)])])):y("",!0),e("div",Ms,[e("div",Ls,[Es,l(u,null,{title:m(()=>[L("报错信息，调用聊天接口报错时会显示。")]),default:m(()=>[l(w(H),{class:"question-icon"})]),_:1})]),e("div",Os,[e("p",null,g(o.error),1)])])])]),_:1},8,["open"])}}},Bs=N(Rs,[["__scopeId","data-v-c821359c"]]),As={class:"library-info-content"},Ds={class:"file-list"},Ps=["onClick"],Fs={key:0},Hs={key:1},Ns={class:"document-items"},Us={class:"document-item-header"},Qs={class:"left-box"},js={class:"document-title"},zs={key:0,class:"document-title"},Vs={class:"document-size"},Js={class:"right-box"},Ks=["onClick"],Gs={class:"document-item-body"},Ys={class:"document-similarity"},Ws={key:0,class:"document-content"},Zs={key:1,class:"document-content"},Xs={class:"document-content"},eo={class:"fragment-img"},to=["src"],so={class:"iframe-box"},oo={__name:"library-info-alert",setup(p,{expose:E}){const b=ve(),{robot:o,user:f}=b;Le();const S=x(!1),k=x([]),c=x(null),_=()=>{k.value=[],c.value=null},u=(v,$)=>{if(_(),k.value=v.map(D=>{let R=null;return D.answer_source_data&&(R=JSON.parse(D.answer_source_data)),{...D,answer_source_data:R}}),c.value=$.id,S.value=!0,$.answer_source_data){a.value=JSON.parse($.answer_source_data)||[];return}I($)},r=v=>{if(v.id!=c.value){if(c.value=v.id,v.answer_source_data){a.value=v.answer_source_data||[];return}I(v)}},a=x([]),I=v=>{je({message_id:v.message_id,file_id:v.id,robot_key:o.robot_key,openid:o.openid}).then($=>{a.value=$.data||[]})},A=()=>{let v=k.value.filter($=>$.id==c.value)[0]||{};v.file_name?window.open(`#/library/preview?id=${c.value}`):window.open(`#/library/details/categary-manage?id=${v.library_id}`)},Q=X(()=>{let v=k.value.filter($=>$.id==c.value)[0]||{};return v.file_name?v.file_name:v.library_name+"-精选"}),j=x(""),P=x(!1),W=v=>{P.value=!0,j.value="/manage/getLibRawFileOnePage?id="+c.value+"&page="+v.page_num+"&admin_user_id="+f.admin_user_id},G=()=>{S.value=!1};return E({open:u}),(v,$)=>{const D=ae,R=ke,d=be,T=Pe,M=me("viewer");return t(),s(q,null,[l(R,{class:"library-info-alert",open:S.value,"onUpdate:open":$[0]||($[0]=i=>S.value=i),title:"答案来源",placement:"right",width:"746px",closable:!1,bodyStyle:{background:"#F2F4F7"}},{extra:m(()=>[e("span",{class:"close-btn",onClick:G},[l(w(he))])]),default:m(()=>[e("div",As,[e("div",Ds,[(t(!0),s(q,null,O(k.value,i=>(t(),s("div",{class:K(["file-item",{active:c.value==i.id}]),key:i.id,onClick:B=>r(i)},[i.file_name?(t(),s("span",Fs,g(i.file_name),1)):(t(),s("span",Hs,g(i.library_name)+"-精选",1))],10,Ps))),128))]),e("div",Ns,[(t(!0),s(q,null,O(a.value,i=>(t(),s("div",{class:"document-item",key:i.id},[e("div",Us,[e("div",Qs,[e("span",js,"id："+g(i.id),1),i.title?(t(),s("span",zs,g(i.title),1)):y("",!0),e("span",Vs," 共"+g(i.word_total)+"个字符 ",1)]),e("div",Js,[i.page_num>0?(t(),s("a",{key:0,onClick:B=>W(i)},"预览原文件>",8,Ks)):y("",!0),e("a",{onClick:A},"查看源文档>")])]),e("div",Gs,[e("div",Ys,[L(" 相似度： "),l(D,{name:"similarity",style:{"font-size":"16px"}}),L(g(i.similarity),1)]),i.question?(t(),s("div",Ws,"Q："+g(i.question),1)):y("",!0),i.answer?(t(),s("div",Zs,"A："+g(i.answer),1)):y("",!0),e("div",Xs,g(i.content),1),Z((t(),s("div",eo,[(t(!0),s(q,null,O(i.images,(B,z)=>(t(),s("img",{key:z,src:B,alt:""},null,8,to))),128))])),[[M]])])]))),128))])])]),_:1},8,["open"]),l(T,{open:P.value,"onUpdate:open":$[1]||($[1]=i=>P.value=i),title:Q.value,footer:null,width:740},{default:m(()=>[e("div",so,[l(d,null,{default:m(()=>[l(w(ze),{source:j.value},null,8,["source"])]),_:1})])]),_:1},8,["open","title"])],64)}}},no=N(oo,[["__scopeId","data-v-e8bc69ca"]]),lo=p=>(ee("data-v-7257bb7b"),p=p(),te(),p),ao={class:"chat-page-wrapper"},io={class:"chat-page-header"},co={class:"breadcrumb-box"},ro={class:"chat-page"},_o={class:"page-left"},uo={class:"page-left-top"},po={class:"page-left-body"},mo=lo(()=>e("div",{class:"page-left-footer"},null,-1)),go={class:"page-body"},vo={class:"chat-box-body"},ho={style:{"margin-top":"30px"},class:"chat-box-footer"},fo={__name:"index",setup(p){const b=ue().query,o=Je(),{getRobot:f,robotInfo:S}=o,k=Ae(),c=ve(),_=Fe();let u=!0;const r=x(""),a=x(null),{createChat:I,sendMessage:A,getMyChatList:Q,openChat:j,onGetChatMessage:P,changeRobotPrompt:W,$reset:G}=c,{messageList:v,sendLock:$,myChatList:D,robot:R,dialogue_id:d}=Ee(c),T=ue(),M=x(!1),i=async()=>{if(!r.value)return Ne("请输入消息内容");let h=await Ve({robot_key:R.value.robot_key,openid:R.value.openid,question:r.value,form_ids:R.value.form_ids,dialogue_id:d.value});if(h.data&&h.data.words)return Ue.error(`提交的内容包含敏感词：[${h.data.words.join(";")}] 请修改后再提交`);u=!0,A({message:r.value,global:JSON.stringify(b)}),r.value=""},B=async()=>{u=!0,r.value="";let h=T.query||{},F=_.user_id,Y={robot_key:h.robot_key,avatar:h.avatar,name:h.name,nickname:h.nickname,is_background:1,openid:F,dialogue_id:0};ce(),await I(Y)},z=async h=>{if(d.value==h.dialogue_id)return;u=!0;let Y={robot_key:(T.query||{}).robot_key,avatar:h.avatar,name:h.name,nickname:h.nickname,is_background:h.is_background,openid:h.openid,dialogue_id:h.id};ce(),await j(Y),await P()&&ie()},n=h=>{u=!0,A({message:h})};x(!1);const C=()=>{ie()},V=async()=>{u=!1;let h=v.value[0].uid;await P()&&$e(h)},se=()=>{},ie=()=>{a.value&&u&&a.value.scrollToBottom()},$e=h=>{a.value&&a.value.scrollToMessage(h)},ce=()=>{a.value&&a.value.resetScroll()},we=()=>{Q()},re=x(null),qe=h=>{re.value.open(h)},_e=x(null),Se=(h,F)=>{_e.value.open(h,F)};return ge(()=>v.value,()=>{}),Oe(async()=>{B(),Q(),await f(b.id),M.value=!0,k.on("updateAiMessage",C)}),Re(()=>{G(),k.off("updateAiMessage",C)}),(h,F)=>{const Y=Be("router-link"),oe=Ge,Ce=Ke,xe=He;return t(),s("div",ao,[e("div",io,[e("div",co,[l(Ce,null,{default:m(()=>[l(oe,null,{default:m(()=>[l(Y,{to:"/robot/list"},{default:m(()=>[L("机器人管理")]),_:1})]),_:1}),l(oe,null,{default:m(()=>[L(g(w(R).robot_name),1)]),_:1})]),_:1})])]),e("div",ro,[e("div",_o,[e("div",uo,[l(xe,{type:"primary",block:"",ghost:"",onClick:B},{default:m(()=>[l(w(Ye)),L(" 新建对话")]),_:1})]),e("div",po,[l(Yt,{list:w(D),active:w(d),onOpenChat:z,onOnScrollEnd:we},null,8,["list","active"])]),mo]),e("div",go,[e("div",vo,[l(zt,{ref_key:"messageListRef",ref:a,messages:w(v),robotInfo:w(S),onClickMsgMeun:n,onScrollStart:V,onScrollEnd:se,onOpenPromptLog:qe,onOpenLibrary:Se},null,8,["messages","robotInfo"])]),e("div",ho,[l(ls,{value:r.value,"onUpdate:value":F[0]||(F[0]=Te=>r.value=Te),onSend:i,loading:w($)},null,8,["value","loading"])])]),e("div",null,[y("",!0)])]),l(Bs,{ref_key:"promptLogAlertRef",ref:re},null,512),l(no,{ref_key:"libraryInfoAlertRef",ref:_e},null,512)])}}},nn=N(fo,[["__scopeId","data-v-7257bb7b"]]);export{nn as default};
