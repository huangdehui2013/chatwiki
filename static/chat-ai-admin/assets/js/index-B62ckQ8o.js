import{f as ve,e as S,B as Q,w as Z,x as te,M as p,N as d,F as V,k as i,l as he,u as D,S as y,Y as B,W as e,Q as P,a7 as H,a0 as J,a6 as ie,Z as O,a1 as re,a2 as ce,aa as fe,X as ge,U as ye,aq as ke,K as de,a9 as ne,D as be}from"./vue-chunks-DKljrDvA.js";import{B as xe,d as ae,k as le,dF as $e,b as Y,az as Se,de as Le,by as X,aA as we,aC as Ae,dG as Ce,bB as Me,dH as Re,$ as Ie,bG as Ne,bD as qe,bE as Ue}from"../../index-BYXP5-K6.js";import{c as _e}from"./index-C4xOveJ8.js";import{M as Be}from"./model-select-BWeN9_sj.js";import{S as Oe}from"./SettingOutlined-D-jF4FGv.js";import"./index-BNZqkHuq.js";import{_ as Te,R as ze}from"./RadioButton-D6KxmP_c.js";import{Q as G}from"./QuestionCircleOutlined-DYrN9KdY.js";import{S as Ee,a as Fe,i as Ke}from"./index-ChLzCBr1.js";import{_ as je}from"./index-h0nX1Hl6.js";import{_ as De}from"./TextArea-Dnm7usWJ.js";import{_ as me}from"./index-C9HKvTtP.js";import{_ as Ve}from"./index-BxWh-K8x.js";import{_ as Pe}from"./index-BqCGSIDE.js";import{_ as He}from"./index-CSLFuo_b.js";import{M as Je}from"./index-BMSQkwth.js";import"./index-CcC8Vz_q.js";import{I as Ge}from"./Input-Bfzy8tJK.js";import{u as Qe}from"./useEventBus-BwH2zX88.js";import{C as Ye,_ as We}from"./index-CkWGTpL1.js";import{I as Xe}from"./index-N_6xAUTV.js";import"./axios-BZ84_VUH.js";import"./qs-DB0tj3pA.js";import"./crypto-js-fJpLWOEv.js";import"./dayjs-BpZi_McX.js";import"./index-ifJinQLe.js";import"./FormItemContext-BbeLgxF6.js";import"./Checkbox-DoUvt9dJ.js";import"./Trigger-DAizGHX4.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./index-DxTO0j69.js";import"./slide-C8pAsQDb.js";import"./index-2d7y8GiQ.js";import"./CheckOutlined-tNTNjiBd.js";import"./DownOutlined-BfzuAtqc.js";import"./SearchOutlined-BAHqMa3J.js";import"./move-BNsvENtF.js";import"./inputProps-B3PFVydJ.js";import"./colors-BsGfXzR0.js";import"./UpOutlined-D0s-TDxk.js";import"./Search-1aGcXLAr.js";import"./isPlainObject-BRAWLrZZ.js";import"./Password-CPQYqxS0.js";import"./index-Did3xK-p.js";import"./css-DbBMd65r.js";import"./LeftOutlined-Dpm3sl41.js";import"./RightOutlined-D_XHCIbp.js";const T=_=>(re("data-v-7fb4822d"),_=_(),ce(),_),Ze={class:"prompt-form"},et=T(()=>e("div",{class:"prompt-form-label"},"模型设置",-1)),tt={class:"prompt-form-item"},at=T(()=>e("div",{class:"prompt-form-item-label"},[e("span",{style:{color:"red"}},"* "),e("span",null,"模型选择")],-1)),st={class:"prompt-form-item"},ot=T(()=>e("div",{class:"prompt-form-item-label"},[e("span",{style:{color:"red"}},"* "),e("span",null,"提示词")],-1)),nt={class:"prompt-form-item-content"},lt={key:0,class:"prompt-form-item-tip"},it={class:"prompt-form-item"},rt={class:"prompt-form-item-label"},ct=T(()=>e("span",null,"温度",-1)),dt={class:"form-item-body"},_t={class:"number-box"},mt={class:"number-slider-box"},ut={class:"number-input-box"},pt={class:"prompt-form-item"},vt={class:"prompt-form-item-label"},ht=T(()=>e("span",null,"最大token",-1)),ft=T(()=>e("div",null,"问题+答案的最大token数，如果出现回答被截断，可调高此值",-1)),gt={class:"form-item-body"},yt={class:"number-box"},kt={class:"number-slider-box"},bt={class:"number-input-box"},xt={class:"recall-settings-box"},$t={class:"form-box prompt-form"},St=T(()=>e("div",{class:"prompt-form-label"},"召回设置",-1)),Lt={class:"form-item is-required"},wt=T(()=>e("div",{class:"form-item-label"},[e("span",null,"检索模式")],-1)),At={class:"form-item-body"},Ct={class:"retrieval-mode-items"},Mt=["onClick"],Rt={class:"retrieval-mode-title"},It={class:"title-text"},Nt={class:"retrieval-mode-desc"},qt={class:"form-item"},Ut={class:"form-item-label"},Bt=T(()=>e("span",null,"Top K ",-1)),Ot={class:"form-item-body"},Tt={class:"number-box"},zt={class:"number-slider-box"},Et={class:"number-input-box"},Ft={key:0,class:"form-item"},Kt={class:"form-item-label"},jt=T(()=>e("span",null,"相似度阈值 ",-1)),Dt={class:"form-item-body"},Vt={class:"number-box"},Pt={class:"number-slider-box"},Ht={class:"number-input-box"},Jt={class:"form-item"},Gt={class:"form-item-label"},Qt=T(()=>e("span",null,"Rerank模型 ",-1)),Yt={key:0,class:"form-item-body"},Wt=["src"],Xt=ve({__name:"search-drawer",props:{librarySearchData:{type:Object,default:null},defaultLibrarySearchData:{type:Object,default:null}},setup(_){const l=_,w=S([{iconName:"mix-icon",title:"混合检索",value:1,isRecommendation:!0,desc:"同时执行三种检索模式，使用RRF算法进行排序，从三种查询结果中选择更匹配用户问题的结果。混合检索兼顾语义相似性与逻辑关联性，通过互补优势提升检索的准确性和生成结果的可信度"},{iconName:"vector-icon",title:"向量检索",value:2,desc:"将用户提问转成向量之后与知识库分段匹配相似度，返回相似度高的结果。向量检索擅长语义相似性匹配和大规模非结构化数据处理，但缺乏可解释性和精准关系验证"},{iconName:"graph-icon",title:"知识图谱检索",value:4,desc:"通过关系推理，检索出与用户问题相关联的知识。知识图谱检索擅长精准的实体关系推理和逻辑验证，但对非结构化文本和语义模糊查询支持较弱"},{iconName:"search-check-icon",title:"全文检索",value:3,desc:"通过分词匹配文档中的词汇，返回包含这些词汇的文本片段"}]),N=S(!1),t=Q({use_model:"",model_config_id:"",prompt_type:"0",prompt:"",temperature:.5,max_token:2e3,context_pair:0,search_type:1,top_k:5,size:0,similarity:.4,rerank_status:0,rerank_use_model:void 0,rerank_model_config_id:void 0}),I=S([]),A=()=>{_e({model_type:"RERANK"}).then(s=>{let a=s.data||[];I.value=a.map(M=>({id:M.model_config.id,name:M.model_info.model_name,icon:M.model_info.model_icon_url,children:M.model_info.rerank_model_list}))})},L=(s,a)=>{t.use_model=a.modelName,t.model_config_id=a.modelId,b()},z=S([]),j=s=>{var a,M,q,F,K;if(z.value=s,!((a=l.librarySearchData)!=null&&a.model_config_id)||!((M=l.librarySearchData)!=null&&M.use_model)){if(z.value.length>0){let n=z.value[0];if(n){let u=n.children[0];t.use_model=u.name,t.model_config_id=u.model_config_id}}}else t.use_model=((q=l.librarySearchData)==null?void 0:q.use_model)+"$$",t.model_config_id=((F=l.librarySearchData)==null?void 0:F.model_config_id)+"$$",t.use_model=t.use_model.split("$$")[0],t.model_config_id=(K=l.librarySearchData)==null?void 0:K.model_config_id.split("$$")[0]},k=s=>{t.search_type=s,b()},r=(s,a)=>{t.rerank_model_config_id=a.rerank_model_config_id,b()},m=s=>{let a={...s};a.max_token=parseFloat(a.max_token),a.temperature=parseFloat(a.temperature),a.context_pair=parseFloat(a.context_pair),a.search_type=parseFloat(a.search_type),a.rerank_status=parseFloat(a.rerank_status),a.similarity=parseFloat(a.similarity),a.top_k=parseFloat(a.size),a.rerank_use_model===""&&(a.rerank_use_model=void 0),Object.keys(a).forEach(M=>{t[M]=a[M]})},b=()=>{let s={...t};if(!s.prompt&&t.prompt_type=="1")return le.error("请输入自定义提示词");(t.search_type==3||t.search_type==4)&&delete s.similarity,t.prompt_type=="0"&&delete s.prompt,s.size=s.top_k,$e(s).then(a=>{le.success("保存成功")})},h=s=>{},v=()=>{N.value=!0};return Z(()=>l.librarySearchData,s=>{var a;(a=l.librarySearchData)!=null&&a.id&&m({...fe(l.librarySearchData)})}),te(()=>{A()}),(s,a)=>{const M=xe,q=ze,F=Te,K=De,n=me,u=Ve,x=Pe,f=ae,R=He,$=Fe,c=Ke,C=Ee,U=je;return d(),p(V,null,[i(M,{onClick:v,icon:he(D(Oe))},{default:y(()=>[B("搜索设置")]),_:1},8,["icon"]),i(U,{open:N.value,"onUpdate:open":a[14]||(a[14]=o=>N.value=o),class:"custom-class","root-class-name":"root-class-name",title:"搜索设置",width:"472",placement:"right",onAfterOpenChange:h},{default:y(()=>[e("div",Ze,[et,e("div",tt,[at,i(Be,{modelType:"LLM",modeName:t.use_model,"onUpdate:modeName":a[0]||(a[0]=o=>t.use_model=o),modeId:t.model_config_id,"onUpdate:modeId":a[1]||(a[1]=o=>t.model_config_id=o),style:{width:"100%"},onLoaded:j,onChange:L},null,8,["modeName","modeId"])]),e("div",st,[ot,i(F,{value:t.prompt_type,"onUpdate:value":a[2]||(a[2]=o=>t.prompt_type=o),onChange:b},{default:y(()=>[i(q,{value:"0"},{default:y(()=>[B("默认提示词")]),_:1}),i(q,{value:"1"},{default:y(()=>[B("自定义提示词")]),_:1})]),_:1},8,["value"]),e("div",nt,[t.prompt_type=="0"?(d(),p("div",lt,"将提交的内容进行智能总结,不要随意发挥")):(d(),P(K,{key:1,onBlur:b,maxLength:500,style:{height:"80px"},value:t.prompt,"onUpdate:value":a[3]||(a[3]=o=>t.prompt=o),placeholder:"请输入自定义提示词"},null,8,["value"]))])]),e("div",it,[e("div",rt,[ct,i(n,null,{title:y(()=>[B("温度越低，回答越严谨。温度越高，回答越发散。")]),default:y(()=>[i(D(G),{class:"question-icon"})]),_:1})]),e("div",dt,[e("div",_t,[e("div",mt,[i(u,{onBlur:b,class:"custom-slider",value:t.temperature,"onUpdate:value":a[4]||(a[4]=o=>t.temperature=o),min:0,max:2,step:.1},null,8,["value"])]),e("div",ut,[i(x,{onBlur:b,value:t.temperature,"onUpdate:value":a[5]||(a[5]=o=>t.temperature=o),min:0,max:2,step:.1},null,8,["value"])])])])]),e("div",pt,[e("div",vt,[ht,i(n,null,{title:y(()=>[ft]),default:y(()=>[i(D(G),{class:"question-icon"})]),_:1})]),e("div",gt,[e("div",yt,[e("div",kt,[i(u,{onBlur:b,class:"custom-slider",value:t.max_token,"onUpdate:value":a[6]||(a[6]=o=>t.max_token=o),min:0,max:100*1024},null,8,["value"])]),e("div",bt,[i(x,{onBlur:b,value:t.max_token,"onUpdate:value":a[7]||(a[7]=o=>t.max_token=o),min:0,max:100*1024},null,8,["value"])])])])])]),e("div",xt,[e("div",$t,[St,e("div",Lt,[wt,e("div",At,[e("div",Ct,[(d(!0),p(V,null,J(w.value,o=>(d(),p("div",{class:ie(["retrieval-mode-item",{active:t.search_type==o.value}]),key:o.value,onClick:E=>k(o.value)},[t.search_type==o.value?(d(),P(f,{key:0,class:"check-arrow",name:"check-arrow-filled"})):H("",!0),e("div",Rt,[i(f,{name:o.iconName,class:"title-icon"},null,8,["name"]),e("span",It,O(o.title),1),o.isRecommendation?(d(),P(f,{key:0,class:"recommendation-icon",name:"recommendation"})):H("",!0)]),e("div",Nt,O(o.desc),1)],10,Mt))),128))])])]),e("div",qt,[e("div",Ut,[Bt,i(n,null,{title:y(()=>[B("最多从知识库中召回分段数，最低为1，最高为10。召回分段数越多，消耗的token也会越多。")]),default:y(()=>[i(D(G),{class:"question-icon"})]),_:1})]),e("div",Ot,[e("div",Tt,[e("div",zt,[i(u,{onBlur:b,class:"custom-slider",value:t.top_k,"onUpdate:value":a[8]||(a[8]=o=>t.top_k=o),min:1,max:10},null,8,["value"])]),e("div",Et,[i(x,{onBlur:b,value:t.top_k,"onUpdate:value":a[9]||(a[9]=o=>t.top_k=o),min:1,max:10},null,8,["value"])])])])]),t.search_type!=3&&t.search_type!=4?(d(),p("div",Ft,[e("div",Kt,[jt,i(n,null,{title:y(()=>[B("召回时，只会召回相似度大于阈值的文本分段。取值范围：0~1，阈值越大回答的越准确，建议不超过0.9")]),default:y(()=>[i(D(G),{class:"question-icon"})]),_:1})]),e("div",Dt,[e("div",Vt,[e("div",Pt,[i(u,{onBlur:b,class:"custom-slider",value:t.similarity,"onUpdate:value":a[10]||(a[10]=o=>t.similarity=o),min:0,max:1,step:.01},null,8,["value"])]),e("div",Ht,[i(x,{onBlur:b,value:t.similarity,"onUpdate:value":a[11]||(a[11]=o=>t.similarity=o),min:0,max:1,step:.01},null,8,["value"])])])])])):H("",!0),e("div",Jt,[e("div",Gt,[Qt,i(n,null,{title:y(()=>[B("召回时，只会召回相似度大于阈值的文本分段。取值范围：0~1，阈值越大回答的越准确，建议不超过0.9")]),default:y(()=>[i(D(G),{class:"question-icon"})]),_:1}),i(R,{onChange:b,style:{float:"right"},checkedValue:1,unCheckedValue:0,checked:t.rerank_status,"onUpdate:checked":a[12]||(a[12]=o=>t.rerank_status=o),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),t.rerank_status==1?(d(),p("div",Yt,[i(C,{value:t.rerank_use_model,"onUpdate:value":a[13]||(a[13]=o=>t.rerank_use_model=o),placeholder:"请选择Rerank模型",onChange:r,style:{width:"100%"}},{default:y(()=>[(d(!0),p(V,null,J(I.value,o=>(d(),P(c,{key:o.id},{label:y(()=>[e("span",null,[e("img",{class:"model-icon",src:o.icon,alt:""},null,8,Wt)])]),default:y(()=>[(d(!0),p(V,null,J(o.children,E=>(d(),P($,{value:E,rerank_model_config_id:o.id,key:E},{default:y(()=>[e("span",null,O(E),1)]),_:2},1032,["value","rerank_model_config_id"]))),128))]),_:2},1024))),128))]),_:1},8,["value"])])):H("",!0)])])])]),_:1},8,["open"])],64)}}}),Zt=Y(Xt,[["__scopeId","data-v-7fb4822d"]]),ea={class:"no-data"},ta={class:"no-data-text"},aa={__name:"list-empty",props:{text:{type:String,default:"暂无数据"},size:{type:[Number,String],default:100}},setup(_){const l=_;return(w,N)=>{const t=ae;return d(),p("div",ea,[i(t,{name:"empty-document",style:ge({"font-size":`${l.size}px`,color:"white"})},null,8,["style"]),e("div",ta,[ye(w.$slots,"default",{},()=>[B(O(l.text),1)],!0)])])}}},sa=Y(aa,[["__scopeId","data-v-22b194ba"]]),ee=_=>(re("data-v-f065da1f"),_=_(),ce(),_),oa={class:"search-box-warpper"},na={class:"search-box-content"},la={class:"search-set-box"},ia={key:0,class:"search-content"},ra=ee(()=>e("div",{class:"search-label"},"知识搜索",-1)),ca=ee(()=>e("div",{class:"search-tip"},"快速搜索所选择的知识库中内容",-1)),da={class:"search-input-box"},_a={key:1,class:"search-content search-main"},ma={class:"search-input-box"},ua=ee(()=>e("div",null,[e("p",{style:{color:"#262626","font-size":"16px","font-weight":"600","line-height":"24px"}},"暂无任何内容")],-1)),pa={key:1,class:"search-content-box"},va={class:"search-tip-box"},ha={key:0,class:"tip"},fa={key:1,class:"tip complete"},ga={key:0,class:"container"},ya=ke('<div class="rect-container rect1" data-v-f065da1f><div class="rect" data-v-f065da1f></div></div><div class="rect-container rect2" data-v-f065da1f><div class="rect" data-v-f065da1f></div></div><div class="rect-container rect3" data-v-f065da1f><div class="rect" data-v-f065da1f></div></div>',3),ka=[ya],ba={key:1,class:"intelligent-answer"},xa=["innerHTML"],$a={key:1},Sa={class:"section-box"},La=ee(()=>e("div",{class:"tips"},[e("div",{class:"tips-text"},"以上内容由大模型生成"),e("div",{class:"tips-line"})],-1)),wa={key:0,class:"section-label"},Aa={class:"section-item-nav"},Ca={class:"section-item-nav-left"},Ma=["onClick"],Ra={key:0},Ia={class:"section-item-nav-right"},Na=["innerHTML"],qa={__name:"search-box",props:{librarySearchData:{type:Object,default:null},messageObj:{type:Object,default:null},library_ids:{type:Array,default:()=>[]},isError:{type:Boolean,default:!1}},emits:["search","defaultParmas"],setup(_,{expose:l,emit:w}){const N=w,t=_,I=new Je({html:!0,linkify:!0,typographer:!0}),A=S(""),L=S(""),z=S(!1),j=S(!1),k=S({});Z(()=>t.messageObj.content,()=>{A.value=I.render(t.messageObj.content)}),Z(()=>t.messageObj.error,n=>{n&&X(n)});const r=async()=>{if(!t.library_ids.length)return X("请在左侧的知识库选择项内至少选择一个知识库");if(!L.value)return X("请输入消息内容");N("search",L.value),z.value=!0};function m(n){return n.match(/^-?\d+(?:\.\d{0,2})?/)[0]}const b=(n,u)=>{if(!n||!u.trim())return n;const x=u.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),f=new RegExp(`(${x})`,"gi");return n.replace(f,'<span class="highlight">$1</span>')},h=n=>{if(!n.file_name){window.open(`#/library/details/categary-manage?id=${n.library_id}`);return}window.open(`#/library/preview?id=${n.file_id}`)},v=S(t.librarySearchData),s=Q({rerank_status:"",rerank_use_model:"",prompt:"",model_config_id:"",use_model:"",temperature:.5,max_token:2e3,similarity:.4,search_type:1}),a=S({}),M=n=>{v.value=n;let u={model_config_id:n.model_config_id||s.model_config_id,use_model:n.use_model||s.use_model,temperature:n.temperature||s.temperature,max_token:n.max_token||s.max_token,size:200,similarity:n.similarity||s.similarity,search_type:n.search_type||s.search_type,question:L.value,id:t.library_ids.join(","),recall_type:1};n.rerank_status&&(u.rerank_status=n.rerank_status),n.rerank_use_model&&(u.rerank_use_model=n.rerank_use_model),n.prompt&&(u.prompt=n.prompt),n.rerank_status==1&&(u.rerank_model_config_id=n.rerank_model_config_id),j.value=!0,a.value=Object.assign(u),N("defaultParmas",a.value),Le(u).then(x=>{k.value=x.data}).catch(()=>{}).finally(()=>{j.value=!1})},q=S([]);function F(n,u,x){const f=new Set(n.map(R=>R.model_define));return u.filter(R=>{let $=R[x];f.has($)&&n.filter(c=>{if(c.model_define==$)return c.children=we(c.children,R.children),!1})}),n}const K=async()=>{await _e({model_type:"LLM"}).then(n=>{let u=n.data||[],x=[];q.value=u.map(f=>{x=[];for(let R=0;R<f.model_info.llm_model_list.length;R++){const $=f.model_info.llm_model_list[R];x.push({name:$,deployment_name:f.model_config.deployment_name,model_config_id:f.model_config.id,model_define:f.model_info.model_define})}return{model_config_id:f.model_config.id,name:f.model_info.model_name,model_define:f.model_info.model_define,icon:f.model_info.model_icon_url,children:x,deployment_name:f.model_config.deployment_name}}),q.value=F(Se(q.value,"model_define"),q.value,"model_define")})};return te(async()=>{var n,u,x,f,R;if(await K(),!((n=v.value)!=null&&n.model_config_id)||!((u=v.value)!=null&&u.use_model)){if(q.value.length>0){let $=q.value[0];if($){let c=$.children[0];s.use_model=c.name,s.model_config_id=c.model_config_id}}}else s.use_model=((x=v.value)==null?void 0:x.use_model)+"$$",s.model_config_id=((f=v.value)==null?void 0:f.model_config_id)+"$$",s.use_model=s.use_model.split("$$")[0],s.model_config_id=(R=v.value)==null?void 0:R.model_config_id.split("$$")[0]}),l({handleRecallTest:M}),(n,u)=>{const x=ae,f=Ge,R=me;return d(),p("div",oa,[e("div",na,[e("div",la,[i(Zt,{librarySearchData:v.value},null,8,["librarySearchData"])]),z.value?(d(),p("div",_a,[e("div",ma,[i(f,{class:"search-input",onPressEnter:r,value:L.value,"onUpdate:value":u[1]||(u[1]=$=>L.value=$),"allow-clear":"",placeholder:"输入关键词搜索"},{suffix:y(()=>[e("div",{class:"search-icon-box",onClick:r},[i(x,{class:"search-icon",name:"search-right"})])]),_:1},8,["value"])]),!A.value&&_.messageObj.finish&&!k.value.length?(d(),P(sa,{key:0,style:{"margin-top":"100px"},size:"250"},{default:y(()=>[ua]),_:1})):(d(),p("div",pa,[e("div",va,[i(x,{class:"nav-icon",name:"search-tip"}),_.messageObj.finish?(d(),p("span",fa,"智能回答生成完毕")):(d(),p("span",ha,"智能回答生成中..."))]),!_.messageObj.content&&!_.messageObj.finish&&!_.isError?(d(),p("div",ga,ka)):(d(),p("div",ba,[A.value?(d(),p("div",{key:0,innerHTML:A.value},null,8,xa)):(d(),p("div",$a,"暂无任何内容"))])),e("div",Sa,[La,k.value.length?(d(),p("div",wa,[B("相关分段 "),e("div",null,"("+O(k.value.length)+")",1)])):H("",!0),(d(!0),p(V,null,J(k.value,$=>(d(),p("div",{class:"section-item",key:$.id},[e("div",Aa,[e("div",Ca,[i(x,{class:"section-item-icon",name:"document"}),e("div",{class:"section-item-label",onClick:c=>h($)},[B(O($.file_name),1),$.file_name?H("",!0):(d(),p("span",Ra,O($.library_name)+"-精选",1))],8,Ma)]),e("div",Ia,"相似度："+O(m($.similarity)),1)]),i(R,{overlayClassName:"search-content-tip",placement:"top"},{title:y(()=>[B(O($.content),1)]),default:y(()=>[e("div",{class:"section-item-content",innerHTML:b($.content,L.value)},null,8,Na)]),_:2},1024)]))),128))])]))])):(d(),p("div",ia,[ra,ca,e("div",da,[i(f,{class:"search-input",onPressEnter:r,value:L.value,"onUpdate:value":u[0]||(u[0]=$=>L.value=$),"allow-clear":"",placeholder:"输入关键词搜索"},{suffix:y(()=>[e("div",{class:"search-icon-box",onClick:r},[i(x,{class:"search-icon",name:"search-right"})])]),_:1},8,["value"])])]))])])}}},Ua=Y(qa,[["__scopeId","data-v-f065da1f"]]),Ba={class:"cu-tabs"},Oa=["onClick"],Ta={__name:"contain-tabs",props:{value:{type:[Number,String],required:!0},tabs:{type:Array,required:!0,default:()=>[]}},emits:["update:value","change"],setup(_,{emit:l}){const w=l,N=_,t=I=>{w("update:value",I),w("change",I)};return(I,A)=>(d(),p("div",Ba,[(d(!0),p(V,null,J(_.tabs,L=>(d(),p("div",{class:ie(["tab-item",{active:N.value===L.value}]),onClick:z=>t(L.value),key:L.value},O(L.title),11,Oa))),128))]))}},za=Y(Ta,[["__scopeId","data-v-9397dcbb"]]),Ea=de("searchStore",{state:()=>({indeterminate:!1,checkAll:!1,checkedList:[],activeKey:"all"}),getters:{getIndeterminate(){return this.indeterminate},getCheckAll(){return this.checkAll},getCheckedList(){return this.checkedList},getActiveKey(){return this.activeKey}},actions:{setIndeterminate(_){this.indeterminate=_},setCheckAll(_){this.checkAll=_},setCheckedList(_){this.checkedList=_},setActiveKey(_){this.activeKey=_}},persist:{enabled:!0,strategies:[{key:"searchStore",storage:localStorage,paths:["indeterminate","checkAll","checkedList","activeKey"]}]}}),Fa=de("search-lirary",()=>{const _=Qe(),l=Q({reasoning_content:"",show_reasoning:!1,content:"",quote_file:[],id:"",finish:!1,debug:[],error:[],recall_time:0,request_time:0,loading:!1});let w=null;const N=S(0),t=S(""),I=Q({context_pair:"",create_time:"",id:"",max_token:"",model_config_id:"",rerank_model_config_id:"",rerank_status:"",rerank_use_model:"",search_type:"",similarity:"",size:"",temperature:"",update_time:"",use_model:"",user_id:""}),A=(k,r)=>{if(k=="reasoning_content"){let m=l.reasoning_content||"";l.reasoning_content=m+r,l.show_reasoning=!0}if(k=="sending"){let m=l.content||"";l.content=m+r}if(k=="quote_file"&&(l.quote_file=r.length>0?r:[]),k=="ai_message"){if(r.menu_json&&r.msg_type==2){let m=JSON.parse(r.menu_json);l.question=m.question}l.id=r.id,l.content=r.content,r.quote_file&&typeof r.quote_file=="string"&&(l.quote_file=JSON.parse(r.quote_file))}k=="finish"&&(l.finish=!0),k=="debug"&&(l.debug=r.length>0?r:[]),k=="error"&&(l.error=r.length>0?r:[]),k=="recall_time"&&(l.recall_time=r||0),k=="request_time"&&(l.request_time=r||0),_.emit("updateAiMessage",l)},L=()=>{l.loading=!1};return{searchFormState:I,dialogue_id:N,openid:t,messageObj:l,getLibrarySearchFn:async()=>{w&&(w.abort(),w=null);const k=await Re();try{let r=k.data;Object.assign(I,{...r})}catch(r){Promise.reject(r)}return k},searchMessage:(k,r,m)=>{Ae(32),l.content="",l.finish=!1;let b={model_config_id:m.model_config_id,use_model:m.use_model,temperature:m.temperature,max_token:m.max_token,size:m.size,similarity:m.similarity,search_type:m.search_type,question:k,id:r.join(","),recall_type:1};m.rerank_status&&(b.rerank_status=m.rerank_status),m.rerank_use_model&&(b.rerank_use_model=m.rerank_use_model),m.prompt&&(b.prompt=m.prompt),m.rerank_status==1&&(b.rerank_model_config_id=m.rerank_model_config_id),w=Ce(b),w.onMessage=h=>{if(h.event!=="sending"&&Me(h),h.event=="dialogue_id"&&(N.value=h.data),h.event=="reasoning_content"&&A("reasoning_content",h.data),h.event=="sending"&&A("sending",h.data),h.event=="ai_message"){let v=JSON.parse(h.data);A("ai_message",v)}if(h.event=="quote_file"){let v=JSON.parse(h.data);A("quote_file",v)}if(h.event=="finish"&&A("finish",h.data),h.event=="debug"){let v=JSON.parse(h.data);A("debug",v)}if(h.event=="error"){let v=h.data;A("error",v)}if(h.event=="recall_time"){let v=h.data;A("recall_time",v)}},w.onClose=()=>{L(),w=null}}}}),Ka={class:"chat-monitor-page"},ja={class:"page-left"},Da={class:"toolbar-box"},Va={class:"library-checkbox-box"},Pa={class:"app-list-box"},Ha={class:"list-box",ref:"scrollContainer"},Ja={class:"list-item"},Ga={class:"list-item-box"},Qa={class:"library-icon"},Ya=["onClick"],Wa={class:"page-body"},Xa={__name:"index",setup(_){const l=Ea();let{getIndeterminate:w,getCheckAll:N,getCheckedList:t,getActiveKey:I}=ne(l);const A=Fa(),{getLibrarySearchFn:L,searchMessage:z}=A,{messageObj:j}=ne(A),k=S(null),r=S(null),m=S("all"),b=S([{title:"全部",value:"all"},{title:"普通",value:"0"},{title:"问答",value:"2"}]),h=S({}),v=S([]),s=Q({indeterminate:!1,checkAll:!1,checkedList:[]}),a=c=>{h.value=c},M=S(!1),q=async c=>{var U;M.value=!1;let C=await L();if(r.value=C.data,r.value.id||(r.value=Object.assign(h.value)),!r.value.model_config_id||!r.value.use_model)return M.value=!0,X("请在搜索设置中配置好相应配置后再使用");(U=k.value)==null||U.handleRecallTest(r.value),z(c,s.checkedList,r.value)},F=c=>{Object.assign(s,{checkedList:c.target.checked?v.value.map(C=>C.id):[],indeterminate:!!s.checkedList.length&&s.checkedList.length<v.value.length}),l.setCheckedList(s.checkedList),l.setIndeterminate(s.indeterminate)},K=c=>{l.setCheckedList(c)},n=c=>{window.open(`#/library/details/knowledge-document?id=${c}`)};Z(()=>s.checkedList,c=>{s.indeterminate=!!c.length&&c.length<v.value.length,s.checkAll=c.length>=v.value.length,l.setIndeterminate(s.indeterminate),l.setCheckAll(s.checkAll)});const u=()=>{v.value.forEach(c=>{c.type==0,c.type==2}),b.value=[{title:"全部",value:"all"},{title:"普通",value:"0"},{title:"问答",value:"2"}]},x=(c,C)=>{if(C.length===0)return!1;const U=new Set(c);return C.every(o=>U.has(o))},f=(c,C)=>!C.some(U=>c.includes(U)),R=async()=>{let c=m.value==="all"?"":m.value;await Ie({type:c}).then(C=>{var E;let U=C.data||[];U.forEach(g=>{g.file_size_str=Ne(g.file_size),g.avatar||(g.avatar=g.type==0?qe:Ue)}),v.value=U;const o=v.value.map(g=>g.id);if((E=t.value)!=null&&E.length&&(o!=null&&o.length)){const g=t.value,W=o,ue=x(g,W),pe=f(g,W),se=g.length>=W.length&&ue,oe={checkAll:se,indeterminate:!se&&!pe};l.$patch(oe),Object.assign(s,oe)}else{const g={checkAll:!1,indeterminate:!1};l.$patch(g),Object.assign(s,g)}s.checkedList=t.value,s.indeterminate=w.value,!N.value&&t.value.length==0&&!w.value&&I.value=="all"&&(l.setCheckAll(!0),s.checkedList=o,l.setCheckedList(o)),m.value==="all"&&u()})},$=c=>{l.setActiveKey(c),R()};return te(async()=>{I.value&&(m.value=I.value),await R();let c=await L();r.value=c.data}),be(()=>{}),(c,C)=>{const U=Ye,o=Xe,E=We;return d(),p("div",Ka,[e("div",ja,[e("div",Da,[i(za,{tabs:b.value,value:m.value,"onUpdate:value":C[0]||(C[0]=g=>m.value=g),onChange:$},null,8,["tabs","value"])]),e("div",Va,[e("div",Pa,[i(U,{checked:s.checkAll,"onUpdate:checked":C[1]||(C[1]=g=>s.checkAll=g),indeterminate:s.indeterminate,onChange:F},{default:y(()=>[B(" 全选/取消 ")]),_:1},8,["checked","indeterminate"])]),i(E,{value:s.checkedList,"onUpdate:value":C[2]||(C[2]=g=>s.checkedList=g),onChange:K},{default:y(()=>[e("div",Ha,[(d(!0),p(V,null,J(v.value,g=>(d(),p("div",{class:"list-item-wraapper",key:g.id},[e("div",Ja,[i(U,{value:g.id},null,8,["value"]),e("div",Ga,[e("div",Qa,[i(o,{preview:!1,width:32,src:g.avatar},null,8,["src"])]),e("div",{class:"library-name",onClick:W=>n(g.id)},O(g.library_name),9,Ya)])])]))),128))],512)]),_:1},8,["value"])])]),e("div",Wa,[i(Ua,{ref_key:"searchBoxRef",ref:k,onDefaultParmas:a,onSearch:q,isError:M.value,messageObj:D(j),librarySearchData:r.value,library_ids:s.checkedList},null,8,["isError","messageObj","librarySearchData","library_ids"])])])}}},Gs=Y(Xa,[["__scopeId","data-v-1cd61309"]]);export{Gs as default};
