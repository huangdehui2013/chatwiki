import{e as v,B as te,x as W,w as Q,M as c,N as d,W as e,k as f,S as $,F as R,$ as z,u as F,Q as se,Y as M,Z as I,ai as oe,a6 as xe,G,a1 as P,a2 as V,a7 as O,z as ee,a4 as De,a5 as we,a9 as Ce,D as Ee}from"./vue-chunks-DkYK5AuX.js";import{a as x}from"./dayjs-CHX5mXCJ.js";import{k as Ie,b as N,B as Le,M as He}from"../../index-CuFzRDH0.js";import{a as Me,_ as Be}from"./RadioButton-ouyuU7LQ.js";import{R as Oe}from"./dayjs-DS70I3cJ.js";import{_ as ae}from"./empty-DkpCLaix.js";import{_ as Re}from"./useIM-CoYYaSHO.js";import{S as Ae}from"./index-YK7vZYdC.js";import{u as Ue}from"./robot-Cmbvv6Dq.js";import{u as qe}from"./chat-DJ0u2jbU.js";import{c as ze}from"./index-CGn0qoG1.js";import{_ as Pe}from"./index-Bvd8KCz1.js";import{S as Ve,_ as Ne}from"./index-B9b8kVtF.js";import{_ as Ye}from"./Search-BjDfM7wD.js";import{_ as je}from"./index-B3CceHui.js";import"./axios-Cm0UX6qg.js";import"./qs-g-qVsYXK.js";import"./crypto-js-CsNcoEfj.js";import"./FormItemContext-CG4o3aCY.js";import"./Checkbox-CHV8yuJS.js";import"./index-DtO8wbUi.js";import"./index-_b6N6Mhe.js";import"./colors-TmzmwKXv.js";import"./CheckOutlined-Nu5wJEo2.js";import"./Trigger-qqJEyN1K.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./shallowequal-CCVEH32S.js";import"./index-DpON8wvi.js";import"./move-CfeIRdjT.js";import"./slide--PTaLm6c.js";import"./index-CNYsll_x.js";import"./index-BKVIlkU8.js";import"./index-aParrWES.js";import"./useEventBus-BruxLnOi.js";import"./DownOutlined-xHwfZhzl.js";import"./SearchOutlined-2-sBVYkv.js";import"./Input-DlD3j6GW.js";import"./inputProps-CIG3Q6HA.js";import"./isPlainObject-B3m2dvNk.js";const Fe={class:"zm-date"},Ge={class:"date-btn"},We={class:"date-content"},Qe={__name:"date",props:{datekey:{type:String,default:"1"}},emits:["dateChange"],setup(r,{emit:C}){const D=r,i=v(1),u=C;let S=te([{label:"今日",value:!0,key:2,start_time:x().startOf("day"),end_time:x().endOf("day")},{label:"昨日",value:!1,key:3,start_time:x().subtract(1,"day").startOf("day"),end_time:x().startOf("day").subtract(1,"millisecond")},{label:"近7日",value:!1,key:4,start_time:x().subtract(6,"day").startOf("day"),end_time:x().endOf("day").subtract(1,"millisecond")}]);const p=v(null),a=v(null),s=v([]),h=m=>m>=x().subtract(0,"day"),E=()=>{let m=i.value,t=null;S.forEach(g=>{g.key==m&&(t=g)}),t&&(s.value=[t.start_time,t.end_time],p.value=t.start_time.unix(),a.value=t.end_time.unix()),H()},L=m=>{const t=x(m[0]).startOf("day");if(x(m[1]).endOf("day").diff(t,"days")>29)s.value[0]=m[0].startOf("day"),s.value[1]=t.add(29,"days").endOf("day"),p.value=s.value[0].unix(),a.value=s.value[1].unix(),Ie.error("最多只能选择30天");else{const b=x(m[0]).startOf("day").unix(),l=x(m[1]).endOf("day").unix();s.value=m,p.value=b,a.value=l}i.value=1,H()},H=()=>{u("dateChange",{start_time:p.value,end_time:a.value})};return W(()=>{i.value=parseInt(D.datekey),E()}),Q(()=>D.datekey,(m,t)=>{i.value=parseInt(D.datekey.split("-")[0]),E()}),(m,t)=>{const g=Me,b=Be,l=Oe;return c(),d("div",Fe,[e("div",Ge,[f(b,{value:i.value,"onUpdate:value":t[0]||(t[0]=_=>i.value=_),onChange:E},{default:$(()=>[(c(!0),d(R,null,z(F(S),_=>(c(),se(g,{class:"date-btn-button",value:_.key,key:_.key},{default:$(()=>[M(I(_.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),e("div",We,[f(l,{value:s.value,"onUpdate:value":t[1]||(t[1]=_=>s.value=_),onChange:L,format:"YYYY-MM-DD",disabledDate:h,allowClear:!1},null,8,["value"])])])}}},Z=r=>(P("data-v-5eff2794"),r=r(),V(),r),Ze={key:0,class:"empty-box"},Je=Z(()=>e("img",{src:ae,alt:""},null,-1)),Ke=Z(()=>e("div",{class:"title"},"暂无结果，请重试",-1)),Xe=[Je,Ke],et=["onClick"],tt={class:"user-item-left"},st=["src"],ot={class:"user-item-right"},at={class:"user-name-box"},lt={class:"user-name"},nt={class:"user-timer"},rt={class:"user-info"},ct={class:"user-source-box"},it=Z(()=>e("div",{class:"user-source-title"},"来自：",-1)),ut={class:"user-source-content"},dt={__name:"user",props:{userList:{type:Array,default:[]}},emits:["userClick","userScroll","userScrollStart","userScrollEnd"],setup(r,{emit:C}){const D=v(null),i=r,u=C,S=v([]),p=v({}),a=t=>{p.value=t,u("userClick",t)},s={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let h=null;function E(t){h&&(clearTimeout(h),h=null),h=setTimeout(()=>{s.scrollTop-t.target.scrollTop>0&&(s.scrollDirection="up"),s.scrollTop-t.target.scrollTop<0&&(s.scrollDirection="down"),s.scrollTop=t.target.scrollTop,s.scrollHeight=t.target.scrollHeight,s.clientHeight=t.target.clientHeight,u("userScroll",{...s}),Math.abs(s.scrollTop)<=s.scrollStartDiff+100&&s.scrollDirection==="up"&&L(),Math.abs(s.scrollHeight-s.scrollTop-s.clientHeight)<=s.scrollEndDiff&&s.scrollDirection==="down"&&H()},50)}function L(){i.userList.length!=0&&u("userScrollStart",{msg:i.userList[0]})}function H(){i.userList.length!=0&&u("userScrollEnd",{msg:i.userList[i.userList.length-1]})}Q(()=>i.userList,t=>{S.value=t,S.value.length>0&&S.value.length<=20&&(a(S.value[0]),p.value=S.value[0])},{immediate:!0});const m=t=>{let g;switch(t){case"yun_h5":g="WebAPP";break;case"yun_pc":g="嵌入网站";break}return g};return W(()=>{S.value=i.userList}),(t,g)=>{const b=oe("ftime");return c(),d("div",{class:"user-content",ref_key:"scrollUserBoxRef",ref:D,onScroll:E},[S.value.length===0?(c(),d("div",Ze,Xe)):(c(!0),d(R,{key:1},z(S.value,l=>(c(),d("div",{class:xe(["user-item",{active:l.openid==p.value.openid}]),onClick:_=>a(l),key:l.session_id},[e("div",tt,[e("img",{class:"user-img",src:l.avatar,alt:""},null,8,st)]),e("div",ot,[e("div",at,[e("div",lt,I(l.name),1),G((c(),d("div",nt,[M(I(l.last_chat_time),1)])),[[b,"MM-DD HH:mm"]])]),e("div",rt,I(l.last_chat_message),1),e("div",ct,[it,e("div",ut,I(m(l.app_type)),1)])])],10,et))),128))],544)}}},_t=N(dt,[["__scopeId","data-v-5eff2794"]]),le=r=>(P("data-v-6cb95dd7"),r=r(),V(),r),pt={class:"message-box"},mt={class:"message-top-box"},ft={class:"message-top-title"},vt={key:0,class:"message-top-source"},gt={class:"message-list"},ht={key:0,class:"empty-box"},yt=le(()=>e("img",{src:ae,alt:""},null,-1)),St=le(()=>e("div",{class:"title"},"暂无结果，请重试",-1)),bt=[yt,St],kt=["id"],Tt={class:"itme-right"},$t={class:"item-body"},xt={class:"message-content"},Dt={class:"user-avatar-box"},wt=["src"],Ct=["id"],Et={class:"itme-left"},It=["src"],Lt={class:"itme-right"},Ht={class:"item-body"},Mt={key:0,class:"message-content"},Bt=["innerHTML"],Ot={key:2,class:"message-content"},Rt=["src"],At={key:2,class:"loading-box"},Ut={__name:"message-list",props:{messages:{type:Array,default:()=>[]},robotInfo:{type:Object,default:()=>{}},isEmpty:{type:Boolean,default:()=>!1},sessionSource:{type:String,default:()=>null},channelItem:{type:Array,default:()=>[]}},emits:["scroll","scrollStart","scrollEnd"],setup(r,{expose:C,emit:D}){const i=D,u=r,S=v(!1),p=v(null),a={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let s=null,h=!1;const E=l=>{let _;for(let o=0;o<u.channelItem.length;o++){const k=u.channelItem[o];k.app_type===l&&(_=k.app_name)}return _};function L(l){h||(s&&(clearTimeout(s),s=null),s=setTimeout(()=>{a.scrollTop-l.target.scrollTop>0&&(a.scrollDirection="up"),a.scrollTop-l.target.scrollTop<0&&(a.scrollDirection="down"),a.scrollTop=l.target.scrollTop,a.scrollHeight=l.target.scrollHeight,a.clientHeight=l.target.clientHeight,i("scroll",{...a}),Math.abs(a.scrollTop)<=a.scrollStartDiff&&a.scrollDirection==="up"&&H(),Math.abs(a.scrollHeight-a.scrollTop-a.clientHeight)<=a.scrollEndDiff&&a.scrollDirection==="down"&&m()},100))}function H(){u.messages.length!=0&&i("scrollStart",{msg:u.messages[0]})}function m(){u.messages.length!=0&&i("scrollEnd",{msg:u.messages[u.messages.length-1]})}const t=()=>{p.value&&ee(()=>{h=!0,p.value.scrollTop=p.value.scrollHeight+1,setTimeout(()=>{a.scrollTop=p.value.scrollTop,h=!1},50)})};function g(l,_){ee(()=>{h=!0,_||(_="top");let o=p.value,k=document.querySelector("#msg-"+l);k&&(_=="top"?o.scrollTop=k.offsetTop:o.scrollTop=k.offsetTop-o.clientHeight+k.clientHeight),setTimeout(()=>{a.scrollTop=p.value.scrollTop,h=!1},50)})}function b(){a.scrollTop=0,a.scrollDirection=""}return C({scrollToBottom:t,scrollToMessage:g,resetScroll:b}),(l,_)=>{const o=Ae,k=oe("viewer");return c(),d("div",pt,[e("div",mt,[e("div",ft,I(u.robotInfo.robot_name),1),r.sessionSource?(c(),d("div",vt,"("+I(E(r.sessionSource))+")",1)):O("",!0)]),e("div",{class:"message-list-wrapper",ref_key:"scrollBoxRef",ref:p,onScroll:L},[e("div",gt,[u.isEmpty||!u.messages?(c(),d("div",ht,bt)):(c(!0),d(R,{key:1},z(u.messages,y=>(c(),d(R,{key:y.uid},[y.is_customer==1?(c(),d("div",{key:0,class:"message-item user-message",id:"msg-"+y.uid},[e("div",Tt,[e("div",$t,[e("div",xt,I(y.content),1)])]),e("div",Dt,[e("img",{class:"user-avatar",src:y.avatar},null,8,wt)])],8,kt)):(c(),d("div",{key:1,class:"message-item robot-message",id:"msg-"+y.uid},[e("div",Et,[f(o,{size:"small",spinning:y.loading},{default:$(()=>[e("img",{class:"robot-avatar",src:y.robot_avatar},null,8,It)]),_:2},1032,["spinning"])]),e("div",Lt,[e("div",Ht,[y.msg_type==1?G((c(),d("div",Mt,[f(Re,{content:y.content},null,8,["content"])])),[[k]]):O("",!0),y.msg_type==2?(c(),d("div",{key:1,class:"message-content",innerHTML:y.menu_json.content},null,8,Bt)):O("",!0),y.msg_type==3?(c(),d("div",Ot,[G(e("img",{class:"msg-img",src:y.content,alt:""},null,8,Rt),[[k]])])):O("",!0)])])],8,Ct))],64))),128)),S.value?(c(),d("div",At,[f(o)])):O("",!0)])],544)])}}},qt=N(Ut,[["__scopeId","data-v-6cb95dd7"]]),ne=r=>(P("data-v-9f69c2d1"),r=r(),V(),r),zt={class:"team-members-pages"},Pt={class:"set-model"},Vt=ne(()=>e("div",{class:"label set-model-label"},"渠道：",-1)),Nt={class:"set-model-body"},Yt={class:"set-date"},jt=ne(()=>e("div",{class:"label set-date-label"},[e("span",null,"日期：")],-1)),Ft={class:"set-date-body"},Gt={class:"set-name"},Wt={class:"set-reset"},Qt={class:"list-box"},Zt={class:"user-box"},Jt={class:"records-box"},Kt={__name:"session-record",setup(r){const C=v(!1),D=De(),i=we(),u=i.query,S=Ue(),{robotInfo:p}=S,a=qe(),{messageList:s}=Ce(a);let h=!0;const{createMsg:E,onGetChatMessage:L,getRecordList:H,getChannelList:m}=a,t=v(null),g=v([]),b=v([]),l=v(""),_=v("1"),o=te({robot_id:u.id,app_type:"all",app_id:"",start_time:"",end_time:"",name:"",page:1,size:20}),k=v(!1),y=n=>{o.start_time=n.start_time,o.end_time=n.end_time,j()},re=()=>{o.app_type="all",o.name="",o.page=1,_.value="1-"+Math.random()},A=v(!1),Y=v(!1),ce=async()=>{let n=J();Y.value=!0,await ze(n),A.value=!0,Y.value=!1},ie=()=>{D.push({path:"/robot/config/export-record",query:u})},j=()=>{o.page=1,K()},ue=n=>{o.app_type=n,j()},de=()=>{},_e=n=>{l.value=n.app_type,ye(n)},pe=async()=>{},me=()=>{k.value&&(o.page++,K())},fe=async()=>{h=!1;let n=s.value[0].uid;await L()&&ge(n)},ve=()=>{t.value&&h&&t.value.scrollToBottom()},ge=n=>{t.value&&t.value.scrollToMessage(n)},he=()=>{t.value&&t.value.resetScroll()};let U=null;const ye=async n=>{h=!0;let B={robot_key:(i.query||{}).robot_key,avatar:n.avatar,name:n.name,nickname:n.name,is_background:1,openid:n.openid};he(),await E(B),U&&(clearTimeout(U),U=null),U=setTimeout(async()=>{await L()&&ve()},100)},Se=async()=>{const n=await m();g.value=[{app_type:"all",app_name:"全部渠道"},...n.data]},J=()=>{let n={robot_id:o.robot_id,start_time:o.start_time,end_time:o.end_time,name:o.name,page:o.page,size:o.size};return o.app_type!=="all"&&(n.app_type=o.app_type),n},K=async()=>{let n=J(),T=await H(n),B=T.data.list||[];o.page==1&&(b.value=[]),b.value=[...b.value,...B],C.value=b.value.length==0,k.value=T.data.has_more};return Q(()=>s.value,()=>{}),W(async()=>{Se()}),Ee(()=>{}),(n,T)=>{const B=Ve,X=Ne,be=Ye,q=Le,ke=je,Te=Pe,$e=He;return c(),d("div",zt,[f(ke,{justify:"flex-start",class:"screen-box"},{default:$(()=>[e("div",Pt,[Vt,e("div",Nt,[f(X,{value:o.app_type,"onUpdate:value":T[0]||(T[0]=w=>o.app_type=w),placeholder:"全部渠道",onChange:ue,style:{width:"200px"}},{default:$(()=>[(c(!0),d(R,null,z(g.value,w=>(c(),se(B,{key:w.app_type,value:w.app_type},{default:$(()=>[e("span",null,I(w.app_name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])])]),e("div",Yt,[jt,e("div",Ft,[f(Qe,{onDateChange:y,datekey:_.value},null,8,["datekey"])])]),e("div",Gt,[f(be,{value:o.name,"onUpdate:value":T[1]||(T[1]=w=>o.name=w),placeholder:"请输入用户名称搜索",style:{width:"200px"},onSearch:j},null,8,["value"])]),e("div",Wt,[f(q,{onClick:re},{default:$(()=>[M("重置")]),_:1}),f(q,{onClick:ce,loading:Y.value},{default:$(()=>[M("导出")]),_:1},8,["loading"])])]),_:1}),e("div",Qt,[e("div",Zt,[f(_t,{userList:b.value,onUserScrollStart:pe,onUserScrollEnd:me,onUserClick:_e},null,8,["userList"])]),e("div",Jt,[f(qt,{ref_key:"messageListRef",ref:t,isEmpty:C.value,messages:F(s),robotInfo:F(p),channelItem:g.value,sessionSource:l.value,onScrollStart:fe,onScrollEnd:de},null,8,["isEmpty","messages","robotInfo","channelItem","sessionSource"])])]),f($e,{open:A.value,"onUpdate:open":T[3]||(T[3]=w=>A.value=w),title:null,footer:null,width:640},{default:$(()=>[f(Te,{status:"success",title:"导出任务创建成功","sub-title":"系统会在后台导出。导出数据量越大，耗时越久。您可以稍后点击导出记录查看并下载导出的文件。"},{extra:$(()=>[f(q,{style:{"margin-right":"16px"},onClick:T[2]||(T[2]=w=>A.value=!1)},{default:$(()=>[M("知道了")]),_:1}),f(q,{onClick:ie,type:"primary"},{default:$(()=>[M("去下载")]),_:1})]),_:1})]),_:1},8,["open"])])}}},Xt=N(Kt,[["__scopeId","data-v-9f69c2d1"]]),es=r=>(P("data-v-705cfb21"),r=r(),V(),r),ts={class:"user-model-page"},ss=es(()=>e("div",{class:"page-title"},"会话记录",-1)),os={class:"list-wrapper"},as={__name:"index",setup(r){return(C,D)=>(c(),d("div",ts,[ss,e("div",os,[f(Xt)])]))}},Ys=N(as,[["__scopeId","data-v-705cfb21"]]);export{Ys as default};
