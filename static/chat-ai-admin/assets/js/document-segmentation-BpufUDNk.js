import{a5 as ie,a4 as le,e as _,b as se,a8 as _e,M as f,N as x,k as i,a7 as j,W as r,S as d,u as re,Z as A,Q as ce,F as J,$ as ue,Y as T,a1 as me,a2 as de}from"./vue-chunks-Dpmhapcm.js";import{S as pe,D as fe,E as he,a as ve}from"./edit-fragment-alert-BEytwYtp.js";import{b as ge,e as ke,f as be,s as ye}from"./index-CQKu1YIs.js";import{b as Se,M as D,E as $,k as W}from"../../index-DJqZYlN8.js";import{B as qe,_ as xe}from"./index-D_fZWlYm.js";import{S as we}from"./index-2EWY1GCt.js";import{L as Fe}from"./LeftOutlined-BBd11KLM.js";import"./empty-BtQ55gr9.js";import"./index-BW4jDb4d.js";import"./shallowequal-KOHJRfiy.js";import"./Trigger-DcF6kXOl.js";import"./collapseMotion-DmHD1G9F.js";import"./slide-B4S8cqER.js";import"./index-Bn-6W96d.js";import"./index-BY-bgrX3.js";import"./colors-CZV0Zir8.js";import"./Dropdown-DicWDWIK.js";import"./useRefs-CxyIWkWE.js";import"./pick-BQKw5Ek5.js";import"./index-BearFCS_.js";import"./isPlainObject--mHlhHEN.js";import"./responsiveObserve-D_TTA_LO.js";import"./QuestionCircleOutlined-D2lOE5qu.js";import"./FormItemContext-DcHP2mNJ.js";import"./index-DT9vq-9c.js";import"./statusUtils-Bnl8Rf7N.js";import"./CheckOutlined-D8sWUycq.js";import"./DownOutlined-D5t3juQ7.js";import"./SearchOutlined-C4P1S4P5.js";import"./move-B1-eDBNJ.js";import"./PlusOutlined-CTNlEK-E.js";import"./model-select-BawuzGA8.js";import"./index-Cd8_BaNA.js";import"./index-Bpgeg3Jc.js";import"./index-9XFVXge0.js";import"./Input-k3gxptQd.js";import"./inputProps-B4Qz7YgH.js";import"./index-DGofXs4a.js";import"./Search-CxIvru6q.js";import"./TextArea-DEZsPG5C.js";import"./Password-DASsPHld.js";import"./index-Ci9XZtrG.js";import"./UpOutlined-BLzSJSuk.js";import"./index-DfSExCBV.js";import"./index-DXiWv6EO.js";import"./index-O15OSOpm.js";import"./partition-DekNjavo.js";import"./index-DzhuYAPB.js";import"./axios-Cm0UX6qg.js";import"./qs--NVn7pjl.js";import"./crypto-js-DjHh3pn1.js";import"./dayjs-BAOQ3IvD.js";import"./dropdown-CmzzPYoT.js";import"./RightOutlined-CJJrtf85.js";const Y=h=>(me("data-v-db741eb5"),h=h(),de(),h),Ee={key:0,class:"loading-wrap"},Le={class:"document-segmentation"},Te={class:"breadcrumb-block"},De={class:"page-title"},Ie=Y(()=>r("span",{class:"title"},"文档分段与清洗",-1)),Ne={class:"page-container"},ze={class:"page-left"},Be={class:"page-right"},Ce={class:"document-fragment-preview"},Oe={class:"preview-header"},Re=Y(()=>r("span",{class:"label-text"},"分段预览",-1)),Ve={class:"fragment-number"},Me={__name:"document-segmentation",setup(h){const I=ie(),w=le(),{document_id:v}=I.query,g=_(!0),F=_(1);let p=!1,a={id:v,separators_no:"",chunk_size:512,chunk_overlap:50,is_qa_doc:0,question_lable:"",similar_label:"",answer_lable:"",enable_extract_image:!0},N=!1;const E=_(null),Z=e=>{typeof e.separators_no=="object"&&(e.separators_no=e.separators_no.join(",")),N=!0,a={...a,...e},p?D.confirm({title:"提醒",icon:i($),content:"文档片段已被编辑重新获取文档片段会丢失当前修改过的文档片段内容，确定要重新获取吗？",okText:"确定",okType:"danger",cancelText:"取消",onOk(){p=!1,S()},onCancel(){}}):(p=!1,S())};let G=60*10,z=0,B=null;const k=_({}),b=_(0),C=()=>{g.value||(g.value=!0),ge({id:v}).then(async e=>{const{status:t}=e.data;if(b.value=e.data.library_type,k.value=e.data,a={...a,separators_no:e.data.separators_no||"11,12",chunk_size:+e.data.chunk_size||512,chunk_overlap:+e.data.chunk_overlap||50,is_qa_doc:b.value==2?1:0,question_lable:e.data.question_lable,similar_label:e.data.similar_label,answer_lable:e.data.answer_lable,question_column:e.data.question_column,similar_column:e.data.similar_column,answer_column:e.data.answer_column,enable_extract_image:e.data.enable_extract_image=="true",qa_index_type:+e.data.qa_index_type,chunk_type:+e.data.chunk_type,semantic_chunk_size:+e.data.semantic_chunk_size||512,semantic_chunk_overlap:+e.data.semantic_chunk_overlap||50,semantic_chunk_threshold:+e.data.semantic_chunk_threshold||90,semantic_chunk_use_model:e.data.semantic_chunk_use_model||"",semantic_chunk_model_config_id:e.data.semantic_chunk_model_config_id>0?e.data.semantic_chunk_model_config_id:""},e.data.chunk_type==0&&(a={...a,separators_no:e.data.normal_chunk_default_separators_no,chunk_size:e.data.normal_chunk_default_chunk_size,chunk_overlap:e.data.normal_chunk_default_chunk_overlap,chunk_type:+e.data.default_chunk_type,semantic_chunk_size:+e.data.semantic_chunk_default_chunk_size,semantic_chunk_overlap:+e.data.semantic_chunk_default_chunk_overlap,semantic_chunk_threshold:+e.data.semantic_chunk_default_threshold,semantic_chunk_use_model:e.data.default_use_model||"",semantic_chunk_model_config_id:e.data.default_model_config_id>0?e.data.default_model_config_id:""}),t==0){if(z++,z>G){D.error({title:"提醒",content:"文档解析速度慢请稍后再试"});return}setTimeout(()=>{C()},1e3)}else t==4||t==2?(g.value=!1,F.value=parseInt(e.data.is_table_file),B=e.data.library_id,b.value==2?(a.question_lable||a.question_column)&&S():S()):w.replace("/library/details?id="+e.data.library_id);e.data.is_table_file==1&&H()})};C();const O=_([]),H=()=>{ke({id:v}).then(e=>{let t=[];for(let n in e.data)t.push({lable:e.data[n],value:n});O.value=t})},o=_([]),y=_(0),K=se(()=>y.value<=0),S=()=>be({...a,semantic_chunk_model_config_id:a.semantic_chunk_model_config_id?+a.semantic_chunk_model_config_id:0}).then(e=>{o.value=e.data.list||[],y.value=e.data.list.length||0}).finally(()=>{E.value.reLoading=!1}),R=_(null);let l=null;const P=(e,t)=>{let{title:n,content:c,question:u,answer:m,images:s,similar_question_list:q}=e;l=t,R.value.open({title:n,content:c,question:u,answer:m,images:s,similar_question_list:q})},U=({title:e,content:t,question:n,answer:c,images:u,similar_question_list:m})=>{(o.value[l].title!=e||o.value[l].content!=t||o.value[l].question!=n||o.value[l].answer!=c)&&(p=!0),o.value[l].title=e,o.value[l].content=t,o.value[l].question=n,o.value[l].answer=c,o.value[l].images=u,o.value[l].similar_question_list=m?m.split(`
`):[],o.value[l].word_total=c.length+n.length+t.length},X=e=>{D.confirm({title:"提醒",icon:i($),content:"确定要删除这个片段吗?",okText:"确定",okType:"danger",cancelText:"取消",onOk(){p=!0,o.value.splice(e,1)},onCancel(){}})},L=_(""),ee=e=>{L.value=e},V=_(!1),te=()=>{let e=E.value.formState;e=JSON.parse(JSON.stringify(e)),typeof e.separators_no=="object"&&(e.separators_no=e.separators_no.join(",")),a={...a,...e}},ae=async()=>{if(te(),L.value)return W.error(L.value);let e={...a,semantic_chunk_model_config_id:a.semantic_chunk_model_config_id?+a.semantic_chunk_model_config_id:0,is_table_file:F.value};delete e.id;let t={id:v,word_total:y.value,split_params:JSON.stringify(e),list:JSON.stringify(o.value)};e.is_qa_doc==1&&(t.qa_index_type=e.qa_index_type),V.value=!0,ye(t).then(()=>{if(W.success("保存成功"),I.query.source=="preview"&&!N){Q();return}w.replace("/library/details?id="+B)}).finally(()=>{V.value=!1}).catch(n=>{n.data&&n.data.index&&ne(n.data.index)})},M=_(null),ne=e=>{e=e-1;let t=M.value.querySelectorAll(".fragment-item");t.length>=e&&t[e].scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},Q=()=>{w.back()};return(e,t)=>{const n=we,c=_e("router-link"),u=xe,m=qe;return f(),x(J,null,[g.value?(f(),x("div",Ee,[i(n)])):j("",!0),r("div",Le,[r("div",Te,[i(m,null,{default:d(()=>[i(u,null,{default:d(()=>[i(c,{to:"/library/list"},{default:d(()=>[T(" 知识库管理 ")]),_:1})]),_:1}),i(u,null,{default:d(()=>[i(c,{to:{path:"/library/details/knowledge-document",query:{id:k.value.library_id}}},{default:d(()=>[T(A(k.value.library_name)+"知识库",1)]),_:1},8,["to"])]),_:1}),i(u,null,{default:d(()=>[T("分段设置")]),_:1})]),_:1})]),r("div",De,[i(re(Fe),{onClick:Q}),Ie]),r("div",Ne,[r("div",ze,[i(pe,{excellQaLists:O.value,libFileInfo:k.value,library_type:b.value,mode:F.value,ref_key:"segmentationSettingRef",ref:E,onChange:Z,onSave:ae,onValidate:ee},null,8,["excellQaLists","libFileInfo","library_type","mode"])]),r("div",Be,[r("div",Ce,[r("div",Oe,[Re,r("span",Ve,"共"+A(y.value)+"个分段",1)]),K.value?(f(),ce(ve,{key:0})):j("",!0),r("div",{class:"preview-box",ref_key:"previewBoxRef",ref:M},[(f(!0),x(J,null,ue(o.value,(s,q)=>(f(),x("div",{class:"fragment-item",key:s.number},[i(fe,{number:s.number,title:s.title,content:s.content,total:s.word_total,question:s.question,answer:s.answer,images:s.images,similar_question_list:s.similar_question_list,onDelete:oe=>X(q),onEdit:oe=>P(s,q)},null,8,["number","title","content","total","question","answer","images","similar_question_list","onDelete","onEdit"])]))),128))],512)])])]),i(he,{ref_key:"editFragmentAlertRef",ref:R,onOk:U},null,512)])],64)}}},Qt=Se(Me,[["__scopeId","data-v-db741eb5"]]);export{Qt as default};
