import{K as ce,M as n,N as r,k as w,X as le,W as i,U as X,Y as H,Z as p,a9 as P,e as S,w as Z,z as j,x as ee,D as te,u as L,Q as O,F as x,$ as I,a6 as U,a7 as R,a1 as E,a2 as V,S as N,I as se,aa as Q,a4 as re,ai as de,G as ue}from"./vue-chunks-DWnFCQSz.js";import{u as oe}from"./useEventBus-92uAASzv.js";import{g as _e}from"./index-PjC8bJD0.js";import{ce as W,f as he,cY as G,a1 as K,b as B,d as Y,b5 as pe}from"../../index-UhR4yadr.js";import{u as me,_ as ve}from"./useIM-BGgBsupF.js";import{B as A,M as fe,S as ge,P as ye}from"./pull-up.esm-JZ91zQ8P.js";import{O as be}from"./observe-dom.esm-DPKTicVt.js";import{S as Le}from"./index-BWhNhRp3.js";import{a as ke}from"./index-B_tcday3.js";import{_ as Se}from"./index-DqpDz6dy.js";import{_ as Te,S as $e}from"./index-9VXz7HRC.js";import"./axios-Cm0UX6qg.js";import"./qs-De-rn6vz.js";import"./crypto-js-U6t3rvpm.js";import"./dayjs-BI1HIvBC.js";import"./index-bg5oFZUg.js";import"./index-DzhuYAPB.js";import"./Trigger-DcWVD-r5.js";import"./statusUtils--roYFmJe.js";import"./slide-BR5NTmcW.js";import"./index-DXeZ5ybK.js";import"./CheckOutlined-B_iCQ6FL.js";import"./DownOutlined-CvDOGKH1.js";import"./SearchOutlined-bV5WeZB5.js";import"./FormItemContext-BJa1evck.js";import"./move-cWZng2f8.js";const Ce=(o={})=>W.get({url:"/manage/getReceiverList",params:o}),we=(o={})=>W.post({url:"/chat/message",data:o}),Re=(o={})=>W.post({url:"/manage/setReceiverRead",data:o}),F=ce("chatMonitor",{state:()=>({im:null,selectedRobotId:"",robotList:[],selectedReceiverId:"",receiverList:[],receiverListPage:{page:0,size:10},activeChat:null,chatMessagePageSize:10,messageList:[],messageListScrollTop:0,chatMessageLoadCompleted:!1,messageListLoading:!1}),getters:{},actions:{async init(){this.selectedRobotId="",this.selectedReceiverId="",this.robotList=[],this.receiverList=[],this.messageList=[],this.receiverListPage={page:0,size:10},this.messageListScrollTop=0,this.chatMessageLoadCompleted=!1,this.messageListLoading=!1,this.activeChat=null,await this.getRobotList(),await this.getReceiverList(),this.receiverList.length>0&&await this.switchChat(this.receiverList[0]),this.initIM()},closeIM(){this.im&&this.im.close()},initIM(){const o=me(),s=he();this.im=o,o.connect(s.user_id),o.on("message",e=>{!e.data||e.msg_type!=="receiver_notify"||((e.change=="create"||e.change=="update")&&this.onAddReceiver(e),e.change=="delete"&&this.onDeleteReceiver(e),(e.change=="c_message"||e.change=="ai_message")&&this.onAddMessage(e))})},onAddMessage(o){if(!this.activeChat)return;const s=oe();let e=o.data;this.activeChat.session_id==e.session_id&&(e.displayName=e.name||e.nickname,e.dispayTime=G(e.create_time),e.uid=K(32),e.loading=!1,e.menu_json&&typeof e.menu_json=="string"&&(e.menu_json=JSON.parse(e.menu_json)),e.quote_file&&typeof e.quote_file=="string"&&(e.quote_file=JSON.parse(e.quote_file)),this.messageList.push(e),s.emit("onAddMessage",e))},onAddReceiver(o){let s=o.data;s.displayName=s.name||s.nickname,s.come_from=JSON.parse(s.come_from);let e=this.receiverList.find(c=>c.session_id==s.session_id);e?Object.assign(e,s):(this.selectedRobotId==""||this.selectedRobotId==s.robot_id)&&this.receiverList.unshift(s)},onDeleteReceiver(o){let s=o.data,e=this.receiverList.findIndex(c=>c.id==s);e!=-1&&(this.activeChat&&this.activeChat.id==s&&(this.activeChat=null),this.receiverList.splice(e,1))},async getRobotList(o){return _e(o).then(s=>(this.robotList=s.data||[],s))},async getReceiverList(){return this.receiverListPage.page++,Ce({...this.receiverListPage,robot_id:this.selectedRobotId}).then(o=>{let s=o.data.list||[];for(let e=0;e<s.length;e++)s[e].displayName=s[e].name||s[e].nickname,s[e].come_from&&(s[e].come_from=JSON.parse(s[e].come_from));return this.receiverListPage.page==1?this.receiverList=s:this.receiverList=this.receiverList.concat(s),o})},changeRobot(){this.activeChat=null,this.resetReceiverList()},resetReceiverList(){return this.receiverListPage.page=0,this.receiverList=[],this.getReceiverList()},async getChatMessage(){if(this.messageListLoading)return;this.messageListLoading=!0;let o=0,s=this.messageList.filter(c=>!c.isWelcome);s.length>0&&(o=s[0].id);let e={robot_key:this.activeChat.robot_key,openid:this.activeChat.openid,min_id:o,size:this.chatMessagePageSize};return we(e).then(c=>{var g,_;this.messageListLoading=!1;let t=c.data.list||[];const d=((g=c==null?void 0:c.data)==null?void 0:g.customer)||{},m=((_=c==null?void 0:c.data)==null?void 0:_.robot)||{};t.sort((a,v)=>a.id-v.id);for(let a=0;a<t.length;a++)t[a].displayName=t[a].name||t[a].nickname,t[a].is_customer==1?(t[a].displayName=t[a].displayName||d.name,t[a].avatar=t[a].avatar||d.avatar):(t[a].displayName=t[a].displayName||m.robot_name,t[a].avatar=t[a].avatar||m.robot_avatar),t[a].uid=K(32),t[a].menu_json&&typeof t[a].menu_json=="string"&&(t[a].menu_json=JSON.parse(t[a].menu_json)),t[a].quote_file&&typeof t[a].menu_json=="string"&&(t[a].quote_file=JSON.parse(t[a].quote_file)),t[a].dispayTime=G(t[a].create_time);return this.messageList=[...t,...this.messageList],t.length<this.chatMessagePageSize&&(this.chatMessageLoadCompleted=!0),c}).catch(c=>{this.messageListLoading=!1})},claerUnread(){return Re({id:this.selectedReceiverId})},async switchChat(o){this.chatMessageLoadCompleted=!1,this.messageListLoading=!1,this.messageList=[],this.messageListScrollTop=0,this.selectedReceiverId=o.id,this.activeChat=o,this.claerUnread(),await this.getChatMessage()}}}),Me={class:"no-data"},xe={class:"no-data-text"},Ie={__name:"list-empty",props:{text:{type:String,default:"暂无数据"},size:{type:[Number,String],default:100}},setup(o){const s=o;return(e,c)=>{const t=Y;return n(),r("div",Me,[w(t,{name:"empty",style:le({"font-size":`${s.size}px`})},null,8,["style"]),i("div",xe,[X(e.$slots,"default",{},()=>[H(p(s.text),1)],!0)])])}}},ie=B(Ie,[["__scopeId","data-v-35f939c8"]]),Ne=o=>(E("data-v-47e06951"),o=o(),V(),o),Be={key:1,class:"chat-list"},De=["onClick"],Oe={class:"avatar"},qe=["src","alt"],ze={class:"chat-info"},Ae={class:"nickname"},je={class:"last-message"},He={class:"webapp-source"},Ue={key:0,class:"loading-wrapper"},Pe=Ne(()=>i("span",{class:"loading-text"},"加载中...",-1)),Fe={key:1,class:"finished-text"},Je={__name:"chat-list ",emits:["switchChat"],setup(o,{emit:s}){A.use(fe),A.use(ge),A.use(be),A.use(ye);const e=s,c=F(),{getReceiverList:t}=c,{receiverList:d,selectedReceiverId:m}=P(c),g=S(null);let _=null;const a=S(!1),v=S(!1),T=()=>{_=new A(g.value,{scrollY:!0,click:!0,observeDOM:!0,mouseWheel:!0,bounce:!1,scrollbar:{fade:!0,interactive:!0},pullUpLoad:!0}),_.on("pullingUp",()=>{M()})},M=async()=>{if(a.value||v.value){_.finishPullUp();return}a.value=!0;try{(await t()).data.list.length===0&&(v.value=!0)}catch(l){console.error("加载更多数据失败:",l)}finally{a.value=!1,_.finishPullUp()}},f=l=>{e("switchChat",l)};return Z(d,l=>{l.length>0&&j(()=>{_&&_.refresh()})}),ee(()=>{j(()=>{T()})}),te(()=>{_&&_.destroy()}),(l,b)=>{const $=Le;return n(),r("div",{class:"scroll-wrapper",ref_key:"scrollRef",ref:g},[L(d).length==0?(n(),O(ie,{key:0,size:"140",text:"暂无机器人接待中会话"})):(n(),r("div",Be,[(n(!0),r(x,null,I(L(d),y=>(n(),r("div",{key:y.id,class:U(["chat-item",{active:y.id===L(m)}]),onClick:u=>f(y)},[i("div",Oe,[i("img",{src:y.avatar,alt:y.displayName},null,8,qe),y.unread>0?(n(),r("span",{key:0,class:U(["dot",{plus:y.unread>9}])},p(y.unread),3)):R("",!0)]),i("div",ze,[i("div",Ae,p(y.displayName),1),i("div",je,p(y.last_chat_message),1),i("div",He,"来自："+p(y.come_from.app_name),1)])],10,De))),128)),a.value?(n(),r("div",Ue,[w($,{size:"small"}),Pe])):R("",!0),v.value?(n(),r("div",Fe,"没有更多了")):R("",!0)]))],512)}}},Ee=B(Je,[["__scopeId","data-v-47e06951"]]),Ve={__name:"chat-message-scroll",props:{topTriggerDistance:{type:Number,default:10},bottomTriggerDistance:{type:Number,default:40},isLoading:{type:Boolean,default:!1},scrollTop:{type:Number,default:0}},emits:["scroll-top","scroll-bottom","scroll"],setup(o,{expose:s,emit:e}){const c=o,t=e,d=S(null),m=S({scrollTop:0,scrollHeight:0,clientHeight:0,scrollDirection:"down",scrollStartDiff:c.topTriggerDistance,scrollEndDiff:c.bottomTriggerDistance}),g=S(null),_=l=>{const{scrollTop:b}=l,$=m.value.scrollTop-b;m.value.scrollDirection=$>0?"up":"down",Object.assign(m.value,{scrollTop:b,scrollHeight:l.scrollHeight,clientHeight:l.clientHeight})},a=()=>{const{scrollTop:l,scrollHeight:b,clientHeight:$,scrollStartDiff:y,scrollEndDiff:u,scrollDirection:C}=m.value;t("scroll",{...m.value}),c.isLoading||(Math.abs(l)<=y&&C==="up"&&t("scroll-top",{...m.value}),Math.abs(b-l-$)<=u&&C==="down"&&t("scroll-bottom",{...m.value}))},v=l=>{_(l.target),g.value&&(clearTimeout(g.value),g.value=null),g.value=setTimeout(()=>{a()},100)};function T(){d.value&&(d.value.scrollTop=0)}function M(){d.value&&(d.value.scrollTop=d.value.scrollHeight)}function f(){return d.value&&Object.assign(m.value,{scrollTop:d.value.scrollTop,scrollHeight:d.value.scrollHeight,clientHeight:d.value.clientHeight}),JSON.parse(JSON.stringify(m.value))}return Z(()=>c.scrollTop,l=>{d.value&&(d.value.scrollTop=l)}),s({scrollToTop:T,scrollToBottom:M,getState:f}),(l,b)=>(n(),r("div",{class:"chat-message-scroll",ref_key:"scrollContainer",ref:d,onScroll:v},[X(l.$slots,"default",{},void 0,!0)],544))}},We=B(Ve,[["__scopeId","data-v-23d37ca8"]]),ae=o=>(E("data-v-efc0c25f"),o=o(),V(),o),Ye={class:"chat-message-warpper"},Qe={class:"chat-message-content"},Ge={key:0,class:"is-loaded"},Ke={class:"avatar"},Xe=["src","alt"],Ze={class:"message-content"},et={class:"message-info"},tt={class:"nickname"},st=ae(()=>i("i",{class:"gap"},null,-1)),ot={class:"time"},it={class:"message-bubble"},at={key:0,class:"text-content"},nt={key:1},ct={key:1,class:"image-content"},lt=["src"],rt={key:2,class:"menu-content"},dt={class:"menus-label"},ut={key:0,class:"menu-items"},_t=["onClick"],ht={key:3,class:"answer-reference-box"},pt=ae(()=>i("div",{class:"answer-reference-label"},"回答参考",-1)),mt=["onClick"],vt={__name:"chat-message",emits:["openLibrary"],setup(o,{expose:s,emit:e}){const c=e,t=S(null),d=F(),{getChatMessage:m}=d,{messageList:g,messageListScrollTop:_,messageListLoading:a,chatMessageLoadCompleted:v,activeChat:T}=P(d),M=()=>{};function f(C,k,q){let h=Q(C);k.robot_key=T.value.robot_key,k.robot_id=T.value.robot_id,h.forEach(D=>{D.message_id=q.id,D.openid=q.openid,D.robot_key=T.value.robot_key,D.robot_id=T.value.robot_id}),c("openLibrary",h,Q(k))}const l=C=>{const{scrollTop:k}=C;_.value=k},b=async()=>{if(v.value)return;let C=t.value.getState();await m(),j(()=>{let k=t.value.getState();k.scrollDirection=="up"&&(_.value=k.scrollHeight-C.scrollHeight)})},$=async()=>{};return s({scrollToTop:()=>{t.value.scrollToTop()},scrollToBottom:()=>{t.value.scrollToBottom()}}),(C,k)=>{const q=Y;return n(),r("div",Ye,[w(We,{ref_key:"scrollViewRef",ref:t,scrollTop:L(_),"onUpdate:scrollTop":k[0]||(k[0]=h=>se(_)?_.value=h:null),"is-loading":L(a),onScroll:l,onScrollTop:b,onScrollBottom:$},{default:N(()=>[i("div",Qe,[L(v)?(n(),r("div",Ge,"没用更多聊天记录了")):R("",!0),(n(!0),r(x,null,I(L(g),(h,D)=>(n(),r("div",{key:D,class:U(["message-item",h.is_customer==0?"right":""])},[i("div",Ke,[i("img",{src:h.avatar,alt:h.displayName},null,8,Xe)]),i("div",Ze,[i("div",et,[i("span",tt,p(h.displayName),1),st,i("span",ot,p(h.dispayTime),1)]),i("div",it,[h.msg_type==1?(n(),r("div",at,[h.is_customer==0?(n(),O(ve,{key:0,content:h.content},null,8,["content"])):(n(),r("div",nt,p(h.content),1))])):h.msg_type==3?(n(),r("div",ct,[i("img",{src:h.content,alt:"image"},null,8,lt)])):h.msg_type==2?(n(),r("div",rt,[i("div",dt,p(h.menu_json.content),1),h.menu_json.question&&h.menu_json.question.length>0?(n(),r("div",ut,[(n(!0),r(x,null,I(h.menu_json.question,(z,J)=>(n(),r("div",{key:J,class:"menu-item",onClick:ne=>M(z)},p(z),9,_t))),128))])):R("",!0)])):R("",!0),h.quote_file&&h.quote_file.length?(n(),r("div",ht,[pt,i("div",null,[(n(!0),r(x,null,I(h.quote_file,(z,J)=>(n(),r("div",{class:"list-item",key:J},[w(q,{name:"attachment"}),i("span",{onClick:ne=>f(h.quote_file,z,h)},p(z.file_name),9,mt)]))),128))])])):R("",!0)])])],2))),128))])]),_:1},8,["scrollTop","is-loading"])])}}},ft=B(vt,[["__scopeId","data-v-efc0c25f"]]),gt={class:"library-info-content"},yt={class:"file-list"},bt=["onClick"],Lt={class:"document-items"},kt={class:"document-item-header"},St={class:"left-box"},Tt={class:"document-title"},$t={key:0,class:"document-title"},Ct={class:"document-size"},wt={class:"document-item-body"},Rt={class:"document-similarity"},Mt={key:0,class:"document-content"},xt={key:1,class:"document-content"},It={class:"document-content"},Nt={class:"fragment-img"},Bt=["src"],Dt={__name:"library-info-alert",setup(o,{expose:s}){const e=re(),c=S(!1),t=S([]),d=S(null),m=()=>{t.value=[],d.value=null},g=(f,l)=>{m(),t.value=f,d.value=l.id,c.value=!0,v(l)},_=f=>{f.id!=d.value&&(d.value=f.id,v(f))},a=S([]),v=f=>{ke({message_id:f.message_id,file_id:f.id,robot_key:f.robot_key,openid:f.openid}).then(l=>{a.value=l.data||[]})},T=()=>{e.push("/library/preview?id="+d.value)},M=()=>{c.value=!1};return s({open:g}),(f,l)=>{const b=Y,$=Se,y=de("viewer");return n(),O($,{class:"library-info-alert",open:c.value,"onUpdate:open":l[0]||(l[0]=u=>c.value=u),title:"答案来源",placement:"right",width:"746px",closable:!1,bodyStyle:{background:"#F2F4F7"}},{extra:N(()=>[i("span",{class:"close-btn",onClick:M},[w(L(pe))])]),default:N(()=>[i("div",gt,[i("div",yt,[(n(!0),r(x,null,I(t.value,u=>(n(),r("div",{class:U(["file-item",{active:d.value==u.id}]),key:u.id,onClick:C=>_(u)},p(u.file_name),11,bt))),128))]),i("div",Lt,[(n(!0),r(x,null,I(a.value,u=>(n(),r("div",{class:"document-item",key:u.id},[i("div",kt,[i("div",St,[i("span",Tt,"id："+p(u.id),1),u.title?(n(),r("span",$t,p(u.title),1)):R("",!0),i("span",Ct," 共"+p(u.word_total)+"个字符 ",1)]),i("div",{class:"right-box"},[i("a",{onClick:T},"查看源文档>")])]),i("div",wt,[i("div",Rt,[H(" 相似度： "),w(b,{name:"similarity",style:{"font-size":"16px"}}),H(p(u.similarity),1)]),u.question?(n(),r("div",Mt,"Q："+p(u.question),1)):R("",!0),u.answer?(n(),r("div",xt,"A："+p(u.answer),1)):R("",!0),i("div",It,p(u.content),1),ue((n(),r("div",Nt,[(n(!0),r(x,null,I(u.images,(C,k)=>(n(),r("img",{key:k,src:C,alt:""},null,8,Bt))),128))])),[[y]])])]))),128))])])]),_:1},8,["open"])}}},Ot=B(Dt,[["__scopeId","data-v-1eece137"]]),qt={key:0,class:"chat-box-warpper"},zt={class:"chat-box-header"},At={class:"nickname"},jt={class:"chat-source"},Ht={class:"chat-box-content"},Ut={key:1},Pt={__name:"chat-box",setup(o,{expose:s}){const e=F(),{activeChat:c}=P(e),t=S(null),d=()=>{t.value.scrollToBottom()},m=()=>{t.value.scrollToTop()},g=S(null),_=(a,v)=>{g.value.open(a,v)};return s({scrollToTop:m,scrollToBottom:d}),(a,v)=>(n(),r(x,null,[L(c)?(n(),r("div",qt,[i("div",zt,[i("div",At,p(L(c).name||L(c).nickname),1),i("div",jt," 来自："+p(L(c).come_from.robot_name)+" - "+p(L(c).come_from.app_name),1)]),i("div",Ht,[w(ft,{ref_key:"chatMessageRef",ref:t,onOpenLibrary:_},null,512)])])):(n(),r("div",Ut)),w(Ot,{ref_key:"libraryInfoAlertRef",ref:g},null,512)],64))}},Ft=B(Pt,[["__scopeId","data-v-d67bf9eb"]]),Jt=o=>(E("data-v-27c84195"),o=o(),V(),o),Et={class:"chat-monitor-page"},Vt={class:"page-left"},Wt={class:"app-list-box"},Yt={class:"chat-list-wrapper"},Qt={class:"page-body"},Gt=Jt(()=>i("div",null,[i("p",null,"请在左侧列表先选择会话"),i("p",null,"通过本功能，可以实时查看机器人接待中的会话消息，监控机器人回复效果")],-1)),Kt={__name:"index",setup(o){const s=oe(),e=F(),{init:c,changeRobot:t,switchChat:d,closeIM:m}=e,{robotList:g,selectedRobotId:_,activeChat:a}=P(e),v=S(null),T=()=>{t()},M=async l=>{var b;await d(l),(b=v.value)==null||b.scrollToBottom()},f=()=>{j(()=>{var l;(l=v.value)==null||l.scrollToBottom()})};return ee(async()=>{await c(),j(()=>{var l;(l=v.value)==null||l.scrollToBottom()}),s.on("onAddMessage",f)}),te(()=>{s.off("onAddMessage",f),m()}),(l,b)=>{const $=$e,y=Te;return n(),r("div",Et,[i("div",Vt,[i("div",Wt,[w(y,{value:L(_),"onUpdate:value":b[0]||(b[0]=u=>se(_)?_.value=u:null),style:{width:"100%"},onChange:T},{default:N(()=>[w($,{value:""},{default:N(()=>[H("全部应用")]),_:1}),(n(!0),r(x,null,I(L(g),u=>(n(),O($,{value:u.id,key:u.id},{default:N(()=>[i("span",null,p(u.robot_name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),i("div",Yt,[w(Ee,{onSwitchChat:M})])]),i("div",Qt,[L(a)?(n(),O(Ft,{key:0,ref_key:"chatBoxRef",ref:v},null,512)):(n(),O(ie,{key:1,style:{background:"#F2F4F7"},size:"250"},{default:N(()=>[Gt]),_:1}))])])}}},Ts=B(Kt,[["__scopeId","data-v-27c84195"]]);export{Ts as default};
