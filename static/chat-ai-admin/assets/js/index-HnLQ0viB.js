import{f as he,e as w,B as G,w as Z,x as te,M as p,N as c,F as V,k as n,l as ve,u as K,S as y,Y as I,W as t,Q as P,a7 as H,a0 as J,a6 as le,Z as q,a1 as re,a2 as ce,aa as fe,X as ge,U as ye,aq as be,K as de,a9 as ie,D as ke}from"./vue-chunks-Dagx-vSq.js";import{B as xe,d as ae,k as ne,dF as Se,b as Y,aA as $e,bz as X,aB as Le,de as we,aD as Ae,dG as Ce,bC as Oe,dH as Me,a0 as Re,bH as De,bE as Ie,bF as je}from"../../index-BdYv4pbp.js";import{c as _e}from"./index-DulBynFY.js";import{M as Ne}from"./model-select-C7NXQtts.js";import{S as qe}from"./SettingOutlined-CygDtKy4.js";import"./index-TeHk_coF.js";import{_ as Ue,R as Be}from"./RadioButton-CKy5Sstn.js";import{Q}from"./QuestionCircleOutlined-BY31qbwb.js";import{S as Te,a as ze,i as Ee}from"./index-BddIR2yb.js";import{_ as Fe}from"./index-3Np-6sYr.js";import{_ as Ke}from"./TextArea-DRJIYohD.js";import{_ as me}from"./index-CCsePsqL.js";import{_ as Ve}from"./index-D3GNTuSP.js";import{_ as Pe}from"./index-BMih6iRe.js";import{_ as He}from"./index-DdBHG-A3.js";import{M as Je}from"./index-BMSQkwth.js";import"./index-B11WLJj_.js";import{I as Qe}from"./Input-C2qOGQ_1.js";import{u as Ge}from"./useEventBus-BwH2zX88.js";import{C as Ye,_ as We}from"./index-Dzb8yElx.js";import{I as Xe}from"./index-DyGaVDj6.js";import"./axios-BZ84_VUH.js";import"./qs-CSiAN3u4.js";import"./crypto-js-DN0vhd75.js";import"./dayjs-CZ5VaChI.js";import"./index-B6ctIxYh.js";import"./FormItemContext-Cdyd-mYe.js";import"./Checkbox-B2wqz-LK.js";import"./Trigger-DWEODdVI.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./index-ffqjZvit.js";import"./slide-4EGAbcnD.js";import"./index-p3MxSJUT.js";import"./CheckOutlined-Zj7x0G_2.js";import"./DownOutlined-bF62ZcFO.js";import"./SearchOutlined-C-SKizIr.js";import"./move-Du4Gi3iM.js";import"./inputProps-BIa77Hqy.js";import"./colors-CJx9DhIW.js";import"./UpOutlined-DlgZFWNa.js";import"./Search-B65y9BZx.js";import"./isPlainObject-BUQ58MPT.js";import"./Password-D2_IM1Jy.js";import"./index-_xQpb7Ga.js";import"./css-DbBMd65r.js";import"./LeftOutlined-DfhC6gKx.js";import"./RightOutlined-Dc3RESo2.js";const U=_=>(re("data-v-5a852543"),_=_(),ce(),_),Ze={class:"prompt-form"},et=U(()=>t("div",{class:"prompt-form-label"},"模型设置",-1)),tt={class:"prompt-form-item"},at=U(()=>t("div",{class:"prompt-form-item-label"},[t("span",{style:{color:"red"}},"* "),t("span",null,"模型选择")],-1)),st={class:"prompt-form-item"},ot=U(()=>t("div",{class:"prompt-form-item-label"},[t("span",{style:{color:"red"}},"* "),t("span",null,"提示词")],-1)),it={class:"prompt-form-item-content"},nt={key:0,class:"prompt-form-item-tip"},lt={class:"prompt-form-item"},rt={class:"prompt-form-item-label"},ct=U(()=>t("span",null,"温度",-1)),dt={class:"form-item-body"},_t={class:"number-box"},mt={class:"number-slider-box"},ut={class:"number-input-box"},pt={class:"prompt-form-item"},ht={class:"prompt-form-item-label"},vt=U(()=>t("span",null,"最大token",-1)),ft=U(()=>t("div",null,"问题+答案的最大token数，如果出现回答被截断，可调高此值",-1)),gt={class:"form-item-body"},yt={class:"number-box"},bt={class:"number-slider-box"},kt={class:"number-input-box"},xt={class:"recall-settings-box"},St={class:"form-box prompt-form"},$t=U(()=>t("div",{class:"prompt-form-label"},"召回设置",-1)),Lt={class:"form-item is-required"},wt=U(()=>t("div",{class:"form-item-label"},[t("span",null,"检索模式")],-1)),At={class:"form-item-body"},Ct={class:"retrieval-mode-items"},Ot=["onClick"],Mt={class:"retrieval-mode-title"},Rt={class:"title-text"},Dt={class:"retrieval-mode-desc"},It={class:"form-item"},jt={class:"form-item-label"},Nt=U(()=>t("span",null,"Top K ",-1)),qt={class:"form-item-body"},Ut={class:"number-box"},Bt={class:"number-slider-box"},Tt={class:"number-input-box"},zt={key:0,class:"form-item"},Et={class:"form-item-label"},Ft=U(()=>t("span",null,"相似度阈值 ",-1)),Kt={class:"form-item-body"},Vt={class:"number-box"},Pt={class:"number-slider-box"},Ht={class:"number-input-box"},Jt={class:"form-item"},Qt={class:"form-item-label"},Gt=U(()=>t("span",null,"Rerank模型 ",-1)),Yt={key:0,class:"form-item-body"},Wt=["src"],Xt=he({__name:"search-drawer",props:{librarySearchData:{type:Object,default:null},defaultLibrarySearchData:{type:Object,default:null}},setup(_){const o=_,A=w([{iconName:"mix-icon",title:"混合检索",value:1,isRecommendation:!0,desc:"同时执行三种检索模式，使用RRF算法进行排序，从三种查询结果中选择更匹配用户问题的结果。混合检索兼顾语义相似性与逻辑关联性，通过互补优势提升检索的准确性和生成结果的可信度"},{iconName:"vector-icon",title:"向量检索",value:2,desc:"将用户提问转成向量之后与知识库分段匹配相似度，返回相似度高的结果。向量检索擅长语义相似性匹配和大规模非结构化数据处理，但缺乏可解释性和精准关系验证"},{iconName:"graph-icon",title:"知识图谱检索",value:4,desc:"通过关系推理，检索出与用户问题相关联的知识。知识图谱检索擅长精准的实体关系推理和逻辑验证，但对非结构化文本和语义模糊查询支持较弱"},{iconName:"search-check-icon",title:"全文检索",value:3,desc:"通过分词匹配文档中的词汇，返回包含这些词汇的文本片段"}]),D=w(!1),e=G({use_model:"",model_config_id:"",prompt_type:"0",prompt:"",temperature:.5,max_token:2e3,context_pair:0,search_type:1,top_k:5,size:0,similarity:.4,rerank_status:0,rerank_use_model:void 0,rerank_model_config_id:void 0}),R=w([]),C=()=>{_e({model_type:"RERANK"}).then(i=>{let a=i.data||[];R.value=a.map($=>({id:$.model_config.id,name:$.model_info.model_name,icon:$.model_info.model_icon_url,children:$.model_info.rerank_model_list}))})},L=(i,a)=>{e.use_model=a.modelName,e.model_config_id=a.modelId,b()},B=w([]),F=i=>{var a,$,T,E,r;if(B.value=i,!((a=o.librarySearchData)!=null&&a.model_config_id)||!(($=o.librarySearchData)!=null&&$.use_model)){if(B.value.length>0){let v=B.value[0];if(v){let k=v.children[0];e.use_model=k.name,e.model_config_id=k.model_config_id}}}else e.use_model=((T=o.librarySearchData)==null?void 0:T.use_model)+"$$",e.model_config_id=((E=o.librarySearchData)==null?void 0:E.model_config_id)+"$$",e.use_model=e.use_model.split("$$")[0],e.model_config_id=(r=o.librarySearchData)==null?void 0:r.model_config_id.split("$$")[0]},S=i=>{e.search_type=i,b()},l=(i,a)=>{e.rerank_model_config_id=a.rerank_model_config_id,b()},m=i=>{let a={...i};a.max_token=parseFloat(a.max_token),a.temperature=parseFloat(a.temperature),a.context_pair=parseFloat(a.context_pair),a.search_type=parseFloat(a.search_type),a.rerank_status=parseFloat(a.rerank_status),a.similarity=parseFloat(a.similarity),a.top_k=parseFloat(a.size),a.rerank_use_model===""&&(a.rerank_use_model=void 0),Object.keys(a).forEach($=>{e[$]=a[$]})},b=()=>{let i={...e};if(!i.prompt&&e.prompt_type=="1")return ne.error("请输入自定义提示词");(e.search_type==3||e.search_type==4)&&delete i.similarity,e.prompt_type=="0"&&delete i.prompt,i.size=i.top_k,Se(i).then(a=>{ne.success("保存成功")})},h=i=>{},d=()=>{D.value=!0};return Z(()=>o.librarySearchData,i=>{var a;(a=o.librarySearchData)!=null&&a.id&&m({...fe(o.librarySearchData)})}),te(()=>{C()}),(i,a)=>{const $=xe,T=Be,E=Ue,r=Ke,v=me,k=Ve,f=Pe,O=ae,x=He,j=ze,u=Ee,M=Te,N=Fe;return c(),p(V,null,[n($,{onClick:d,icon:ve(K(qe))},{default:y(()=>[I("搜索设置")]),_:1},8,["icon"]),n(N,{open:D.value,"onUpdate:open":a[14]||(a[14]=s=>D.value=s),class:"custom-class","root-class-name":"root-class-name",title:"搜索设置",width:"472",placement:"right",onAfterOpenChange:h},{default:y(()=>[t("div",Ze,[et,t("div",tt,[at,n(Ne,{modelType:"LLM",modeName:e.use_model,"onUpdate:modeName":a[0]||(a[0]=s=>e.use_model=s),modeId:e.model_config_id,"onUpdate:modeId":a[1]||(a[1]=s=>e.model_config_id=s),style:{width:"100%"},onLoaded:F,onChange:L},null,8,["modeName","modeId"])]),t("div",st,[ot,n(E,{value:e.prompt_type,"onUpdate:value":a[2]||(a[2]=s=>e.prompt_type=s),onChange:b},{default:y(()=>[n(T,{value:"0"},{default:y(()=>[I("默认提示词")]),_:1}),n(T,{value:"1"},{default:y(()=>[I("自定义提示词")]),_:1})]),_:1},8,["value"]),t("div",it,[e.prompt_type=="0"?(c(),p("div",nt,"将提交的内容进行智能总结,不要随意发挥")):(c(),P(r,{key:1,onBlur:b,maxLength:500,style:{height:"80px"},value:e.prompt,"onUpdate:value":a[3]||(a[3]=s=>e.prompt=s),placeholder:"请输入自定义提示词"},null,8,["value"]))])]),t("div",lt,[t("div",rt,[ct,n(v,null,{title:y(()=>[I("温度越低，回答越严谨。温度越高，回答越发散。")]),default:y(()=>[n(K(Q),{class:"question-icon"})]),_:1})]),t("div",dt,[t("div",_t,[t("div",mt,[n(k,{onBlur:b,class:"custom-slider",value:e.temperature,"onUpdate:value":a[4]||(a[4]=s=>e.temperature=s),min:0,max:2,step:.1},null,8,["value"])]),t("div",ut,[n(f,{onBlur:b,value:e.temperature,"onUpdate:value":a[5]||(a[5]=s=>e.temperature=s),min:0,max:2,step:.1},null,8,["value"])])])])]),t("div",pt,[t("div",ht,[vt,n(v,null,{title:y(()=>[ft]),default:y(()=>[n(K(Q),{class:"question-icon"})]),_:1})]),t("div",gt,[t("div",yt,[t("div",bt,[n(k,{onBlur:b,class:"custom-slider",value:e.max_token,"onUpdate:value":a[6]||(a[6]=s=>e.max_token=s),min:0,max:100*1024},null,8,["value"])]),t("div",kt,[n(f,{onBlur:b,value:e.max_token,"onUpdate:value":a[7]||(a[7]=s=>e.max_token=s),min:0,max:100*1024},null,8,["value"])])])])])]),t("div",xt,[t("div",St,[$t,t("div",Lt,[wt,t("div",At,[t("div",Ct,[(c(!0),p(V,null,J(A.value,s=>(c(),p("div",{class:le(["retrieval-mode-item",{active:e.search_type==s.value}]),key:s.value,onClick:z=>S(s.value)},[e.search_type==s.value?(c(),P(O,{key:0,class:"check-arrow",name:"check-arrow-filled"})):H("",!0),t("div",Mt,[n(O,{name:s.iconName,class:"title-icon"},null,8,["name"]),t("span",Rt,q(s.title),1),s.isRecommendation?(c(),P(O,{key:0,class:"recommendation-icon",name:"recommendation"})):H("",!0)]),t("div",Dt,q(s.desc),1)],10,Ot))),128))])])]),t("div",It,[t("div",jt,[Nt,n(v,null,{title:y(()=>[I("最多从知识库中召回分段数，最低为1，最高为10。召回分段数越多，消耗的token也会越多。")]),default:y(()=>[n(K(Q),{class:"question-icon"})]),_:1})]),t("div",qt,[t("div",Ut,[t("div",Bt,[n(k,{onBlur:b,class:"custom-slider",value:e.top_k,"onUpdate:value":a[8]||(a[8]=s=>e.top_k=s),min:1,max:10},null,8,["value"])]),t("div",Tt,[n(f,{onBlur:b,value:e.top_k,"onUpdate:value":a[9]||(a[9]=s=>e.top_k=s),min:1,max:10},null,8,["value"])])])])]),e.search_type!=3&&e.search_type!=4?(c(),p("div",zt,[t("div",Et,[Ft,n(v,null,{title:y(()=>[I("召回时，只会召回相似度大于阈值的文本分段。取值范围：0~1，阈值越大回答的越准确，建议不超过0.9")]),default:y(()=>[n(K(Q),{class:"question-icon"})]),_:1})]),t("div",Kt,[t("div",Vt,[t("div",Pt,[n(k,{onBlur:b,class:"custom-slider",value:e.similarity,"onUpdate:value":a[10]||(a[10]=s=>e.similarity=s),min:0,max:1,step:.01},null,8,["value"])]),t("div",Ht,[n(f,{onBlur:b,value:e.similarity,"onUpdate:value":a[11]||(a[11]=s=>e.similarity=s),min:0,max:1,step:.01},null,8,["value"])])])])])):H("",!0),t("div",Jt,[t("div",Qt,[Gt,n(v,null,{title:y(()=>[I("召回时，只会召回相似度大于阈值的文本分段。取值范围：0~1，阈值越大回答的越准确，建议不超过0.9")]),default:y(()=>[n(K(Q),{class:"question-icon"})]),_:1}),n(x,{onChange:b,style:{float:"right"},checkedValue:1,unCheckedValue:0,checked:e.rerank_status,"onUpdate:checked":a[12]||(a[12]=s=>e.rerank_status=s),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),e.rerank_status==1?(c(),p("div",Yt,[n(M,{value:e.rerank_use_model,"onUpdate:value":a[13]||(a[13]=s=>e.rerank_use_model=s),placeholder:"请选择Rerank模型",onChange:l,style:{width:"100%"}},{default:y(()=>[(c(!0),p(V,null,J(R.value,s=>(c(),P(u,{key:s.id},{label:y(()=>[t("span",null,[t("img",{class:"model-icon",src:s.icon,alt:""},null,8,Wt)])]),default:y(()=>[(c(!0),p(V,null,J(s.children,z=>(c(),P(j,{value:z,rerank_model_config_id:s.id,key:z},{default:y(()=>[t("span",null,q(z),1)]),_:2},1032,["value","rerank_model_config_id"]))),128))]),_:2},1024))),128))]),_:1},8,["value"])])):H("",!0)])])])]),_:1},8,["open"])],64)}}}),Zt=Y(Xt,[["__scopeId","data-v-5a852543"]]),ea={class:"no-data"},ta={class:"no-data-text"},aa={__name:"list-empty",props:{text:{type:String,default:"暂无数据"},size:{type:[Number,String],default:100}},setup(_){const o=_;return(A,D)=>{const e=ae;return c(),p("div",ea,[n(e,{name:"empty-document",style:ge({"font-size":`${o.size}px`,color:"white"})},null,8,["style"]),t("div",ta,[ye(A.$slots,"default",{},()=>[I(q(o.text),1)],!0)])])}}},sa=Y(aa,[["__scopeId","data-v-f4fa2763"]]),ee=_=>(re("data-v-cb12478c"),_=_(),ce(),_),oa={class:"search-box-warpper"},ia={class:"search-box-content"},na={class:"search-set-box"},la={key:0,class:"search-content"},ra=ee(()=>t("div",{class:"search-label"},"知识搜索",-1)),ca=ee(()=>t("div",{class:"search-tip"},"快速搜索所选择的知识库中内容",-1)),da={class:"search-input-box"},_a={key:1,class:"search-content search-main"},ma={class:"search-input-box"},ua=ee(()=>t("div",null,[t("p",{style:{color:"#262626","font-size":"16px","font-weight":"600","line-height":"24px"}},"暂无任何内容")],-1)),pa={key:1,class:"search-content-box"},ha={class:"search-tip-box"},va={key:0,class:"tip"},fa={key:1,class:"tip complete"},ga={key:0,class:"container"},ya=be('<div class="rect-container rect1" data-v-cb12478c><div class="rect" data-v-cb12478c></div></div><div class="rect-container rect2" data-v-cb12478c><div class="rect" data-v-cb12478c></div></div><div class="rect-container rect3" data-v-cb12478c><div class="rect" data-v-cb12478c></div></div>',3),ba=[ya],ka={key:1,class:"intelligent-answer"},xa=["innerHTML"],Sa={key:1},$a={class:"section-box"},La=ee(()=>t("div",{class:"tips"},[t("div",{class:"tips-text"},"以上内容由大模型生成"),t("div",{class:"tips-line"})],-1)),wa={key:0,class:"section-label"},Aa={class:"section-item-nav"},Ca={class:"section-item-nav-left"},Oa=["onClick"],Ma={key:0},Ra={class:"section-item-nav-right"},Da=["innerHTML"],Ia={__name:"search-box",props:{librarySearchData:{type:Object,default:null},messageObj:{type:Object,default:null},library_ids:{type:Array,default:()=>[]},isError:{type:Boolean,default:!1}},emits:["search","defaultParmas"],setup(_,{expose:o,emit:A}){const D=A,e=_,R=new Je({html:!0,linkify:!0,typographer:!0}),C=w(""),L=w(""),B=w(!1),F=w(!1),S=w({});Z(()=>e.messageObj.content,()=>{C.value=R.render(e.messageObj.content)}),Z(()=>e.messageObj.error,r=>{r&&X(r)});const l=async()=>{if(!e.library_ids.length)return X("请在左侧的知识库选择项内至少选择一个知识库");if(!L.value)return X("请输入消息内容");a(),D("search",L.value),B.value=!0};function m(r){return r.match(/^-?\d+(?:\.\d{0,2})?/)[0]}const b=(r,v)=>{if(!r||!v.trim())return r;const k=v.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),f=new RegExp(`(${k})`,"gi");return r.replace(f,'<span class="highlight">$1</span>')},h=r=>{if(!r.file_name){window.open(`#/library/details/categary-manage?id=${r.library_id}`);return}window.open(`#/library/preview?id=${r.file_id}`)},d=G({rerank_status:"",rerank_use_model:"",prompt:"",model_config_id:"",use_model:"",temperature:.5,max_token:2e3,similarity:.4,search_type:1}),i=w({}),a=()=>{let r={model_config_id:e.librarySearchData.model_config_id||d.model_config_id,use_model:e.librarySearchData.use_model||d.use_model,temperature:e.librarySearchData.temperature||d.temperature,max_token:e.librarySearchData.max_token||d.max_token,size:200,similarity:e.librarySearchData.similarity||d.similarity,search_type:e.librarySearchData.search_type||d.search_type,question:L.value,id:e.library_ids.join(","),recall_type:1};e.librarySearchData.rerank_status&&(r.rerank_status=e.librarySearchData.rerank_status),e.librarySearchData.rerank_use_model&&(r.rerank_use_model=e.librarySearchData.rerank_use_model),e.librarySearchData.prompt&&(r.prompt=e.librarySearchData.prompt),e.librarySearchData.rerank_status==1&&(r.rerank_model_config_id=e.librarySearchData.rerank_model_config_id),F.value=!0,i.value=Object.assign(r),D("defaultParmas",i.value),we(r).then(v=>{S.value=v.data}).catch(()=>{}).finally(()=>{F.value=!1})},$=w([]);function T(r,v,k){const f=new Set(r.map(O=>O.model_define));return v.filter(O=>{let x=O[k];f.has(x)&&r.filter(j=>{if(j.model_define==x)return j.children=Le(j.children,O.children),!1})}),r}const E=async()=>{await _e({model_type:"LLM"}).then(r=>{let v=r.data||[],k=[];$.value=v.map(f=>{k=[];for(let O=0;O<f.model_info.llm_model_list.length;O++){const x=f.model_info.llm_model_list[O];k.push({name:x,deployment_name:f.model_config.deployment_name,model_config_id:f.model_config.id,model_define:f.model_info.model_define})}return{model_config_id:f.model_config.id,name:f.model_info.model_name,model_define:f.model_info.model_define,icon:f.model_info.model_icon_url,children:k,deployment_name:f.model_config.deployment_name}}),$.value=T($e($.value,"model_define"),$.value,"model_define")})};return te(async()=>{var r,v,k,f,O;if(await E(),!((r=e.librarySearchData)!=null&&r.model_config_id)||!((v=e.librarySearchData)!=null&&v.use_model)){if($.value.length>0){let x=$.value[0];if(x){let j=x.children[0];d.use_model=j.name,d.model_config_id=j.model_config_id}}}else d.use_model=((k=e.librarySearchData)==null?void 0:k.use_model)+"$$",d.model_config_id=((f=e.librarySearchData)==null?void 0:f.model_config_id)+"$$",d.use_model=d.use_model.split("$$")[0],d.model_config_id=(O=e.librarySearchData)==null?void 0:O.model_config_id.split("$$")[0]}),o({}),(r,v)=>{const k=ae,f=Qe,O=me;return c(),p("div",oa,[t("div",ia,[t("div",na,[n(Zt,{librarySearchData:e.librarySearchData},null,8,["librarySearchData"])]),B.value?(c(),p("div",_a,[t("div",ma,[n(f,{class:"search-input",onPressEnter:l,value:L.value,"onUpdate:value":v[1]||(v[1]=x=>L.value=x),"allow-clear":"",placeholder:"输入关键词搜索"},{suffix:y(()=>[t("div",{class:"search-icon-box",onClick:l},[n(k,{class:"search-icon",name:"search-right"})])]),_:1},8,["value"])]),!C.value&&_.messageObj.finish&&!S.value.length?(c(),P(sa,{key:0,style:{"margin-top":"100px"},size:"250"},{default:y(()=>[ua]),_:1})):(c(),p("div",pa,[t("div",ha,[n(k,{class:"nav-icon",name:"search-tip"}),_.messageObj.finish?(c(),p("span",fa,"智能回答生成完毕")):(c(),p("span",va,"智能回答生成中..."))]),!_.messageObj.content&&!_.messageObj.finish&&!_.isError?(c(),p("div",ga,ba)):(c(),p("div",ka,[C.value?(c(),p("div",{key:0,innerHTML:C.value},null,8,xa)):(c(),p("div",Sa,"暂无任何内容"))])),t("div",$a,[La,S.value.length?(c(),p("div",wa,[I("相关分段 "),t("div",null,"("+q(S.value.length)+")",1)])):H("",!0),(c(!0),p(V,null,J(S.value,x=>(c(),p("div",{class:"section-item",key:x.id},[t("div",Aa,[t("div",Ca,[n(k,{class:"section-item-icon",name:"document"}),t("div",{class:"section-item-label",onClick:j=>h(x)},[I(q(x.file_name),1),x.file_name?H("",!0):(c(),p("span",Ma,q(x.library_name)+"-精选",1))],8,Oa)]),t("div",Ra,"相似度："+q(m(x.similarity)),1)]),n(O,{overlayClassName:"search-content-tip",placement:"top"},{title:y(()=>[I(q(x.content),1)]),default:y(()=>[t("div",{class:"section-item-content",innerHTML:b(x.content,L.value)},null,8,Da)]),_:2},1024)]))),128))])]))])):(c(),p("div",la,[ra,ca,t("div",da,[n(f,{class:"search-input",onPressEnter:l,value:L.value,"onUpdate:value":v[0]||(v[0]=x=>L.value=x),"allow-clear":"",placeholder:"输入关键词搜索"},{suffix:y(()=>[t("div",{class:"search-icon-box",onClick:l},[n(k,{class:"search-icon",name:"search-right"})])]),_:1},8,["value"])])]))])])}}},ja=Y(Ia,[["__scopeId","data-v-cb12478c"]]),Na={class:"cu-tabs"},qa=["onClick"],Ua={__name:"contain-tabs",props:{value:{type:[Number,String],required:!0},tabs:{type:Array,required:!0,default:()=>[]}},emits:["update:value","change"],setup(_,{emit:o}){const A=o,D=_,e=R=>{A("update:value",R),A("change",R)};return(R,C)=>(c(),p("div",Na,[(c(!0),p(V,null,J(_.tabs,L=>(c(),p("div",{class:le(["tab-item",{active:D.value===L.value}]),onClick:B=>e(L.value),key:L.value},q(L.title),11,qa))),128))]))}},Ba=Y(Ua,[["__scopeId","data-v-a6e0ef08"]]),Ta=de("searchStore",{state:()=>({indeterminate:!1,checkAll:!1,checkedList:[],activeKey:"all"}),getters:{getIndeterminate(){return this.indeterminate},getCheckAll(){return this.checkAll},getCheckedList(){return this.checkedList},getActiveKey(){return this.activeKey}},actions:{setIndeterminate(_){this.indeterminate=_},setCheckAll(_){this.checkAll=_},setCheckedList(_){this.checkedList=_},setActiveKey(_){this.activeKey=_}},persist:{enabled:!0,strategies:[{key:"searchStore",storage:localStorage,paths:["indeterminate","checkAll","checkedList","activeKey"]}]}}),za=de("search-lirary",()=>{const _=Ge(),o=G({reasoning_content:"",show_reasoning:!1,content:"",quote_file:[],id:"",finish:!1,debug:[],error:[],recall_time:0,request_time:0,loading:!1});let A=null;const D=w(0),e=w(""),R=G({context_pair:"",create_time:"",id:"",max_token:"",model_config_id:"",rerank_model_config_id:"",rerank_status:"",rerank_use_model:"",search_type:"",similarity:"",size:"",temperature:"",update_time:"",use_model:"",user_id:""}),C=(S,l)=>{if(S=="reasoning_content"){let m=o.reasoning_content||"";o.reasoning_content=m+l,o.show_reasoning=!0}if(S=="sending"){let m=o.content||"";o.content=m+l}if(S=="quote_file"&&(o.quote_file=l.length>0?l:[]),S=="ai_message"){if(l.menu_json&&l.msg_type==2){let m=JSON.parse(l.menu_json);o.question=m.question}o.id=l.id,o.content=l.content,l.quote_file&&typeof l.quote_file=="string"&&(o.quote_file=JSON.parse(l.quote_file))}S=="finish"&&(o.finish=!0),S=="debug"&&(o.debug=l.length>0?l:[]),S=="error"&&(o.error=l.length>0?l:[]),S=="recall_time"&&(o.recall_time=l||0),S=="request_time"&&(o.request_time=l||0),_.emit("updateAiMessage",o)},L=()=>{o.loading=!1};return{searchFormState:R,dialogue_id:D,openid:e,messageObj:o,getLibrarySearchFn:async()=>{A&&(A.abort(),A=null);const S=await Me();try{let l=S.data;Object.assign(R,{...l})}catch(l){Promise.reject(l)}return S},searchMessage:(S,l,m)=>{Ae(32),o.content="",o.finish=!1;let b={model_config_id:m.model_config_id,use_model:m.use_model,temperature:m.temperature,max_token:m.max_token,size:m.size,similarity:m.similarity,search_type:m.search_type,question:S,id:l.join(","),recall_type:1};m.rerank_status&&(b.rerank_status=m.rerank_status),m.rerank_use_model&&(b.rerank_use_model=m.rerank_use_model),m.prompt&&(b.prompt=m.prompt),m.rerank_status==1&&(b.rerank_model_config_id=m.rerank_model_config_id),A=Ce(b),A.onMessage=h=>{if(h.event!=="sending"&&Oe(h),h.event=="dialogue_id"&&(D.value=h.data),h.event=="reasoning_content"&&C("reasoning_content",h.data),h.event=="sending"&&C("sending",h.data),h.event=="ai_message"){let d=JSON.parse(h.data);C("ai_message",d)}if(h.event=="quote_file"){let d=JSON.parse(h.data);C("quote_file",d)}if(h.event=="finish"&&C("finish",h.data),h.event=="debug"){let d=JSON.parse(h.data);C("debug",d)}if(h.event=="error"){let d=h.data;C("error",d)}if(h.event=="recall_time"){let d=h.data;C("recall_time",d)}},A.onClose=()=>{L(),A=null}}}}),Ea={class:"chat-monitor-page"},Fa={class:"page-left"},Ka={class:"toolbar-box"},Va={class:"library-checkbox-box"},Pa={class:"app-list-box"},Ha={class:"list-box",ref:"scrollContainer"},Ja={class:"list-item"},Qa={class:"list-item-box"},Ga={class:"library-icon"},Ya=["onClick"],Wa={class:"page-body"},Xa={__name:"index",setup(_){const o=Ta();let{getIndeterminate:A,getCheckAll:D,getCheckedList:e,getActiveKey:R}=ie(o);const C=za(),{getLibrarySearchFn:L,searchMessage:B}=C,{messageObj:F}=ie(C),S=w(null),l=w(null),m=w("all"),b=w([{title:"全部",value:"all"},{title:"普通",value:"0"},{title:"问答",value:"2"}]),h=w({}),d=w([]),i=G({indeterminate:!1,checkAll:!1,checkedList:[]}),a=u=>{h.value=u},$=w(!1),T=async u=>{$.value=!1;let M=await L();if(l.value=M.data,l.value.id||(l.value=Object.assign(h.value)),!l.value.model_config_id||!l.value.use_model)return $.value=!0,X("请在搜索设置中配置好相应配置后再使用");B(u,i.checkedList,l.value)},E=u=>{Object.assign(i,{checkedList:u.target.checked?d.value.map(M=>M.id):[],indeterminate:!!i.checkedList.length&&i.checkedList.length<d.value.length}),o.setCheckedList(i.checkedList),o.setIndeterminate(i.indeterminate)},r=u=>{o.setCheckedList(u)},v=u=>{window.open(`#/library/details/knowledge-document?id=${u}`)};Z(()=>i.checkedList,u=>{i.indeterminate=!!u.length&&u.length<d.value.length,i.checkAll=u.length>=d.value.length,o.setIndeterminate(i.indeterminate),o.setCheckAll(i.checkAll)});const k=()=>{d.value.forEach(u=>{u.type==0,u.type==2}),b.value=[{title:"全部",value:"all"},{title:"普通",value:"0"},{title:"问答",value:"2"}]},f=(u,M)=>{if(M.length===0)return!1;const N=new Set(u);return M.every(s=>N.has(s))},O=(u,M)=>!M.some(N=>u.includes(N)),x=async()=>{let u=m.value==="all"?"":m.value;await Re({type:u}).then(M=>{var z;let N=M.data||[];N.forEach(g=>{g.file_size_str=De(g.file_size),g.avatar||(g.avatar=g.type==0?Ie:je)}),d.value=N;const s=d.value.map(g=>g.id);if((z=e.value)!=null&&z.length&&(s!=null&&s.length)){const g=e.value,W=s,ue=f(g,W),pe=O(g,W),se=g.length>=W.length&&ue,oe={checkAll:se,indeterminate:!se&&!pe};o.$patch(oe),Object.assign(i,oe)}else{const g={checkAll:!1,indeterminate:!1};o.$patch(g),Object.assign(i,g)}i.checkedList=e.value,i.indeterminate=A.value,!D.value&&e.value.length==0&&!A.value&&R.value=="all"&&(o.setCheckAll(!0),i.checkedList=s,o.setCheckedList(s)),m.value==="all"&&k()})},j=u=>{o.setActiveKey(u),x()};return te(async()=>{R.value&&(m.value=R.value),await x();let u=await L();l.value=u.data}),ke(()=>{}),(u,M)=>{const N=Ye,s=Xe,z=We;return c(),p("div",Ea,[t("div",Fa,[t("div",Ka,[n(Ba,{tabs:b.value,value:m.value,"onUpdate:value":M[0]||(M[0]=g=>m.value=g),onChange:j},null,8,["tabs","value"])]),t("div",Va,[t("div",Pa,[n(N,{checked:i.checkAll,"onUpdate:checked":M[1]||(M[1]=g=>i.checkAll=g),indeterminate:i.indeterminate,onChange:E},{default:y(()=>[I(" 全选/取消 ")]),_:1},8,["checked","indeterminate"])]),n(z,{value:i.checkedList,"onUpdate:value":M[2]||(M[2]=g=>i.checkedList=g),onChange:r},{default:y(()=>[t("div",Ha,[(c(!0),p(V,null,J(d.value,g=>(c(),p("div",{class:"list-item-wraapper",key:g.id},[t("div",Ja,[n(N,{value:g.id},null,8,["value"]),t("div",Qa,[t("div",Ga,[n(s,{preview:!1,width:32,src:g.avatar},null,8,["src"])]),t("div",{class:"library-name",onClick:W=>v(g.id)},q(g.library_name),9,Ya)])])]))),128))],512)]),_:1},8,["value"])])]),t("div",Wa,[n(ja,{ref_key:"searchBoxRef",ref:S,onDefaultParmas:a,onSearch:T,isError:$.value,messageObj:K(F),librarySearchData:l.value,library_ids:i.checkedList},null,8,["isError","messageObj","librarySearchData","library_ids"])])])}}},Qs=Y(Xa,[["__scopeId","data-v-13039c07"]]);export{Qs as default};
