import{C as ge}from"./cu-scroll-BZhESYtD.js";import{b as ve,e as ye,$ as be,bh as we,a0 as xe,k as Y,d as Ce,M as ze,b3 as Be}from"../../index-DQXF0oEW.js";import{b as Ie,a5 as Le,a4 as Me,B as H,e as h,M as s,Q as C,S as _,W as r,k as l,V as S,u as z,a7 as g,N as k,$ as W,Y as u,Z as N,F as b,G as X,H as Z,a6 as A,z as Se,a1 as Ne,a2 as Ae,l as Ue}from"./vue-chunks-DWnFCQSz.js";import{a as qe,i as Oe,m as Ve}from"./index-CpYnoGfS.js";import{c as Te}from"./index-DaUzcbAM.js";import{A as De}from"./avatar-input-p1qyzpls.js";import{M as J}from"./model-select-DLutQAFv.js";import{O as $e}from"./open-grapg-modal-DkD7GAL6.js";import{F as K,_ as Ee}from"./index-DpzELZe5.js";import"./index-9760vytK.js";import{I as Re}from"./Input-COJTivTx.js";import{Q as ee}from"./QuestionCircleOutlined-DN9kmFuV.js";import{_ as Fe}from"./TextArea-Cc6YC843.js";import{_ as Ge}from"./index-Dq7FbVld.js";import{S as Qe,a as je,_ as Pe}from"./index-B-Rt9SA5.js";import{_ as Ye}from"./index-BZQEdDUD.js";import{_ as He}from"./index-hPIuiQ85.js";import{_ as We}from"./index-CUGUQ2OU.js";import"./pull-up.esm-JZ91zQ8P.js";import"./observe-dom.esm-DPKTicVt.js";import"./axios-Cm0UX6qg.js";import"./qs-De-rn6vz.js";import"./crypto-js-U6t3rvpm.js";import"./dayjs-BI1HIvBC.js";import"./index-DzhuYAPB.js";import"./PlusOutlined-CP-yUfey.js";import"./index-RZ7sMF92.js";import"./partition-D4Qmrw-1.js";import"./Trigger-CC5n-pw8.js";import"./Password-DAfpdhAR.js";import"./inputProps-Bb0ocHOp.js";import"./CheckOutlined-BrtNruPW.js";import"./useRefs-CH9tJ50T.js";import"./collapseMotion-ByInPrfq.js";import"./FormItemContext-D4f_Sq6G.js";import"./isPlainObject-DGw0gsC3.js";import"./responsiveObserve-D-e1nmNx.js";import"./index-J-L5YNWa.js";import"./Search-Cm7pOAiq.js";import"./SearchOutlined-Eloz0Xgr.js";import"./statusUtils-B7nMMwz3.js";import"./index-DwY9A703.js";import"./slide-DBTiAtg1.js";import"./DownOutlined-Bq0bLGm4.js";import"./move-DQ5ZIRU6.js";import"./UpOutlined-DA6kJIik.js";import"./colors-CunZT9q_.js";const w=B=>(Ne("data-v-49454136"),B=B(),Ae(),B),Xe={class:"add-library-page"},Ze={class:"form-box"},Je=w(()=>r("div",{class:"form-item-tip"},"请上传知识库封面，建议尺寸为100*100px.大小不超过100kb",-1));const Ke=["src"],ea={key:0},aa={key:1},na=w(()=>r("div",{class:"form-item-tip"},"开启后，可以文档列表手动点击知识图谱学习生成知识图谱",-1)),oa=w(()=>r("div",{class:"form-alert-tip"},"提示：语义分段更适合没有排版过的文章，即没有明显换行符号的文本，否则更推荐使用普通分段",-1)),la={class:"select-card-box"},ta={class:"card-title"},_a=w(()=>r("div",{class:"card-desc"}," 基于文章中句号、空行，或者自定义符号进行分段，不会消耗模型token ",-1)),ia={class:"card-title"},da=w(()=>r("div",{class:"card-desc"}," 将文章拆分成句子后，通过语句向量相似度进行分段，会消耗模型token ",-1)),ra={class:"card-title"},ua=w(()=>r("div",{class:"card-desc"}," 将文章提交给大模型，大模型基于设定的提示词进行分段，会消耗大量模型token ",-1)),U="你是一位文章分段助手，根据文章内容的语义进行合理分段，确保每个分段表述一个完整的语义，每个分段字数控制在500字左右，最大不超过1000字。请严格按照文章内容进行分段，不要对文章内容进行加工，分段完成后输出分段后的内容。",sa={__name:"knowledge-config",setup(B){const ae=ye(),q=Ie(()=>{var n;return((n=ae.companyInfo)==null?void 0:n.neo4j_status)=="true"}),O=Le(),ne=Me(),V=O.query,T=we,e=H({library_name:"",library_intro:"",use_model:"",is_offline:"",model_config_id:"",avatar:T,avatar_file:"",graph_switch:!1,graph_model_config_id:void 0,graph_use_model:"",chunk_type:1,normal_chunk_default_separators_no:[10,12],normal_chunk_default_chunk_size:512,normal_chunk_default_chunk_overlap:50,semantic_chunk_default_chunk_size:512,semantic_chunk_default_chunk_overlap:50,semantic_chunk_default_threshold:90,ai_chunk_size:5e3,ai_chunk_model:"",ai_chunk_model_config_id:"",ai_chunk_prumpt:U}),D=h(""),oe=h(0),$=h({}),E=h([]);qe().then(n=>{E.value=n.data.map(a=>({label:a.name,value:a.no}))});const R=h(!0);(()=>{Oe({id:V.id}).then(n=>{$.value=n.data,oe.value=$.value.is_offline?2:1,e.library_name=n.data.library_name,e.library_intro=n.data.library_intro,e.use_model=n.data.use_model,e.is_offline=n.data.is_offline,e.model_config_id=n.data.model_config_id,e.avatar=n.data.avatar?n.data.avatar:T,e.avatar_file=n.data.avatar_file?n.data.avatar_file:"",e.graph_switch=n.data.graph_switch!="0",e.graph_model_config_id=n.data.graph_model_config_id>0?n.data.graph_model_config_id:void 0,e.graph_use_model=n.data.graph_use_model,e.chunk_type=+n.data.chunk_type,e.normal_chunk_default_separators_no=n.data.normal_chunk_default_separators_no?n.data.normal_chunk_default_separators_no.split(",").map(a=>+a):[],e.normal_chunk_default_chunk_size=n.data.normal_chunk_default_chunk_size,e.normal_chunk_default_chunk_overlap=n.data.normal_chunk_default_chunk_overlap,e.semantic_chunk_default_chunk_size=n.data.semantic_chunk_default_chunk_size,e.semantic_chunk_default_chunk_overlap=n.data.semantic_chunk_default_chunk_overlap,e.semantic_chunk_default_threshold=n.data.semantic_chunk_default_threshold,e.ai_chunk_size=n.data.ai_chunk_size||5e3,e.ai_chunk_model=n.data.ai_chunk_model,e.ai_chunk_model_config_id=n.data.ai_chunk_model_config_id,e.ai_chunk_prumpt=n.data.ai_chunk_prumpt||U,R.value=n.data.type==2})})();const ma=h([{iconName:"high-active",title:"高质量",value:1,is_offline:!1,desc:"使用在线的嵌入模型，在召回时具有更高的准确度，但需要花费token"}]),le=K.useForm,te=H({library_name:[{required:!0,message:"请输入库名称",trigger:"blur"}],use_model:[{required:!0,message:"请选择嵌入模型",trigger:"change"}]}),{validateInfos:I}=le(e,te),_e=(n,a)=>{const i=a.current_obj;e.use_model=L.indexOf(i.model_define)>-1&&i.deployment_name?i.deployment_name:i.name,D.value=i.model_define,e.model_config_id=i.id||a.model_config_id,d()},ie=n=>{e.avatar=n.imageUrl,e.avatar_file=n.file,d()},pa=()=>!1,x=h([]),L=["azure","ollama","xinference","openaiAgent"],de=["azure"];function re(n,a,i){const t=new Set(n.map(c=>c.model_define));return a.filter(c=>{let m=c[i];t.has(m)&&n.filter(f=>{if(f.model_define==m)return f.children=xe(f.children,c.children),!1})}),n}(()=>{Te({model_type:"TEXT EMBEDDING",is_offline:!1}).then(n=>{let a=n.data||[],i=[];x.value=a.map(t=>{i=[];for(let c=0;c<t.model_info.vector_model_list.length;c++){const m=t.model_info.vector_model_list[c];i.push({name:m,deployment_name:t.model_config.deployment_name,id:t.model_config.id,model_define:t.model_info.model_define})}return{id:t.model_config.id,name:t.model_info.model_name,model_define:t.model_info.model_define,icon:t.model_info.model_icon_url,children:i,deployment_name:t.model_config.deployment_name}}),x.value=re(be(x.value,"model_define"),x.value,"model_define")})})();const F=()=>{d()},v=h([]),G=n=>{v.value=n,Se(()=>{(!e.ai_chunk_model||!Number(e.ai_chunk_model_config_id))&&ue()})},ue=()=>{if(v.value.length>0){let n=null,a=null;for(let i of v.value)if(i.model_define==="tongyi"){n=i;for(let t of n.children)if(t.name==="qwen-max"){a=t;break}break}n||(n=v.value[0],a=n.children[0]),n&&a&&(e.ai_chunk_model=a.name,e.ai_chunk_model_config_id=a.model_config_id)}},Q=h(null),se=n=>{if(n){e.graph_switch=!1;let a={graph_model_config_id:e.graph_model_config_id,graph_use_model:e.graph_use_model};if((!e.graph_model_config_id||!e.graph_use_model)&&v.value.length>0){let i=v.value[0];if(i){let t=i.children[0];a.graph_use_model=t.name,a.graph_model_config_id=t.model_config_id}}Q.value.show(a)}else e.graph_switch=!1,d()},M=n=>{e.chunk_type=n,d()},ce=n=>{n.graph_model_config_id&&(e.graph_switch=!0,e.graph_model_config_id=n.graph_model_config_id,e.graph_use_model=n.graph_use_model,d(()=>{ze.confirm({title:"已开启知识图谱",content:"您可以在文档列表中点击知识图谱学习，系統将在您手动操作后开始抽取知识图谱",cancelText:"知道了",okText:"去学习",icon:Ue(Be,{style:{color:"#52c41a"}}),onOk:()=>ne.push({path:"/library/details/knowledge-document",query:{id:V.id}})})}))},d=(n=null)=>{if(!e.library_name)return Y.error("请输入知识库名称");let a={library_name:e.library_name,library_intro:e.library_intro,use_model:e.use_model,model_config_id:e.model_config_id,is_offline:e.is_offline,graph_switch:e.graph_switch?1:0,graph_model_config_id:e.graph_model_config_id,graph_use_model:e.graph_use_model,chunk_type:e.chunk_type,normal_chunk_default_separators_no:e.normal_chunk_default_separators_no.join(","),normal_chunk_default_chunk_size:e.normal_chunk_default_chunk_size,normal_chunk_default_chunk_overlap:e.normal_chunk_default_chunk_overlap,semantic_chunk_default_chunk_size:e.semantic_chunk_default_chunk_size,semantic_chunk_default_chunk_overlap:e.semantic_chunk_default_chunk_overlap,semantic_chunk_default_threshold:e.semantic_chunk_default_threshold,ai_chunk_size:e.ai_chunk_size,ai_chunk_model:e.ai_chunk_model,ai_chunk_model_config_id:e.ai_chunk_model_config_id,ai_chunk_prumpt:e.ai_chunk_prumpt,id:O.query.id};de.indexOf(D.value)>-1&&(a.use_model="默认"),e.avatar_file&&(a.avatar=e.avatar_file),Ve(a).then(i=>{typeof n=="function"?n():Y.success("修改成功")})};return(n,a)=>{const i=Re,t=Ee,c=Fe,m=Ce,f=Ge,me=Qe,pe=je,j=Pe,fe=Ye,y=He,P=We,he=K,ke=ge;return s(),C(ke,null,{default:_(()=>[r("div",Xe,[r("div",Ze,[l(he,{"label-col":{span:5}},{default:_(()=>[l(t,S({ref:"name",label:"知识库名称"},z(I).library_name),{default:_(()=>[l(i,{onBlur:d,value:e.library_name,"onUpdate:value":a[0]||(a[0]=o=>e.library_name=o),placeholder:"请输入知识库名称，最多20个字"},null,8,["value"])]),_:1},16),l(t,{label:"知识库简介"},{default:_(()=>[l(c,{onBlur:d,value:e.library_intro,"onUpdate:value":a[1]||(a[1]=o=>e.library_intro=o),placeholder:"请输入知识库介绍"},null,8,["value"])]),_:1}),l(t,S({ref:"name",label:"知识库封面"},z(I).avatar),{default:_(()=>[l(De,{value:e.avatar,"onUpdate:value":a[2]||(a[2]=o=>e.avatar=o),onChange:ie},null,8,["value"]),Je]),_:1},16),l(t,S({label:"嵌入模型"},z(I).use_model),{default:_(()=>[g("",!0),l(j,{onChange:_e,value:e.use_model,"onUpdate:value":a[3]||(a[3]=o=>e.use_model=o),placeholder:"请选择嵌入模型"},{default:_(()=>[(s(!0),k(b,null,W(x.value,o=>(s(),C(pe,{key:o.id},{label:_(()=>[l(f,{align:"center",gap:6},{default:_(()=>[r("img",{class:"model-icon",src:o.icon,alt:""},null,8,Ke),u(N(o.name),1)]),_:2},1024)]),default:_(()=>[(s(!0),k(b,null,W(o.children,p=>(s(),C(me,{value:L.indexOf(o.model_define)>-1&&p.deployment_name?p.deployment_name:p.name+p.id,model_config_id:o.id,current_obj:p,key:p.name+p.id},{default:_(()=>[L.indexOf(o.model_define)>-1&&p.deployment_name?(s(),k("span",ea,N(p.deployment_name),1)):(s(),k("span",aa,N(p.name),1))]),_:2},1032,["value","model_config_id","current_obj"]))),128))]),_:2},1024))),128))]),_:1},8,["value"])]),_:1},16),X(l(t,{label:"生成知识图谱"},{default:_(()=>[l(fe,{onChange:se,checked:e.graph_switch,"checked-children":"开","un-checked-children":"关"},null,8,["checked"]),na]),_:1},512),[[Z,q.value]]),X(l(t,{label:"知识图谱模型"},{default:_(()=>[l(J,{modelType:"LLM",modeName:e.graph_use_model,"onUpdate:modeName":a[4]||(a[4]=o=>e.graph_use_model=o),modeId:e.graph_model_config_id,"onUpdate:modeId":a[5]||(a[5]=o=>e.graph_model_config_id=o),style:{width:"300px"},onChange:F,onLoaded:G},null,8,["modeName","modeId"])]),_:1},512),[[Z,e.graph_switch&&q.value]]),R.value?g("",!0):(s(),k(b,{key:0},[l(t,{label:"分段方式",required:""},{default:_(()=>[oa,r("div",la,[r("div",{class:A(["select-card-item",{active:e.chunk_type==1}]),onClick:a[6]||(a[6]=o=>M(1))},[l(m,{class:"check-arrow",name:"check-arrow-filled"}),r("div",ta,[l(m,{name:"ordinary-segmentation",class:"title-icon"}),u(" 普通分段 ")]),_a],2),r("div",{class:A(["select-card-item",{active:e.chunk_type==2}]),onClick:a[7]||(a[7]=o=>M(2))},[l(m,{class:"check-arrow",name:"check-arrow-filled"}),r("div",ia,[l(m,{name:"semantic-segmentation",class:"title-icon"}),u(" 语义分段 ")]),da],2),r("div",{class:A(["select-card-item",{active:e.chunk_type==3}]),onClick:a[8]||(a[8]=o=>M(3))},[l(m,{class:"check-arrow",name:"check-arrow-filled"}),r("div",ra,[l(m,{name:"semantic-segmentation",class:"title-icon"}),u(" AI分段 ")]),ua],2)])]),_:1}),e.chunk_type==1?(s(),k(b,{key:0},[l(t,{label:"分段标识符",required:""},{default:_(()=>[l(j,{onChange:d,value:e.normal_chunk_default_separators_no,"onUpdate:value":a[9]||(a[9]=o=>e.normal_chunk_default_separators_no=o),mode:"multiple",style:{width:"100%"},placeholder:"请选择分段标识符",options:E.value},null,8,["value","options"])]),_:1}),l(t,{label:"分段最大长度",required:""},{default:_(()=>[l(f,{gap:8,align:"center"},{default:_(()=>[l(y,{onBlur:d,value:e.normal_chunk_default_chunk_size,"onUpdate:value":a[10]||(a[10]=o=>e.normal_chunk_default_chunk_size=o),style:{width:"220px"},precision:0,min:1,max:1e5},null,8,["value"]),u(" 字符 ")]),_:1})]),_:1}),l(t,{label:"分段重叠长度"},{default:_(()=>[l(f,{gap:8,align:"center"},{default:_(()=>[l(y,{onBlur:d,value:e.normal_chunk_default_chunk_overlap,"onUpdate:value":a[11]||(a[11]=o=>e.normal_chunk_default_chunk_overlap=o),style:{width:"220px"},precision:0,min:1,max:1e5},null,8,["value"]),u(" 字符 ")]),_:1})]),_:1})],64)):g("",!0),e.chunk_type==2?(s(),k(b,{key:1},[e.chunk_type==2?(s(),C(t,{key:0,required:""},{label:_(()=>[u(" 分段阈值 "),l(P,null,{title:_(()=>[u("用于控制分段拆分的标准，数值0~100,数值越大，分段越少，数值越小，分段越多。")]),default:_(()=>[l(z(ee),{style:{cursor:"pointer","margin-left":"2px"}})]),_:1})]),default:_(()=>[l(y,{onBlur:d,value:e.semantic_chunk_default_threshold,"onUpdate:value":a[12]||(a[12]=o=>e.semantic_chunk_default_threshold=o),style:{width:"100%"},placeholder:"请输入分段阈值",precision:0,min:0,max:100},null,8,["value"])]),_:1})):g("",!0),l(t,{label:"分段最大长度",required:""},{default:_(()=>[l(f,{gap:8,align:"center"},{default:_(()=>[l(y,{onBlur:d,value:e.semantic_chunk_default_chunk_size,"onUpdate:value":a[13]||(a[13]=o=>e.semantic_chunk_default_chunk_size=o),style:{width:"220px"},precision:0,min:1,max:1e5},null,8,["value"]),u(" 字符 ")]),_:1})]),_:1}),l(t,{label:"分段重叠长度"},{default:_(()=>[l(f,{gap:8,align:"center"},{default:_(()=>[l(y,{onBlur:d,value:e.semantic_chunk_default_chunk_overlap,"onUpdate:value":a[14]||(a[14]=o=>e.semantic_chunk_default_chunk_overlap=o),style:{width:"220px"},precision:0,min:1,max:1e5},null,8,["value"]),u(" 字符 ")]),_:1})]),_:1})],64)):g("",!0),e.chunk_type==3?(s(),k(b,{key:2},[e.chunk_type==3?(s(),C(t,{key:0,required:""},{label:_(()=>[u(" AI大模型 ")]),default:_(()=>[l(J,{modelType:"LLM",placeholder:"请选择AI大模型",modeName:e.ai_chunk_model,"onUpdate:modeName":a[15]||(a[15]=o=>e.ai_chunk_model=o),modeId:e.ai_chunk_model_config_id,"onUpdate:modeId":a[16]||(a[16]=o=>e.ai_chunk_model_config_id=o),style:{width:"300px"},onChange:F,onLoaded:G},null,8,["modeName","modeId"])]),_:1})):g("",!0),l(t,{label:"提示词设置",required:""},{default:_(()=>[l(f,{gap:8,align:"center"},{default:_(()=>[l(c,{onBlur:d,maxLength:500,style:{height:"80px"},value:e.ai_chunk_prumpt,"onUpdate:value":a[17]||(a[17]=o=>e.ai_chunk_prumpt=o),placeholder:U},null,8,["value"])]),_:1})]),_:1}),l(t,null,{label:_(()=>[u(" 单次最大字符数 "),l(P,null,{title:_(()=>[u("由于大模型支持的上下文数量有限制，如果上传的文档较大，会按照最大字符数先拆分成多个分段，再提交给大模型进行分段。")]),default:_(()=>[l(z(ee),{style:{cursor:"pointer","margin-left":"2px"}})]),_:1})]),default:_(()=>[l(y,{onBlur:d,class:"form-item-inptu-numbner",value:e.ai_chunk_size,"onUpdate:value":a[18]||(a[18]=o=>e.ai_chunk_size=o),placeholder:"请输入单次最大字符数",precision:0,min:0,formatter:o=>parseInt(o),parser:o=>parseInt(o)},null,8,["value","formatter","parser"]),u(" 字符 ")]),_:1})],64)):g("",!0)],64))]),_:1})]),l($e,{onOk:ce,ref_key:"openGrapgModalRef",ref:Q},null,512)])]),_:1})}}},un=ve(sa,[["__scopeId","data-v-49454136"]]);export{un as default};
