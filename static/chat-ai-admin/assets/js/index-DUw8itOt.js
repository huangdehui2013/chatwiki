import{e as g,B as se,x as W,w as Q,M as d,N as c,W as e,k as f,S as $,F as O,a0 as P,u as A,Q as oe,Y as M,Z as x,ai as ae,a6 as De,G,a1 as V,a2 as N,a7 as R,z as ee,a4 as we,a9 as Ce,D as Ee,a3 as Ie}from"./vue-chunks-DKljrDvA.js";import{a as D}from"./dayjs-BpZi_McX.js";import{k as Le,b as Y,bw as te,B as He,M as Me}from"../../index-BYXP5-K6.js";import{a as Be,_ as Re}from"./RadioButton-D6KxmP_c.js";import{R as Oe}from"./dayjs-CMMYMRu0.js";import{_ as le}from"./empty-DkpCLaix.js";import{_ as Ae}from"./useIM-CtWvGIPT.js";import{S as Ue}from"./index-B7oz8JPj.js";import{u as qe}from"./robot-Dfyviyx0.js";import{u as ze}from"./chat-CoV7TW02.js";import{c as Pe}from"./index-CQwTOyAC.js";import{S as Ve,a as Ne}from"./index-ChLzCBr1.js";import{R as Ye}from"./index-CFQQkabk.js";import{_ as je}from"./Search-1aGcXLAr.js";import{_ as Fe}from"./index-ifJinQLe.js";import"./axios-BZ84_VUH.js";import"./qs-DB0tj3pA.js";import"./crypto-js-fJpLWOEv.js";import"./FormItemContext-BbeLgxF6.js";import"./Checkbox-DoUvt9dJ.js";import"./index-CX89AYWF.js";import"./index-DE8nMz1m.js";import"./colors-BsGfXzR0.js";import"./CheckOutlined-tNTNjiBd.js";import"./Trigger-DAizGHX4.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./shallowequal-CthuG9FU.js";import"./index-DxTO0j69.js";import"./move-BNsvENtF.js";import"./slide-C8pAsQDb.js";import"./index-2d7y8GiQ.js";import"./index-DxizqJ3O.js";import"./index-9KxKXuVw.js";import"./useEventBus-BwH2zX88.js";import"./DownOutlined-BfzuAtqc.js";import"./SearchOutlined-BAHqMa3J.js";import"./Input-Bfzy8tJK.js";import"./inputProps-B3PFVydJ.js";import"./isPlainObject-BRAWLrZZ.js";const Ge={class:"zm-date"},We={class:"date-btn"},Qe={class:"date-content"},Ze={__name:"date",props:{datekey:{type:String,default:"1"}},emits:["dateChange"],setup(r,{emit:E}){const w=r,i=g(1),u=E;let S=se([{label:"今日",value:!0,key:2,start_time:D().startOf("day"),end_time:D().endOf("day")},{label:"昨日",value:!1,key:3,start_time:D().subtract(1,"day").startOf("day"),end_time:D().startOf("day").subtract(1,"millisecond")},{label:"近7日",value:!1,key:4,start_time:D().subtract(6,"day").startOf("day"),end_time:D().endOf("day").subtract(1,"millisecond")}]);const m=g(null),a=g(null),s=g([]),y=v=>v>=D().subtract(0,"day"),I=()=>{let v=i.value,t=null;S.forEach(h=>{h.key==v&&(t=h)}),t&&(s.value=[t.start_time,t.end_time],m.value=t.start_time.unix(),a.value=t.end_time.unix()),H()},L=v=>{const t=D(v[0]).startOf("day");if(D(v[1]).endOf("day").diff(t,"days")>29)s.value[0]=v[0].startOf("day"),s.value[1]=t.add(29,"days").endOf("day"),m.value=s.value[0].unix(),a.value=s.value[1].unix(),Le.error("最多只能选择30天");else{const b=D(v[0]).startOf("day").unix(),l=D(v[1]).endOf("day").unix();s.value=v,m.value=b,a.value=l}i.value=1,H()},H=()=>{u("dateChange",{start_time:m.value,end_time:a.value})};return W(()=>{i.value=parseInt(w.datekey),I()}),Q(()=>w.datekey,(v,t)=>{i.value=parseInt(w.datekey.split("-")[0]),I()}),(v,t)=>{const h=Be,b=Re,l=Oe;return c(),d("div",Ge,[e("div",We,[f(b,{value:i.value,"onUpdate:value":t[0]||(t[0]=_=>i.value=_),onChange:I},{default:$(()=>[(c(!0),d(O,null,P(A(S),_=>(c(),oe(h,{class:"date-btn-button",value:_.key,key:_.key},{default:$(()=>[M(x(_.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),e("div",Qe,[f(l,{value:s.value,"onUpdate:value":t[1]||(t[1]=_=>s.value=_),onChange:L,format:"YYYY-MM-DD",disabledDate:y,allowClear:!1},null,8,["value"])])])}}},Z=r=>(V("data-v-e837d5ae"),r=r(),N(),r),Je={key:0,class:"empty-box"},Ke=Z(()=>e("img",{src:le,alt:""},null,-1)),Xe=Z(()=>e("div",{class:"title"},"暂无结果，请重试",-1)),et=[Ke,Xe],tt=["onClick"],st={class:"user-item-left"},ot=["src"],at={class:"user-item-right"},lt={class:"user-name-box"},nt={class:"user-name"},rt={class:"user-timer"},ct={class:"user-info"},it={class:"user-source-box"},ut=Z(()=>e("div",{class:"user-source-title"},"来自：",-1)),dt={class:"user-source-content"},_t={__name:"user",props:{userList:{type:Array,default:[]}},emits:["userClick","userScroll","userScrollStart","userScrollEnd"],setup(r,{emit:E}){const w=g(null),i=r,u=E,S=g([]),m=g({}),a=t=>{m.value=t,u("userClick",t)},s={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let y=null;function I(t){y&&(clearTimeout(y),y=null),y=setTimeout(()=>{s.scrollTop-t.target.scrollTop>0&&(s.scrollDirection="up"),s.scrollTop-t.target.scrollTop<0&&(s.scrollDirection="down"),s.scrollTop=t.target.scrollTop,s.scrollHeight=t.target.scrollHeight,s.clientHeight=t.target.clientHeight,u("userScroll",{...s}),Math.abs(s.scrollTop)<=s.scrollStartDiff+100&&s.scrollDirection==="up"&&L(),Math.abs(s.scrollHeight-s.scrollTop-s.clientHeight)<=s.scrollEndDiff&&s.scrollDirection==="down"&&H()},50)}function L(){i.userList.length!=0&&u("userScrollStart",{msg:i.userList[0]})}function H(){i.userList.length!=0&&u("userScrollEnd",{msg:i.userList[i.userList.length-1]})}Q(()=>i.userList,t=>{S.value=t,S.value.length>0&&S.value.length<=20&&(a(S.value[0]),m.value=S.value[0])},{immediate:!0});const v=t=>{let h;switch(t){case"yun_h5":h="WebAPP";break;case"yun_pc":h="嵌入网站";break}return h};return W(()=>{S.value=i.userList}),(t,h)=>{const b=ae("ftime");return c(),d("div",{class:"user-content",ref_key:"scrollUserBoxRef",ref:w,onScroll:I},[S.value.length===0?(c(),d("div",Je,et)):(c(!0),d(O,{key:1},P(S.value,l=>(c(),d("div",{class:De(["user-item",{active:l.openid==m.value.openid}]),onClick:_=>a(l),key:l.session_id},[e("div",st,[e("img",{class:"user-img",src:l.avatar,alt:""},null,8,ot)]),e("div",at,[e("div",lt,[e("div",nt,x(l.name),1),G((c(),d("div",rt,[M(x(l.last_chat_time),1)])),[[b,"MM-DD HH:mm"]])]),e("div",ct,x(l.last_chat_message),1),e("div",it,[ut,e("div",dt,x(v(l.app_type)),1)])])],10,tt))),128))],544)}}},pt=Y(_t,[["__scopeId","data-v-e837d5ae"]]),ne=r=>(V("data-v-9b2c823e"),r=r(),N(),r),mt={class:"message-box"},vt={class:"message-top-box"},ft={class:"message-top-title"},gt={key:0,class:"message-top-source"},ht={class:"message-list"},yt={key:0,class:"empty-box"},St=ne(()=>e("img",{src:le,alt:""},null,-1)),bt=ne(()=>e("div",{class:"title"},"暂无结果，请重试",-1)),kt=[St,bt],Tt=["id"],xt={class:"itme-right"},$t={class:"message-info"},Dt={class:"item-body"},wt={class:"message-content"},Ct={class:"user-avatar-box"},Et=["src"],It=["id"],Lt={class:"itme-left"},Ht=["src"],Mt={class:"itme-right"},Bt={class:"message-info"},Rt={class:"item-body"},Ot={key:0,class:"message-content"},At=["innerHTML"],Ut={key:2,class:"message-content"},qt=["src"],zt={key:2,class:"loading-box"},Pt={__name:"message-list",props:{messages:{type:Array,default:()=>[]},robotInfo:{type:Object,default:()=>{}},isEmpty:{type:Boolean,default:()=>!1},sessionSource:{type:String,default:()=>null},channelItem:{type:Array,default:()=>[]}},emits:["scroll","scrollStart","scrollEnd"],setup(r,{expose:E,emit:w}){const i=w,u=r,S=g(!1),m=g(null),a={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let s=null,y=!1;const I=l=>{let _;for(let o=0;o<u.channelItem.length;o++){const k=u.channelItem[o];k.app_type===l&&(_=k.app_name)}return _};function L(l){y||(s&&(clearTimeout(s),s=null),s=setTimeout(()=>{a.scrollTop-l.target.scrollTop>0&&(a.scrollDirection="up"),a.scrollTop-l.target.scrollTop<0&&(a.scrollDirection="down"),a.scrollTop=l.target.scrollTop,a.scrollHeight=l.target.scrollHeight,a.clientHeight=l.target.clientHeight,i("scroll",{...a}),Math.abs(a.scrollTop)<=a.scrollStartDiff&&a.scrollDirection==="up"&&H(),Math.abs(a.scrollHeight-a.scrollTop-a.clientHeight)<=a.scrollEndDiff&&a.scrollDirection==="down"&&v()},100))}function H(){u.messages.length!=0&&i("scrollStart",{msg:u.messages[0]})}function v(){u.messages.length!=0&&i("scrollEnd",{msg:u.messages[u.messages.length-1]})}const t=()=>{m.value&&ee(()=>{y=!0,m.value.scrollTop=m.value.scrollHeight+1,setTimeout(()=>{a.scrollTop=m.value.scrollTop,y=!1},50)})};function h(l,_){ee(()=>{y=!0,_||(_="top");let o=m.value,k=document.querySelector("#msg-"+l);k&&(_=="top"?o.scrollTop=k.offsetTop:o.scrollTop=k.offsetTop-o.clientHeight+k.clientHeight),setTimeout(()=>{a.scrollTop=m.value.scrollTop,y=!1},50)})}function b(){a.scrollTop=0,a.scrollDirection=""}return E({scrollToBottom:t,scrollToMessage:h,resetScroll:b}),(l,_)=>{const o=Ue,k=ae("viewer");return c(),d("div",mt,[e("div",vt,[e("div",ft,x(u.robotInfo.robot_name),1),r.sessionSource?(c(),d("div",gt,"("+x(I(r.sessionSource))+")",1)):R("",!0)]),e("div",{class:"message-list-wrapper",ref_key:"scrollBoxRef",ref:m,onScroll:L},[e("div",ht,[u.isEmpty||!u.messages?(c(),d("div",yt,kt)):(c(!0),d(O,{key:1},P(u.messages,p=>(c(),d(O,{key:p.uid},[p.is_customer==1?(c(),d("div",{key:0,class:"message-item user-message",id:"msg-"+p.uid},[e("div",xt,[e("div",$t,[e("span",null,x(A(te)(p.create_time)),1),e("span",null,x(p.name),1)]),e("div",Dt,[e("div",wt,x(p.content),1)])]),e("div",Ct,[e("img",{class:"user-avatar",src:p.avatar},null,8,Et)])],8,Tt)):(c(),d("div",{key:1,class:"message-item robot-message",id:"msg-"+p.uid},[e("div",Lt,[f(o,{size:"small",spinning:p.loading},{default:$(()=>[e("img",{class:"robot-avatar",src:p.robot_avatar},null,8,Ht)]),_:2},1032,["spinning"])]),e("div",Mt,[e("div",Bt,[e("span",null,x(A(te)(p.create_time)),1),e("span",null,x(p.name),1)]),e("div",Rt,[p.msg_type==1?G((c(),d("div",Ot,[f(Ae,{content:p.content},null,8,["content"])])),[[k]]):R("",!0),p.msg_type==2?(c(),d("div",{key:1,class:"message-content",innerHTML:p.menu_json.content},null,8,At)):R("",!0),p.msg_type==3?(c(),d("div",Ut,[G(e("img",{class:"msg-img",src:p.content,alt:""},null,8,qt),[[k]])])):R("",!0)])])],8,It))],64))),128)),S.value?(c(),d("div",zt,[f(o)])):R("",!0)])],544)])}}},Vt=Y(Pt,[["__scopeId","data-v-9b2c823e"]]),re=r=>(V("data-v-c117c73a"),r=r(),N(),r),Nt={class:"team-members-pages"},Yt={class:"set-model"},jt=re(()=>e("div",{class:"label set-model-label"},"渠道：",-1)),Ft={class:"set-model-body"},Gt={class:"set-date"},Wt=re(()=>e("div",{class:"label set-date-label"},[e("span",null,"日期：")],-1)),Qt={class:"set-date-body"},Zt={class:"set-name"},Jt={class:"set-reset"},Kt={class:"list-box"},Xt={class:"user-box"},es={class:"records-box"},ts={__name:"session-record",setup(r){const E=g(!1),w=Ie(),i=we(),u=i.query,S=qe(),{robotInfo:m}=S,a=ze(),{messageList:s}=Ce(a);let y=!0;const{createMsg:I,onGetChatMessage:L,getRecordList:H,getChannelList:v}=a,t=g(null),h=g([]),b=g([]),l=g(""),_=g("1"),o=se({robot_id:u.id,app_type:"all",app_id:"",start_time:"",end_time:"",name:"",page:1,size:20}),k=g(!1),p=n=>{o.start_time=n.start_time,o.end_time=n.end_time,F()},ce=()=>{o.app_type="all",o.name="",o.page=1,_.value="1-"+Math.random()},U=g(!1),j=g(!1),ie=async()=>{let n=J();j.value=!0,await Pe(n),U.value=!0,j.value=!1},ue=()=>{w.push({path:"/robot/config/export-record",query:u})},F=()=>{o.page=1,K()},de=n=>{o.app_type=n,F()},_e=()=>{},pe=n=>{l.value=n.app_type,Se(n)},me=async()=>{},ve=()=>{k.value&&(o.page++,K())},fe=async()=>{y=!1;let n=s.value[0].uid;await L()&&he(n)},ge=()=>{t.value&&y&&t.value.scrollToBottom()},he=n=>{t.value&&t.value.scrollToMessage(n)},ye=()=>{t.value&&t.value.resetScroll()};let q=null;const Se=async n=>{y=!0;let B={robot_key:(i.query||{}).robot_key,avatar:n.avatar,name:n.name,nickname:n.name,is_background:1,openid:n.openid};ye(),await I(B),q&&(clearTimeout(q),q=null),q=setTimeout(async()=>{await L()&&ge()},100)},be=async()=>{const n=await v();h.value=[{app_type:"all",app_name:"全部渠道"},...n.data]},J=()=>{let n={robot_id:o.robot_id,start_time:o.start_time,end_time:o.end_time,name:o.name,page:o.page,size:o.size};return o.app_type!=="all"&&(n.app_type=o.app_type),n},K=async()=>{let n=J(),T=await H(n),B=T.data.list||[];o.page==1&&(b.value=[]),b.value=[...b.value,...B],E.value=b.value.length==0,k.value=T.data.has_more};return Q(()=>s.value,()=>{}),W(async()=>{be()}),Ee(()=>{}),(n,T)=>{const B=Ne,X=Ve,ke=je,z=He,Te=Fe,xe=Ye,$e=Me;return c(),d("div",Nt,[f(Te,{justify:"flex-start",class:"screen-box"},{default:$(()=>[e("div",Yt,[jt,e("div",Ft,[f(X,{value:o.app_type,"onUpdate:value":T[0]||(T[0]=C=>o.app_type=C),placeholder:"全部渠道",onChange:de,style:{width:"200px"}},{default:$(()=>[(c(!0),d(O,null,P(h.value,C=>(c(),oe(B,{key:C.app_type,value:C.app_type},{default:$(()=>[e("span",null,x(C.app_name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])])]),e("div",Gt,[Wt,e("div",Qt,[f(Ze,{onDateChange:p,datekey:_.value},null,8,["datekey"])])]),e("div",Zt,[f(ke,{value:o.name,"onUpdate:value":T[1]||(T[1]=C=>o.name=C),placeholder:"请输入用户名称搜索",style:{width:"200px"},onSearch:F},null,8,["value"])]),e("div",Jt,[f(z,{onClick:ce},{default:$(()=>[M("重置")]),_:1}),f(z,{onClick:ie,loading:j.value},{default:$(()=>[M("导出")]),_:1},8,["loading"])])]),_:1}),e("div",Kt,[e("div",Xt,[f(pt,{userList:b.value,onUserScrollStart:me,onUserScrollEnd:ve,onUserClick:pe},null,8,["userList"])]),e("div",es,[f(Vt,{ref_key:"messageListRef",ref:t,isEmpty:E.value,messages:A(s),robotInfo:A(m),channelItem:h.value,sessionSource:l.value,onScrollStart:fe,onScrollEnd:_e},null,8,["isEmpty","messages","robotInfo","channelItem","sessionSource"])])]),f($e,{open:U.value,"onUpdate:open":T[3]||(T[3]=C=>U.value=C),title:null,footer:null,width:640},{default:$(()=>[f(xe,{status:"success",title:"导出任务创建成功","sub-title":"系统会在后台导出。导出数据量越大，耗时越久。您可以稍后点击导出记录查看并下载导出的文件。"},{extra:$(()=>[f(z,{style:{"margin-right":"16px"},onClick:T[2]||(T[2]=C=>U.value=!1)},{default:$(()=>[M("知道了")]),_:1}),f(z,{onClick:ue,type:"primary"},{default:$(()=>[M("去下载")]),_:1})]),_:1})]),_:1},8,["open"])])}}},ss=Y(ts,[["__scopeId","data-v-c117c73a"]]),os=r=>(V("data-v-bcc51f14"),r=r(),N(),r),as={class:"user-model-page"},ls=os(()=>e("div",{class:"page-title"},"会话记录",-1)),ns={class:"list-wrapper"},rs={__name:"index",setup(r){return(E,w)=>(c(),d("div",as,[ls,e("div",ns,[f(ss)])]))}},Gs=Y(rs,[["__scopeId","data-v-bcc51f14"]]);export{Gs as default};
