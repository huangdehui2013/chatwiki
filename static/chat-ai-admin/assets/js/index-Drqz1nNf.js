import{f as he,e as w,B as Y,w as Z,x as te,M as c,N as p,k as i,S as y,Y as j,l as ve,u as K,W as t,Q as P,F as V,$ as H,a6 as le,a7 as J,Z as q,aa as fe,a1 as re,a2 as ce,X as ge,U as ye,aq as be,K as de,a9 as ne,D as ke}from"./vue-chunks-DkYK5AuX.js";import{k as ie,du as xe,B as Se,d as ae,b as G,bm as X,d7 as $e,a8 as Le,a9 as we,ab as Ae,dv as Ce,dw as Oe,w as Me,bt as Re,br as De,bs as je}from"../../index-CuFzRDH0.js";import{c as _e}from"./index-njT3lQ6A.js";import{M as Ie}from"./model-select-CidLVLk0.js";import"./index-NJlqtEGH.js";import{R as Ne,_ as qe}from"./RadioButton-ouyuU7LQ.js";import{S as Ue}from"./SettingOutlined-BLoICRkv.js";import{Q}from"./QuestionCircleOutlined-DySDEe_b.js";import{_ as Be}from"./TextArea-DnYx9N6z.js";import{_ as me}from"./index-DVObnatt.js";import{_ as Te}from"./index-D3KKcNwj.js";import{_ as ze}from"./index-BDEXdwqG.js";import{_ as Ee}from"./index-D2ta3gNn.js";import{S as Fe,a as Ke,_ as Ve}from"./index-B9b8kVtF.js";import{_ as Pe}from"./index-BpoJbMc_.js";import{M as Je}from"./index-BMSQkwth.js";import"./index-5PrSJtCq.js";import{I as He}from"./Input-DlD3j6GW.js";import{u as Qe}from"./useEventBus-BruxLnOi.js";import{C as Ye,_ as Ge}from"./index-CvnBYLiG.js";import{_ as We}from"./index-DlQD4MAZ.js";import"./axios-Cm0UX6qg.js";import"./qs-g-qVsYXK.js";import"./crypto-js-CsNcoEfj.js";import"./dayjs-CHX5mXCJ.js";import"./index-B3CceHui.js";import"./FormItemContext-CG4o3aCY.js";import"./Checkbox-CHV8yuJS.js";import"./index-DpON8wvi.js";import"./index-CNYsll_x.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./inputProps-CIG3Q6HA.js";import"./Trigger-qqJEyN1K.js";import"./colors-TmzmwKXv.js";import"./UpOutlined-CmeybyPL.js";import"./DownOutlined-xHwfZhzl.js";import"./slide--PTaLm6c.js";import"./CheckOutlined-Nu5wJEo2.js";import"./SearchOutlined-2-sBVYkv.js";import"./move-CfeIRdjT.js";import"./Search-BjDfM7wD.js";import"./isPlainObject-B3m2dvNk.js";import"./Password-B-_rMC_p.js";import"./index-DncdWYWk.js";import"./css-DbBMd65r.js";import"./LeftOutlined-BL6rtvtT.js";import"./RightOutlined-C7Gymx4e.js";const U=_=>(re("data-v-5a852543"),_=_(),ce(),_),Xe={class:"prompt-form"},Ze=U(()=>t("div",{class:"prompt-form-label"},"模型设置",-1)),et={class:"prompt-form-item"},tt=U(()=>t("div",{class:"prompt-form-item-label"},[t("span",{style:{color:"red"}},"* "),t("span",null,"模型选择")],-1)),at={class:"prompt-form-item"},st=U(()=>t("div",{class:"prompt-form-item-label"},[t("span",{style:{color:"red"}},"* "),t("span",null,"提示词")],-1)),ot={class:"prompt-form-item-content"},nt={key:0,class:"prompt-form-item-tip"},it={class:"prompt-form-item"},lt={class:"prompt-form-item-label"},rt=U(()=>t("span",null,"温度",-1)),ct={class:"form-item-body"},dt={class:"number-box"},_t={class:"number-slider-box"},mt={class:"number-input-box"},ut={class:"prompt-form-item"},pt={class:"prompt-form-item-label"},ht=U(()=>t("span",null,"最大token",-1)),vt=U(()=>t("div",null,"问题+答案的最大token数，如果出现回答被截断，可调高此值",-1)),ft={class:"form-item-body"},gt={class:"number-box"},yt={class:"number-slider-box"},bt={class:"number-input-box"},kt={class:"recall-settings-box"},xt={class:"form-box prompt-form"},St=U(()=>t("div",{class:"prompt-form-label"},"召回设置",-1)),$t={class:"form-item is-required"},Lt=U(()=>t("div",{class:"form-item-label"},[t("span",null,"检索模式")],-1)),wt={class:"form-item-body"},At={class:"retrieval-mode-items"},Ct=["onClick"],Ot={class:"retrieval-mode-title"},Mt={class:"title-text"},Rt={class:"retrieval-mode-desc"},Dt={class:"form-item"},jt={class:"form-item-label"},It=U(()=>t("span",null,"Top K ",-1)),Nt={class:"form-item-body"},qt={class:"number-box"},Ut={class:"number-slider-box"},Bt={class:"number-input-box"},Tt={key:0,class:"form-item"},zt={class:"form-item-label"},Et=U(()=>t("span",null,"相似度阈值 ",-1)),Ft={class:"form-item-body"},Kt={class:"number-box"},Vt={class:"number-slider-box"},Pt={class:"number-input-box"},Jt={class:"form-item"},Ht={class:"form-item-label"},Qt=U(()=>t("span",null,"Rerank模型 ",-1)),Yt={key:0,class:"form-item-body"},Gt=["src"],Wt=he({__name:"search-drawer",props:{librarySearchData:{type:Object,default:null},defaultLibrarySearchData:{type:Object,default:null}},setup(_){const o=_,A=w([{iconName:"mix-icon",title:"混合检索",value:1,isRecommendation:!0,desc:"同时执行三种检索模式，使用RRF算法进行排序，从三种查询结果中选择更匹配用户问题的结果。混合检索兼顾语义相似性与逻辑关联性，通过互补优势提升检索的准确性和生成结果的可信度"},{iconName:"vector-icon",title:"向量检索",value:2,desc:"将用户提问转成向量之后与知识库分段匹配相似度，返回相似度高的结果。向量检索擅长语义相似性匹配和大规模非结构化数据处理，但缺乏可解释性和精准关系验证"},{iconName:"graph-icon",title:"知识图谱检索",value:4,desc:"通过关系推理，检索出与用户问题相关联的知识。知识图谱检索擅长精准的实体关系推理和逻辑验证，但对非结构化文本和语义模糊查询支持较弱"},{iconName:"search-check-icon",title:"全文检索",value:3,desc:"通过分词匹配文档中的词汇，返回包含这些词汇的文本片段"}]),D=w(!1),e=Y({use_model:"",model_config_id:"",prompt_type:"0",prompt:"",temperature:.5,max_token:2e3,context_pair:0,search_type:1,top_k:5,size:0,similarity:.4,rerank_status:0,rerank_use_model:void 0,rerank_model_config_id:void 0}),R=w([]),C=()=>{_e({model_type:"RERANK"}).then(n=>{let a=n.data||[];R.value=a.map($=>({id:$.model_config.id,name:$.model_info.model_name,icon:$.model_info.model_icon_url,children:$.model_info.rerank_model_list}))})},L=(n,a)=>{e.use_model=a.modelName,e.model_config_id=a.modelId,b()},B=w([]),F=n=>{var a,$,T,E,r;if(B.value=n,!((a=o.librarySearchData)!=null&&a.model_config_id)||!(($=o.librarySearchData)!=null&&$.use_model)){if(B.value.length>0){let h=B.value[0];if(h){let k=h.children[0];e.use_model=k.name,e.model_config_id=k.model_config_id}}}else e.use_model=((T=o.librarySearchData)==null?void 0:T.use_model)+"$$",e.model_config_id=((E=o.librarySearchData)==null?void 0:E.model_config_id)+"$$",e.use_model=e.use_model.split("$$")[0],e.model_config_id=(r=o.librarySearchData)==null?void 0:r.model_config_id.split("$$")[0]},S=n=>{e.search_type=n,b()},l=(n,a)=>{e.rerank_model_config_id=a.rerank_model_config_id,b()},m=n=>{let a={...n};a.max_token=parseFloat(a.max_token),a.temperature=parseFloat(a.temperature),a.context_pair=parseFloat(a.context_pair),a.search_type=parseFloat(a.search_type),a.rerank_status=parseFloat(a.rerank_status),a.similarity=parseFloat(a.similarity),a.top_k=parseFloat(a.size),a.rerank_use_model===""&&(a.rerank_use_model=void 0),Object.keys(a).forEach($=>{e[$]=a[$]})},b=()=>{let n={...e};if(!n.prompt&&e.prompt_type=="1")return ie.error("请输入自定义提示词");(e.search_type==3||e.search_type==4)&&delete n.similarity,e.prompt_type=="0"&&delete n.prompt,n.size=n.top_k,xe(n).then(a=>{ie.success("保存成功")})},f=n=>{},d=()=>{D.value=!0};return Z(()=>o.librarySearchData,n=>{var a;(a=o.librarySearchData)!=null&&a.id&&m({...fe(o.librarySearchData)})}),te(()=>{C()}),(n,a)=>{const $=Se,T=Ne,E=qe,r=Be,h=me,k=Te,v=ze,O=ae,x=Ee,I=Fe,u=Ke,M=Ve,N=Pe;return c(),p(V,null,[i($,{onClick:d,icon:ve(K(Ue))},{default:y(()=>[j("搜索设置")]),_:1},8,["icon"]),i(N,{open:D.value,"onUpdate:open":a[14]||(a[14]=s=>D.value=s),class:"custom-class","root-class-name":"root-class-name",title:"搜索设置",width:"472",placement:"right",onAfterOpenChange:f},{default:y(()=>[t("div",Xe,[Ze,t("div",et,[tt,i(Ie,{modelType:"LLM",modeName:e.use_model,"onUpdate:modeName":a[0]||(a[0]=s=>e.use_model=s),modeId:e.model_config_id,"onUpdate:modeId":a[1]||(a[1]=s=>e.model_config_id=s),style:{width:"100%"},onLoaded:F,onChange:L},null,8,["modeName","modeId"])]),t("div",at,[st,i(E,{value:e.prompt_type,"onUpdate:value":a[2]||(a[2]=s=>e.prompt_type=s),onChange:b},{default:y(()=>[i(T,{value:"0"},{default:y(()=>[j("默认提示词")]),_:1}),i(T,{value:"1"},{default:y(()=>[j("自定义提示词")]),_:1})]),_:1},8,["value"]),t("div",ot,[e.prompt_type=="0"?(c(),p("div",nt,"将提交的内容进行智能总结,不要随意发挥")):(c(),P(r,{key:1,onBlur:b,maxLength:500,style:{height:"80px"},value:e.prompt,"onUpdate:value":a[3]||(a[3]=s=>e.prompt=s),placeholder:"请输入自定义提示词"},null,8,["value"]))])]),t("div",it,[t("div",lt,[rt,i(h,null,{title:y(()=>[j("温度越低，回答越严谨。温度越高，回答越发散。")]),default:y(()=>[i(K(Q),{class:"question-icon"})]),_:1})]),t("div",ct,[t("div",dt,[t("div",_t,[i(k,{onBlur:b,class:"custom-slider",value:e.temperature,"onUpdate:value":a[4]||(a[4]=s=>e.temperature=s),min:0,max:2,step:.1},null,8,["value"])]),t("div",mt,[i(v,{onBlur:b,value:e.temperature,"onUpdate:value":a[5]||(a[5]=s=>e.temperature=s),min:0,max:2,step:.1},null,8,["value"])])])])]),t("div",ut,[t("div",pt,[ht,i(h,null,{title:y(()=>[vt]),default:y(()=>[i(K(Q),{class:"question-icon"})]),_:1})]),t("div",ft,[t("div",gt,[t("div",yt,[i(k,{onBlur:b,class:"custom-slider",value:e.max_token,"onUpdate:value":a[6]||(a[6]=s=>e.max_token=s),min:0,max:100*1024},null,8,["value"])]),t("div",bt,[i(v,{onBlur:b,value:e.max_token,"onUpdate:value":a[7]||(a[7]=s=>e.max_token=s),min:0,max:100*1024},null,8,["value"])])])])])]),t("div",kt,[t("div",xt,[St,t("div",$t,[Lt,t("div",wt,[t("div",At,[(c(!0),p(V,null,H(A.value,s=>(c(),p("div",{class:le(["retrieval-mode-item",{active:e.search_type==s.value}]),key:s.value,onClick:z=>S(s.value)},[e.search_type==s.value?(c(),P(O,{key:0,class:"check-arrow",name:"check-arrow-filled"})):J("",!0),t("div",Ot,[i(O,{name:s.iconName,class:"title-icon"},null,8,["name"]),t("span",Mt,q(s.title),1),s.isRecommendation?(c(),P(O,{key:0,class:"recommendation-icon",name:"recommendation"})):J("",!0)]),t("div",Rt,q(s.desc),1)],10,Ct))),128))])])]),t("div",Dt,[t("div",jt,[It,i(h,null,{title:y(()=>[j("最多从知识库中召回分段数，最低为1，最高为10。召回分段数越多，消耗的token也会越多。")]),default:y(()=>[i(K(Q),{class:"question-icon"})]),_:1})]),t("div",Nt,[t("div",qt,[t("div",Ut,[i(k,{onBlur:b,class:"custom-slider",value:e.top_k,"onUpdate:value":a[8]||(a[8]=s=>e.top_k=s),min:1,max:10},null,8,["value"])]),t("div",Bt,[i(v,{onBlur:b,value:e.top_k,"onUpdate:value":a[9]||(a[9]=s=>e.top_k=s),min:1,max:10},null,8,["value"])])])])]),e.search_type!=3&&e.search_type!=4?(c(),p("div",Tt,[t("div",zt,[Et,i(h,null,{title:y(()=>[j("召回时，只会召回相似度大于阈值的文本分段。取值范围：0~1，阈值越大回答的越准确，建议不超过0.9")]),default:y(()=>[i(K(Q),{class:"question-icon"})]),_:1})]),t("div",Ft,[t("div",Kt,[t("div",Vt,[i(k,{onBlur:b,class:"custom-slider",value:e.similarity,"onUpdate:value":a[10]||(a[10]=s=>e.similarity=s),min:0,max:1,step:.01},null,8,["value"])]),t("div",Pt,[i(v,{onBlur:b,value:e.similarity,"onUpdate:value":a[11]||(a[11]=s=>e.similarity=s),min:0,max:1,step:.01},null,8,["value"])])])])])):J("",!0),t("div",Jt,[t("div",Ht,[Qt,i(h,null,{title:y(()=>[j("召回时，只会召回相似度大于阈值的文本分段。取值范围：0~1，阈值越大回答的越准确，建议不超过0.9")]),default:y(()=>[i(K(Q),{class:"question-icon"})]),_:1}),i(x,{onChange:b,style:{float:"right"},checkedValue:1,unCheckedValue:0,checked:e.rerank_status,"onUpdate:checked":a[12]||(a[12]=s=>e.rerank_status=s),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),e.rerank_status==1?(c(),p("div",Yt,[i(M,{value:e.rerank_use_model,"onUpdate:value":a[13]||(a[13]=s=>e.rerank_use_model=s),placeholder:"请选择Rerank模型",onChange:l,style:{width:"100%"}},{default:y(()=>[(c(!0),p(V,null,H(R.value,s=>(c(),P(u,{key:s.id},{label:y(()=>[t("span",null,[t("img",{class:"model-icon",src:s.icon,alt:""},null,8,Gt)])]),default:y(()=>[(c(!0),p(V,null,H(s.children,z=>(c(),P(I,{value:z,rerank_model_config_id:s.id,key:z},{default:y(()=>[t("span",null,q(z),1)]),_:2},1032,["value","rerank_model_config_id"]))),128))]),_:2},1024))),128))]),_:1},8,["value"])])):J("",!0)])])])]),_:1},8,["open"])],64)}}}),Xt=G(Wt,[["__scopeId","data-v-5a852543"]]),Zt={class:"no-data"},ea={class:"no-data-text"},ta={__name:"list-empty",props:{text:{type:String,default:"暂无数据"},size:{type:[Number,String],default:100}},setup(_){const o=_;return(A,D)=>{const e=ae;return c(),p("div",Zt,[i(e,{name:"empty-document",style:ge({"font-size":`${o.size}px`,color:"white"})},null,8,["style"]),t("div",ea,[ye(A.$slots,"default",{},()=>[j(q(o.text),1)],!0)])])}}},aa=G(ta,[["__scopeId","data-v-f4fa2763"]]),ee=_=>(re("data-v-cb12478c"),_=_(),ce(),_),sa={class:"search-box-warpper"},oa={class:"search-box-content"},na={class:"search-set-box"},ia={key:0,class:"search-content"},la=ee(()=>t("div",{class:"search-label"},"知识搜索",-1)),ra=ee(()=>t("div",{class:"search-tip"},"快速搜索所选择的知识库中内容",-1)),ca={class:"search-input-box"},da={key:1,class:"search-content search-main"},_a={class:"search-input-box"},ma=ee(()=>t("div",null,[t("p",{style:{color:"#262626","font-size":"16px","font-weight":"600","line-height":"24px"}},"暂无任何内容")],-1)),ua={key:1,class:"search-content-box"},pa={class:"search-tip-box"},ha={key:0,class:"tip"},va={key:1,class:"tip complete"},fa={key:0,class:"container"},ga=be('<div class="rect-container rect1" data-v-cb12478c><div class="rect" data-v-cb12478c></div></div><div class="rect-container rect2" data-v-cb12478c><div class="rect" data-v-cb12478c></div></div><div class="rect-container rect3" data-v-cb12478c><div class="rect" data-v-cb12478c></div></div>',3),ya=[ga],ba={key:1,class:"intelligent-answer"},ka=["innerHTML"],xa={key:1},Sa={class:"section-box"},$a=ee(()=>t("div",{class:"tips"},[t("div",{class:"tips-text"},"以上内容由大模型生成"),t("div",{class:"tips-line"})],-1)),La={key:0,class:"section-label"},wa={class:"section-item-nav"},Aa={class:"section-item-nav-left"},Ca=["onClick"],Oa={key:0},Ma={class:"section-item-nav-right"},Ra=["innerHTML"],Da={__name:"search-box",props:{librarySearchData:{type:Object,default:null},messageObj:{type:Object,default:null},library_ids:{type:Array,default:()=>[]},isError:{type:Boolean,default:!1}},emits:["search","defaultParmas"],setup(_,{expose:o,emit:A}){const D=A,e=_,R=new Je({html:!0,linkify:!0,typographer:!0}),C=w(""),L=w(""),B=w(!1),F=w(!1),S=w({});Z(()=>e.messageObj.content,()=>{C.value=R.render(e.messageObj.content)}),Z(()=>e.messageObj.error,r=>{r&&X(r)});const l=async()=>{if(!e.library_ids.length)return X("请在左侧的知识库选择项内至少选择一个知识库");if(!L.value)return X("请输入消息内容");a(),D("search",L.value),B.value=!0};function m(r){return r.match(/^-?\d+(?:\.\d{0,2})?/)[0]}const b=(r,h)=>{if(!r||!h.trim())return r;const k=h.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),v=new RegExp(`(${k})`,"gi");return r.replace(v,'<span class="highlight">$1</span>')},f=r=>{if(!r.file_name){window.open(`#/library/details/categary-manage?id=${r.library_id}`);return}window.open(`#/library/preview?id=${r.file_id}`)},d=Y({rerank_status:"",rerank_use_model:"",prompt:"",model_config_id:"",use_model:"",temperature:.5,max_token:2e3,similarity:.4,search_type:1}),n=w({}),a=()=>{let r={model_config_id:e.librarySearchData.model_config_id||d.model_config_id,use_model:e.librarySearchData.use_model||d.use_model,temperature:e.librarySearchData.temperature||d.temperature,max_token:e.librarySearchData.max_token||d.max_token,size:200,similarity:e.librarySearchData.similarity||d.similarity,search_type:e.librarySearchData.search_type||d.search_type,question:L.value,id:e.library_ids.join(","),recall_type:1};e.librarySearchData.rerank_status&&(r.rerank_status=e.librarySearchData.rerank_status),e.librarySearchData.rerank_use_model&&(r.rerank_use_model=e.librarySearchData.rerank_use_model),e.librarySearchData.prompt&&(r.prompt=e.librarySearchData.prompt),e.librarySearchData.rerank_status==1&&(r.rerank_model_config_id=e.librarySearchData.rerank_model_config_id),F.value=!0,n.value=Object.assign(r),D("defaultParmas",n.value),$e(r).then(h=>{S.value=h.data}).catch(()=>{}).finally(()=>{F.value=!1})},$=w([]);function T(r,h,k){const v=new Set(r.map(O=>O.model_define));return h.filter(O=>{let x=O[k];v.has(x)&&r.filter(I=>{if(I.model_define==x)return I.children=we(I.children,O.children),!1})}),r}const E=async()=>{await _e({model_type:"LLM"}).then(r=>{let h=r.data||[],k=[];$.value=h.map(v=>{k=[];for(let O=0;O<v.model_info.llm_model_list.length;O++){const x=v.model_info.llm_model_list[O];k.push({name:x,deployment_name:v.model_config.deployment_name,model_config_id:v.model_config.id,model_define:v.model_info.model_define})}return{model_config_id:v.model_config.id,name:v.model_info.model_name,model_define:v.model_info.model_define,icon:v.model_info.model_icon_url,children:k,deployment_name:v.model_config.deployment_name}}),$.value=T(Le($.value,"model_define"),$.value,"model_define")})};return te(async()=>{var r,h,k,v,O;if(await E(),!((r=e.librarySearchData)!=null&&r.model_config_id)||!((h=e.librarySearchData)!=null&&h.use_model)){if($.value.length>0){let x=$.value[0];if(x){let I=x.children[0];d.use_model=I.name,d.model_config_id=I.model_config_id}}}else d.use_model=((k=e.librarySearchData)==null?void 0:k.use_model)+"$$",d.model_config_id=((v=e.librarySearchData)==null?void 0:v.model_config_id)+"$$",d.use_model=d.use_model.split("$$")[0],d.model_config_id=(O=e.librarySearchData)==null?void 0:O.model_config_id.split("$$")[0]}),o({}),(r,h)=>{const k=ae,v=He,O=me;return c(),p("div",sa,[t("div",oa,[t("div",na,[i(Xt,{librarySearchData:e.librarySearchData},null,8,["librarySearchData"])]),B.value?(c(),p("div",da,[t("div",_a,[i(v,{class:"search-input",onPressEnter:l,value:L.value,"onUpdate:value":h[1]||(h[1]=x=>L.value=x),"allow-clear":"",placeholder:"输入关键词搜索"},{suffix:y(()=>[t("div",{class:"search-icon-box",onClick:l},[i(k,{class:"search-icon",name:"search-right"})])]),_:1},8,["value"])]),!C.value&&_.messageObj.finish&&!S.value.length?(c(),P(aa,{key:0,style:{"margin-top":"100px"},size:"250"},{default:y(()=>[ma]),_:1})):(c(),p("div",ua,[t("div",pa,[i(k,{class:"nav-icon",name:"search-tip"}),_.messageObj.finish?(c(),p("span",va,"智能回答生成完毕")):(c(),p("span",ha,"智能回答生成中..."))]),!_.messageObj.content&&!_.messageObj.finish&&!_.isError?(c(),p("div",fa,ya)):(c(),p("div",ba,[C.value?(c(),p("div",{key:0,innerHTML:C.value},null,8,ka)):(c(),p("div",xa,"暂无任何内容"))])),t("div",Sa,[$a,S.value.length?(c(),p("div",La,[j("相关分段 "),t("div",null,"("+q(S.value.length)+")",1)])):J("",!0),(c(!0),p(V,null,H(S.value,x=>(c(),p("div",{class:"section-item",key:x.id},[t("div",wa,[t("div",Aa,[i(k,{class:"section-item-icon",name:"document"}),t("div",{class:"section-item-label",onClick:I=>f(x)},[j(q(x.file_name),1),x.file_name?J("",!0):(c(),p("span",Oa,q(x.library_name)+"-精选",1))],8,Ca)]),t("div",Ma,"相似度："+q(m(x.similarity)),1)]),i(O,{overlayClassName:"search-content-tip",placement:"top"},{title:y(()=>[j(q(x.content),1)]),default:y(()=>[t("div",{class:"section-item-content",innerHTML:b(x.content,L.value)},null,8,Ra)]),_:2},1024)]))),128))])]))])):(c(),p("div",ia,[la,ra,t("div",ca,[i(v,{class:"search-input",onPressEnter:l,value:L.value,"onUpdate:value":h[0]||(h[0]=x=>L.value=x),"allow-clear":"",placeholder:"输入关键词搜索"},{suffix:y(()=>[t("div",{class:"search-icon-box",onClick:l},[i(k,{class:"search-icon",name:"search-right"})])]),_:1},8,["value"])])]))])])}}},ja=G(Da,[["__scopeId","data-v-cb12478c"]]),Ia={class:"cu-tabs"},Na=["onClick"],qa={__name:"contain-tabs",props:{value:{type:[Number,String],required:!0},tabs:{type:Array,required:!0,default:()=>[]}},emits:["update:value","change"],setup(_,{emit:o}){const A=o,D=_,e=R=>{A("update:value",R),A("change",R)};return(R,C)=>(c(),p("div",Ia,[(c(!0),p(V,null,H(_.tabs,L=>(c(),p("div",{class:le(["tab-item",{active:D.value===L.value}]),onClick:B=>e(L.value),key:L.value},q(L.title),11,Na))),128))]))}},Ua=G(qa,[["__scopeId","data-v-a6e0ef08"]]),Ba=de("searchStore",{state:()=>({indeterminate:!1,checkAll:!1,checkedList:[],activeKey:"all"}),getters:{getIndeterminate(){return this.indeterminate},getCheckAll(){return this.checkAll},getCheckedList(){return this.checkedList},getActiveKey(){return this.activeKey}},actions:{setIndeterminate(_){this.indeterminate=_},setCheckAll(_){this.checkAll=_},setCheckedList(_){this.checkedList=_},setActiveKey(_){this.activeKey=_}},persist:{enabled:!0,strategies:[{key:"searchStore",storage:localStorage,paths:["indeterminate","checkAll","checkedList","activeKey"]}]}}),Ta=de("search-lirary",()=>{const _=Qe(),o=Y({reasoning_content:"",show_reasoning:!1,content:"",quote_file:[],id:"",finish:!1,debug:[],error:[],recall_time:0,request_time:0,loading:!1});let A=null;const D=w(0),e=w(""),R=Y({context_pair:"",create_time:"",id:"",max_token:"",model_config_id:"",rerank_model_config_id:"",rerank_status:"",rerank_use_model:"",search_type:"",similarity:"",size:"",temperature:"",update_time:"",use_model:"",user_id:""}),C=(S,l)=>{if(S=="reasoning_content"){let m=o.reasoning_content||"";o.reasoning_content=m+l,o.show_reasoning=!0}if(S=="sending"){let m=o.content||"";o.content=m+l}if(S=="quote_file"&&(o.quote_file=l.length>0?l:[]),S=="ai_message"){if(l.menu_json&&l.msg_type==2){let m=JSON.parse(l.menu_json);o.question=m.question}o.id=l.id,o.content=l.content,l.quote_file&&typeof l.quote_file=="string"&&(o.quote_file=JSON.parse(l.quote_file))}S=="finish"&&(o.finish=!0),S=="debug"&&(o.debug=l.length>0?l:[]),S=="error"&&(o.error=l.length>0?l:[]),S=="recall_time"&&(o.recall_time=l||0),S=="request_time"&&(o.request_time=l||0),_.emit("updateAiMessage",o)},L=()=>{o.loading=!1};return{searchFormState:R,dialogue_id:D,openid:e,messageObj:o,getLibrarySearchFn:async()=>{A&&(A.abort(),A=null);const S=await Oe();try{let l=S.data;Object.assign(R,{...l})}catch(l){Promise.reject(l)}return S},searchMessage:(S,l,m)=>{Ae(32),o.content="",o.finish=!1;let b={model_config_id:m.model_config_id,use_model:m.use_model,temperature:m.temperature,max_token:m.max_token,size:m.size,similarity:m.similarity,search_type:m.search_type,question:S,id:l.join(","),recall_type:1};m.rerank_status&&(b.rerank_status=m.rerank_status),m.rerank_use_model&&(b.rerank_use_model=m.rerank_use_model),m.prompt&&(b.prompt=m.prompt),m.rerank_status==1&&(b.rerank_model_config_id=m.rerank_model_config_id),A=Ce(b),A.onMessage=f=>{if(f.event,f.event=="dialogue_id"&&(D.value=f.data),f.event=="reasoning_content"&&C("reasoning_content",f.data),f.event=="sending"&&C("sending",f.data),f.event=="ai_message"){let d=JSON.parse(f.data);C("ai_message",d)}if(f.event=="quote_file"){let d=JSON.parse(f.data);C("quote_file",d)}if(f.event=="finish"&&C("finish",f.data),f.event=="debug"){let d=JSON.parse(f.data);C("debug",d)}if(f.event=="error"){let d=f.data;C("error",d)}if(f.event=="recall_time"){let d=f.data;C("recall_time",d)}},A.onClose=()=>{L(),A=null}}}}),za={class:"chat-monitor-page"},Ea={class:"page-left"},Fa={class:"toolbar-box"},Ka={class:"library-checkbox-box"},Va={class:"app-list-box"},Pa={class:"list-box",ref:"scrollContainer"},Ja={class:"list-item"},Ha={class:"list-item-box"},Qa={class:"library-icon"},Ya=["onClick"],Ga={class:"page-body"},Wa={__name:"index",setup(_){const o=Ba();let{getIndeterminate:A,getCheckAll:D,getCheckedList:e,getActiveKey:R}=ne(o);const C=Ta(),{getLibrarySearchFn:L,searchMessage:B}=C,{messageObj:F}=ne(C),S=w(null),l=w(null),m=w("all"),b=w([{title:"全部",value:"all"},{title:"普通",value:"0"},{title:"问答",value:"2"}]),f=w({}),d=w([]),n=Y({indeterminate:!1,checkAll:!1,checkedList:[]}),a=u=>{f.value=u},$=w(!1),T=async u=>{$.value=!1;let M=await L();if(l.value=M.data,l.value.id||(l.value=Object.assign(f.value)),!l.value.model_config_id||!l.value.use_model)return $.value=!0,X("请在搜索设置中配置好相应配置后再使用");B(u,n.checkedList,l.value)},E=u=>{Object.assign(n,{checkedList:u.target.checked?d.value.map(M=>M.id):[],indeterminate:!!n.checkedList.length&&n.checkedList.length<d.value.length}),o.setCheckedList(n.checkedList),o.setIndeterminate(n.indeterminate)},r=u=>{o.setCheckedList(u)},h=u=>{window.open(`#/library/details/knowledge-document?id=${u}`)};Z(()=>n.checkedList,u=>{n.indeterminate=!!u.length&&u.length<d.value.length,n.checkAll=u.length>=d.value.length,o.setIndeterminate(n.indeterminate),o.setCheckAll(n.checkAll)});const k=()=>{d.value.forEach(u=>{u.type==0,u.type==2}),b.value=[{title:"全部",value:"all"},{title:"普通",value:"0"},{title:"问答",value:"2"}]},v=(u,M)=>{if(M.length===0)return!1;const N=new Set(u);return M.every(s=>N.has(s))},O=(u,M)=>!M.some(N=>u.includes(N)),x=async()=>{let u=m.value==="all"?"":m.value;await Me({type:u}).then(M=>{var z;let N=M.data||[];N.forEach(g=>{g.file_size_str=Re(g.file_size),g.avatar||(g.avatar=g.type==0?De:je)}),d.value=N;const s=d.value.map(g=>g.id);if((z=e.value)!=null&&z.length&&(s!=null&&s.length)){const g=e.value,W=s,ue=v(g,W),pe=O(g,W),se=g.length>=W.length&&ue,oe={checkAll:se,indeterminate:!se&&!pe};o.$patch(oe),Object.assign(n,oe)}else{const g={checkAll:!1,indeterminate:!1};o.$patch(g),Object.assign(n,g)}n.checkedList=e.value,n.indeterminate=A.value,!D.value&&e.value.length==0&&!A.value&&R.value=="all"&&(o.setCheckAll(!0),n.checkedList=s,o.setCheckedList(s)),m.value==="all"&&k()})},I=u=>{o.setActiveKey(u),x()};return te(async()=>{R.value&&(m.value=R.value),await x();let u=await L();l.value=u.data}),ke(()=>{}),(u,M)=>{const N=Ye,s=We,z=Ge;return c(),p("div",za,[t("div",Ea,[t("div",Fa,[i(Ua,{tabs:b.value,value:m.value,"onUpdate:value":M[0]||(M[0]=g=>m.value=g),onChange:I},null,8,["tabs","value"])]),t("div",Ka,[t("div",Va,[i(N,{checked:n.checkAll,"onUpdate:checked":M[1]||(M[1]=g=>n.checkAll=g),indeterminate:n.indeterminate,onChange:E},{default:y(()=>[j(" 全选/取消 ")]),_:1},8,["checked","indeterminate"])]),i(z,{value:n.checkedList,"onUpdate:value":M[2]||(M[2]=g=>n.checkedList=g),onChange:r},{default:y(()=>[t("div",Pa,[(c(!0),p(V,null,H(d.value,g=>(c(),p("div",{class:"list-item-wraapper",key:g.id},[t("div",Ja,[i(N,{value:g.id},null,8,["value"]),t("div",Ha,[t("div",Qa,[i(s,{preview:!1,width:32,src:g.avatar},null,8,["src"])]),t("div",{class:"library-name",onClick:W=>h(g.id)},q(g.library_name),9,Ya)])])]))),128))],512)]),_:1},8,["value"])])]),t("div",Ga,[i(ja,{ref_key:"searchBoxRef",ref:S,onDefaultParmas:a,onSearch:T,isError:$.value,messageObj:K(F),librarySearchData:l.value,library_ids:n.checkedList},null,8,["isError","messageObj","librarySearchData","library_ids"])])])}}},Hs=G(Wa,[["__scopeId","data-v-13039c07"]]);export{Hs as default};
