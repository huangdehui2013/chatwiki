import{b as $e,B as $t,L as _n,E as Se,M as he,k as ue,d as qt,b3 as dn,T as pn,e as fn,f as mn}from"../../index-UhR4yadr.js";import{M as o,N as g,W as l,k as t,S as a,u as Z,a1 as Fe,a2 as De,a5 as Ue,e as c,b as we,x as Qe,D as Lt,ai as et,Y as S,Z as K,F as re,$ as ye,X as Oe,Q as T,a7 as X,a0 as Ne,G as tt,B as nt,z as Ze,a4 as Ot,a6 as Et,a8 as vn}from"./vue-chunks-DWnFCQSz.js";import{_ as hn}from"./empty-CzGZrENG.js";import{P as Rt}from"./PlusOutlined-CeclvJCi.js";import{S as He,c as Be,a as Pt,C as Tt,b as gn,E as kn}from"./edit-subsection-CwR_YT3-.js";import{C as It,D as Mt,x as Ft,y as Dt,k as yn,b as zt,e as bn,f as Sn,s as At,h as wn,E as Cn,F as St,G as xn,H as $n}from"./index-DIUiarE3.js";import{_ as at,M as lt}from"./index-5i8OLAzS.js";import"./index-BJ7TpmPl.js";import{D as ot}from"./dropdown-CbxGUAy7.js";import{S as Nt}from"./SettingOutlined-uwXhuIXb.js";import{S as Ht}from"./SyncOutlined-BM33Hh67.js";import{M as Bt}from"./MoreOutlined-iAOeSBQN.js";import{_ as Je}from"./index-kKxyythX.js";import{C as Me}from"./cu-scroll-jRkjVxy8.js";import{_ as qn,F as Ln}from"./index-DzuDS3Yk.js";import{S as Ut,_ as Qt}from"./index-9VXz7HRC.js";import{R as On}from"./rename-modal-BpPZVDej.js";import{V as wt}from"./vue-pdf-embed-CTnPXFvH.js";import{S as je}from"./index-BWhNhRp3.js";import{S as En,a as Rn,D as Pn,E as Tn}from"./edit-fragment-alert-CLj7dpit.js";import{C as In}from"./ClockCircleFilled-B7CU2Mch.js";import{_ as Mn,a as Fn}from"./index-BWTLc6ay.js";import{B as Dn,_ as zn}from"./index-D2NjFshG.js";import{_ as An}from"./index-Cd86XltT.js";import{_ as Nn,a as Hn}from"./RadioButton-BySv4e0a.js";import{L as Bn}from"./LeftOutlined-CKIj-GEZ.js";import{D as Ct}from"./DownOutlined-CvDOGKH1.js";import"./axios-Cm0UX6qg.js";import"./qs-De-rn6vz.js";import"./crypto-js-U6t3rvpm.js";import"./dayjs-BI1HIvBC.js";import"./index-teqAjsuU.js";import"./Dropdown-lzT8P96r.js";import"./Trigger-DcWVD-r5.js";import"./index-DXeZ5ybK.js";import"./useRefs-CH9tJ50T.js";import"./pick-DFWac7Lu.js";import"./CheckOutlined-B_iCQ6FL.js";import"./slide-BR5NTmcW.js";import"./index--Qvpscnx.js";import"./Input-D7W5TJDt.js";import"./FormItemContext-BJa1evck.js";import"./statusUtils--roYFmJe.js";import"./inputProps-CiDWLiIl.js";import"./index-DmSlXGTl.js";import"./Search-BRb_v-2B.js";import"./SearchOutlined-bV5WeZB5.js";import"./isPlainObject-BeqP4IC7.js";import"./TextArea-CpTIlaWe.js";import"./Password-XreinKYD.js";import"./index-f5cCF1C6.js";import"./index-bg5oFZUg.js";import"./index-BJ4SSG33.js";import"./partition-CNXo-yhR.js";import"./collapseMotion-ByInPrfq.js";import"./index-DzhuYAPB.js";import"./shallowequal-C0Ji8tJB.js";import"./RightOutlined-BxQrTxvt.js";import"./move-cWZng2f8.js";import"./colors-BiofrUQp.js";import"./pull-up.esm-JZ91zQ8P.js";import"./observe-dom.esm-DPKTicVt.js";import"./responsiveObserve-Bs6--9PQ.js";import"./QuestionCircleOutlined-CV_adx6X.js";import"./model-select-6loF5tMn.js";import"./index-cS6xwXeR.js";import"./index-DrSPxL4Q.js";import"./index-BnhNOVTI.js";import"./UpOutlined-BkQ7BaZ8.js";import"./index-RGagVdKM.js";import"./index-CwxKp8Sp.js";import"./useMaxLevel-8lDaIAJK.js";import"./index-C0X3d23U.js";import"./css-DbBMd65r.js";import"./fromPairs-Dx9PT-t0.js";import"./index-ChDOqBF7.js";import"./Checkbox-BSqox9oh.js";import"./index-Drb31wtU.js";import"./CaretDownOutlined-DbQ_eVB2.js";const st=$=>(Fe("data-v-8eb7d862"),$=$(),De(),$),Un={class:"empty-box"},Qn=st(()=>l("img",{src:hn,alt:""},null,-1)),Jn=st(()=>l("div",{class:"title"},"知识库文档为空，请添加分段",-1)),jn=st(()=>l("span",null,"添加分段",-1)),Vn={__name:"empty",props:{detailsInfo:{type:Object}},emits:["openEditSubscription"],setup($,{emit:ce}){const te=ce,C=()=>{te("openEditSubscription",{})};return(f,j)=>{const x=$t;return o(),g("div",Un,[Qn,Jn,l("div",null,[t(x,{type:"primary",onClick:C},{icon:a(()=>[t(Z(Rt))]),default:a(()=>[jn]),_:1})])])}}},Ye=$e(Vn,[["__scopeId","data-v-8eb7d862"]]),Wn=$=>(Fe("data-v-0bf41a49"),$=$(),De(),$),Gn={class:"subsection-box-title"},Xn=["onClick"],Kn={class:"top-block"},Yn={class:"title"},Zn={class:"title-block"},ea={class:"cfb363f"},ta={key:0},na={class:"cfb363f"},aa={class:"right-opration"},la={class:"hover-btn-box"},oa=["onClick"],sa=Wn(()=>l("div",null,"精选设置",-1)),ia={class:"hover-btn-box"},ca={class:"hover-btn-box"},ra=["onClick"],ua=["onClick"],_a={key:0,class:"content-box"},da={key:1,class:"content-box"},pa=["onMouseup","innerHTML"],fa={class:"fragment-img"},ma=["src"],va={__name:"subsection-box",props:{paragraphLists:{type:Array,default:()=>[]},detailsInfo:{type:Object,default:()=>{}},total:{type:[Number,String],default:0}},emits:["handleDelParagraph","handleScrollTargetPage","openEditSubscription","handleConvert","getStatrList","handleSplit","handleSplitNext","handleSplitUp","handleSplitDelete"],setup($,{expose:ce,emit:te}){const C=te,f=$,j=Ue(),x=(i,_)=>{let{id:H,title:p,content:B,question:R,answer:z,images:Y,category_id:d}=i,ee=i.similar_questions||[];he.confirm({title:"重新转换确认",icon:null,content:`确定要重新转换【分段${_+1}】吗?`,onOk(){return new Promise((q,fe)=>{It({id:H,title:p,content:B,question:R,answer:z,images:Y,category_id:d,similar_questions:JSON.stringify(ee)}).then(ke=>{C("handleConvert",i),q()}).catch(()=>{q()})})},onCancel(){}})},N=i=>{C("openEditSubscription",i)},I=i=>{he.confirm({title:"提示",icon:t(Se),content:"确认是否删除该分段?",onOk(){return new Promise((_,H)=>{Mt({id:i}).then(p=>{ue.success("删除成功"),C("handleDelParagraph",i),_()}).catch(()=>{_()})})},onCancel(){}})},ae=(i,_)=>{C("handleScrollTargetPage",{page_num:i.page_num,index:_})},U=c([]),r=()=>{let i={file_id:j.query.id};Ft(i).then(_=>{U.value=_.data||[],C("getStatrList",_.data||[])})};r();const M=c(null),ie=()=>{M.value.show()},E=i=>{var H;let _=(H=U.value.filter(p=>p.id==i.category_id)[0])==null?void 0:H.type;return _?Be[_]:""},F=(i,_={})=>{Dt({id:i.id,category_id:_.id||0}).then(H=>{ue.success("设置成功"),i.category_id=_.id,r()})},D=c(null),w=c(!1),k=c({x:0,y:0}),V=c(""),Q=c(null),_e=c({text:"",parentIndex:-1,originalHtml:""}),de=we(()=>{if(!w.value)return{};const i=162;let _=k.value.x,H=k.value.y;const p=D.value.getBoundingClientRect(),B=window.innerWidth;_<10?_=10:_+i>B-50&&(_=B-i-50);const R=_-p.left,z=H;return{left:`${R}px`,top:`${z}px`}}),pe=(i,_)=>{const H=window.getSelection(),p=H.toString().trim();if(p){_e.value={text:p,parentIndex:_,originalHtml:f.paragraphLists[_].content},V.value=p,Q.value=H.getRangeAt(0).cloneRange();const R=H.getRangeAt(0).getBoundingClientRect(),z=D.value.getBoundingClientRect();k.value={x:R.left+R.width/2,y:R.top-z.top-50},w.value=!0}else w.value=!1},v=i=>{const{parentIndex:_}=_e.value;switch(i){case"separate":ne(_);break;case"merge-next":qe(_);break;case"merge-prev":ge(_);break;case"delete":Te(_);break}w.value=!1,window.getSelection().removeAllRanges()},W=(i,_,H)=>{if(_===0&&H===i.textContent.length&&i.textContent.trim().length>0)return["",i.innerHTML,""];const B=document.createTreeWalker(i,NodeFilter.SHOW_TEXT);let R,z=0,Y,d,ee,q;for(;R=B.nextNode();){const Le=R.nodeValue.length;if(!Y&&z+Le>=_&&(Y=R,ee=_-z),!d&&z+Le>=H){d=R,q=H-z;break}z+=Le}const fe=document.createRange();fe.setStart(Y,ee),fe.setEnd(d,q);const ke=document.createRange();ke.setStart(i,0),ke.setEnd(Y,ee);const be=document.createRange();return be.setStart(d,q),be.setEnd(i,i.childNodes.length),[y(ke),y(fe),y(be)]},y=i=>{const _=document.createElement("div");return _.appendChild(i.cloneContents()),_.innerHTML},ne=i=>{const _=f.paragraphLists[i].content,p=window.getSelection().getRangeAt(0);p.toString()&&he.confirm({title:"单独分段",icon:t(Se),content:"确认将该分段内容单独分段么？分段后，原分段的内容会被删除",onOk(){const R=document.createElement("div");R.innerHTML=_;const[z,Y,d]=W(R,p.startOffset,p.endOffset),ee=z.replace(/<[^>]+>/g,"").trim()==="",q=d.replace(/<[^>]+>/g,"").trim()==="";ee&&q?C("handleSplit",{index:i,beforeContent:"",selectedContent:Y,afterContent:"",isFullSelection:!0}):C("handleSplit",{index:i,beforeContent:z,selectedContent:Y,afterContent:d,originalSelection:{start:p.startOffset,end:p.endOffset,parentIndex:i}})}})},qe=i=>{if(i>=f.paragraphLists.length-1)return ue.error("没有下一个分段");const _=f.paragraphLists[i].content,p=window.getSelection().getRangeAt(0);p.toString()&&he.confirm({title:"合并到下一个分段",icon:t(Se),content:"确认将该分段内容合并到下一个分段么？分段后，原分段的内容会被删除",onOk(){const R=document.createElement("div");R.innerHTML=_;const[z,Y,d]=W(R,p.startOffset,p.endOffset),ee=z.replace(/<[^>]+>/g,"").trim()==="",q=d.replace(/<[^>]+>/g,"").trim()==="";ee&&q?C("handleSplitNext",{index:i,beforeContent:"",selectedContent:Y,afterContent:"",isFullSelection:!0}):C("handleSplitNext",{index:i,beforeContent:z,selectedContent:Y,afterContent:d,originalSelection:{start:p.startOffset,end:p.endOffset,parentIndex:i}})}})},ge=i=>{if(i<=0)return ue.error("没有上一个分段");const _=f.paragraphLists[i].content,p=window.getSelection().getRangeAt(0);p.toString()&&he.confirm({title:"合并到上一个分段",icon:t(Se),content:"确认将该分段内容合并到上一个分段么？分段后，原分段的内容会被删除",onOk(){const R=document.createElement("div");R.innerHTML=_;const[z,Y,d]=W(R,p.startOffset,p.endOffset),ee=z.replace(/<[^>]+>/g,"").trim()==="",q=d.replace(/<[^>]+>/g,"").trim()==="";ee&&q?C("handleSplitUp",{index:i,beforeContent:"",selectedContent:Y,afterContent:"",isFullSelection:!0}):C("handleSplitUp",{index:i,beforeContent:z,selectedContent:Y,afterContent:d,originalSelection:{start:p.startOffset,end:p.endOffset,parentIndex:i}})}})},Te=i=>{const _=f.paragraphLists[i].content,p=window.getSelection().getRangeAt(0);p.toString()&&he.confirm({title:"删除",icon:t(Se),content:"确认将该分段内容删除么？",onOk(){const R=document.createElement("div");R.innerHTML=_;const[z,Y,d]=W(R,p.startOffset,p.endOffset),ee=z.replace(/<[^>]+>/g,"").trim()==="",q=d.replace(/<[^>]+>/g,"").trim()==="";ee&&q?C("handleSplitDelete",{index:i,beforeContent:"",selectedContent:"",afterContent:"",isFullSelection:!0}):C("handleSplitDelete",{index:i,beforeContent:z,selectedContent:"",afterContent:d,originalSelection:{start:p.startOffset,end:p.endOffset,parentIndex:i}})}})},b=i=>{w.value&&!i.target.closest(".bubble-card")&&(w.value=!1)};return Qe(()=>{document.addEventListener("click",b)}),Lt(()=>{document.removeEventListener("click",b)}),ce({handleOpenEditModal:N}),(i,_)=>{const H=Je,p=at,B=lt,R=ot,z=qt,Y=et("viewer");return o(),g("div",{class:"subsection-box content-container",ref_key:"containerRef",ref:D},[l("div",Gn,[S(" 分段预览 "),l("span",null,"共"+K(f.total)+"个分段",1)]),(o(!0),g(re,null,ye(f.paragraphLists,(d,ee)=>(o(),g("div",{class:"list-item",key:d.id,onClick:q=>ae(d,ee),style:Oe({"--status-color":E(d)})},[l("div",Kn,[l("div",Yn,[S(" 分段"+K(ee+1)+" ",1),l("div",Zn,K(d.title),1),l("span",null,"共"+K(d.word_total)+"个字符",1),l("span",null,[S(" 嵌入状态："+K(d.status_text),1),d.status==3?(o(),T(Z(_n),{key:0})):X("",!0),d.status==2&&d.errmsg?(o(),T(H,{key:1,title:d.errmsg},{default:a(()=>[l("strong",ea,[S("原因"),t(Z(Se),{class:"err-icon cfb363f"})])]),_:2},1032,["title"])):X("",!0)]),$.detailsInfo.graph_switch?(o(),g("span",ta,[S(" 知识图谱状态："+K(d.graph_status_text)+" ",1),d.graph_status==3&&d.graph_err_msg?(o(),T(H,{key:0,title:d.graph_err_msg},{default:a(()=>[l("strong",na,[S("原因"),t(Z(Se),{class:"err-icon cfb363f"})])]),_:2},1032,["title"])):X("",!0)])):X("",!0)]),l("div",aa,[t(R,null,{overlay:a(()=>[t(B,null,{default:a(()=>[(o(!0),g(re,null,ye(U.value,q=>(o(),T(p,{key:q.id},{default:a(()=>[l("div",{class:"start-item",onClick:fe=>F(d,q)},[t(Z(He),{style:Oe({color:Z(Be)[q.type]})},null,8,["style"]),l("div",null,K(q.name||"-"),1)],8,oa)]),_:2},1024))),128)),t(p,null,{default:a(()=>[l("div",{class:"start-item",onClick:ie},[t(Z(Nt)),sa])]),_:1})]),_:2},1024)]),default:a(()=>[l("div",la,[d.category_id>0?(o(),T(Z(He),{key:0,onClick:q=>F(d,{}),style:Oe({color:E(d),"font-size":"16px"})},null,8,["onClick","style"])):(o(),T(Z(Pt),{key:1,onClick:q=>F(d,U.value[0]),style:{"font-size":"16px"}},null,8,["onClick"]))])]),_:2},1024),t(H,null,{title:a(()=>[S("重新转换")]),default:a(()=>[l("div",ia,[t(Z(Ht),{onClick:q=>x(d,ee)},null,8,["onClick"])])]),_:2},1024),t(R,{placement:"bottomRight"},{overlay:a(()=>[t(B,null,{default:a(()=>[t(p,null,{default:a(()=>[l("div",{onClick:Ne(q=>N(d),["stop"])},"编辑",8,ra)]),_:2},1024),t(p,null,{default:a(()=>[l("div",{onClick:Ne(q=>I(d.id),["stop"])},"删除",8,ua)]),_:2},1024)]),_:2},1024)]),default:a(()=>[l("div",ca,[t(Z(Bt))])]),_:2},1024)])]),d.question?(o(),g("div",_a,"Q："+K(d.question),1)):X("",!0),d.answer?(o(),g("div",da,"A："+K(d.answer),1)):X("",!0),l("div",{class:"content-box",onMouseup:q=>pe(q,ee),innerHTML:d.content},null,40,pa),tt((o(),g("div",fa,[(o(!0),g(re,null,ye(d.images,(q,fe)=>(o(),g("img",{key:fe,src:q,alt:""},null,8,ma))),128))])),[[Y]])],12,Xn))),128)),t(Tt,{onOk:r,ref_key:"classificationMarkModalRef",ref:M},null,512),w.value?(o(),g("div",{key:0,class:"bubble-card",style:Oe(de.value)},[l("button",{class:"bubble-item",onClick:_[0]||(_[0]=d=>v("separate"))},[t(z,{name:"segmentation",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),S(" 单独成段 ")]),l("button",{class:"bubble-item",onClick:_[1]||(_[1]=d=>v("merge-next"))},[t(z,{name:"segmentation-down",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),S(" 合并到下一分段 ")]),l("button",{class:"bubble-item",onClick:_[2]||(_[2]=d=>v("merge-prev"))},[t(z,{name:"segmentation-up",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),S(" 合并到上一分段 ")]),l("button",{class:"bubble-item",onClick:_[3]||(_[3]=d=>v("delete"))},[t(z,{name:"delete",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),S(" 删除 ")])],4)):X("",!0)],512)}}},xt=$e(va,[["__scopeId","data-v-0bf41a49"]]),ha={class:"mode-box"},ga=["innerHTML"],ka={class:"tag-item"},ya={__name:"segmentation-mode",props:{detailsInfo:{type:Object}},setup($){const ce=$,te=c(""),C=we(()=>{const{is_table_file:f,is_qa_doc:j,is_diy_split:x,question_lable:N,answer_lable:I,separators:ae,chunk_size:U,chunk_overlap:r,question_column:M,answer_column:ie,qa_index_type:E,doc_type:F}=ce.detailsInfo;if(f!=1&&j!=1&&x!=1)return F==3?(te.value=`分段模式：手动分段
文档类型：普通文档`,"自定义：普通文档"):(te.value=`分段模式：智能分段
文档类型：普通文档`,"智能分段：普通文档");if(f!=1&&j==1)return F==3?(te.value=`分段模式：手动分段
文档类型：QA文档`,"自定义：QA文档"):(te.value=`分段模式：智能分段
文档类型：QA文档
问题开始标识符："${N}"
答案开始标识符："${I}"`,"智能分段：QA文档");if(f!=1&&j!=1&&x==1)return te.value=`分段模式：自定义分段
文档标识符：${ae}
分段最大长度：${U}字符
文段重叠长度：${r}字符`,"自定义分段";if(f==1&&j!=1)return te.value=`分段模式：智能分段
文档类型：普通表格`,"智能分段：普通表格";if(f==1&&j==1){let D=E==1?"问题与答案一起生成索引":"仅对问题生成索引";return te.value=`分段模式：智能分段
文档类型：QA文档
问题所在列："${M}"
答案所在列："${ie}"
索引方式：${D}`,"智能分段：QA文档"}});return(f,j)=>{const x=Je;return o(),g("div",ha,[t(x,null,{title:a(()=>[l("div",{class:"tooltip-text-box",innerHTML:te.value},null,8,ga)]),default:a(()=>[l("div",ka,K(C.value),1)]),_:1})])}}},ba=$e(ya,[["__scopeId","data-v-e8649c10"]]),Sa={__name:"update-frequency",emits:["ok"],setup($,{expose:ce,emit:te}){const C=te,f=c(!1),j=c(!1),x=nt({doc_auto_renew_frequency:1,id:""}),N=ae=>{let{doc_auto_renew_frequency:U,id:r}=ae;x.doc_auto_renew_frequency=+U,x.id=r,f.value=!0},I=()=>{j.value=!0,yn({...x}).then(ae=>{C("ok",x.doc_auto_renew_frequency),f.value=!1,ue.success("设置成功")}).finally(()=>{j.value=!1})};return ce({open:N}),(ae,U)=>{const r=Ut,M=Qt,ie=qn,E=Ln,F=he;return o(),g("div",null,[t(F,{open:f.value,"onUpdate:open":U[1]||(U[1]=D=>f.value=D),"confirm-loading":j.value,maskClosable:!1,title:"设置更新频率",onOk:I},{default:a(()=>[t(E,{style:{margin:"32px 0"},layout:"vertical",model:x},{default:a(()=>[t(ie,{name:"doc_auto_renew_frequency",label:"更新频率",required:""},{default:a(()=>[t(M,{value:x.doc_auto_renew_frequency,"onUpdate:value":U[0]||(U[0]=D=>x.doc_auto_renew_frequency=D),style:{width:"100%"}},{default:a(()=>[t(r,{value:1},{default:a(()=>[S("不自动更新")]),_:1}),t(r,{value:2},{default:a(()=>[S("每天")]),_:1}),t(r,{value:3},{default:a(()=>[S("每3天")]),_:1}),t(r,{value:4},{default:a(()=>[S("每7天")]),_:1}),t(r,{value:5},{default:a(()=>[S("每30天")]),_:1})]),_:1},8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open","confirm-loading"])])}}},wa={class:"loading"},Ca={__name:"pdf-preview",props:{source:{type:[String],required:!0},pageSize:{type:Number,default:10}},emits:["onScrollEnd","select","rendered","scroll","getTotalPage"],setup($,{expose:ce,emit:te}){const C=$,f=te,j=c(null),x=c([]),N=c(0),I=c(!1),ae=we(()=>I.value?null:{"border-bottom":"2px solid #d9d9d9"}),U=c({fade:!1,scrollbarTrackClickable:!0,interactive:!0,minSize:40});Qe(async()=>{const w=await wt.getDocument(C.source).promise;N.value=w.numPages,f("getTotalPage",N.value),r()});const r=(w=null)=>{const k=x.value.length;if(k>=N.value||I.value)return;I.value=!0;const V=[];for(let Q=1;Q<=C.pageSize&&k+Q<=N.value;Q++)V.push(k+Q);x.value.push(...V),Ze(()=>{typeof w=="function"&&w()})},M=w=>{r(),f("onScrollEnd",w)},ie=w=>{Ze(()=>{w===x.value[x.value.length-1]&&(I.value=!1,f("rendered",w,N.value))})},E=w=>{f("select",w)},F=()=>j.value,D=w=>{f("scroll",w)};return ce({loadMore:r,getScrollInstance:F}),(w,k)=>{const V=je;return o(),T(Me,{scrollbar:U.value,ref_key:"scrollRef",ref:j,onScroll:D,onOnScrollEnd:M},{default:a(()=>[(o(!0),g(re,null,ye(x.value,Q=>(o(),T(Z(wt),{onClick:_e=>E(Q),key:Q,source:$.source,page:Q,onRendered:()=>ie(Q),style:Oe(ae.value)},null,8,["onClick","source","page","onRendered","style"]))),128)),l("div",wa,[I.value?(o(),T(V,{key:0})):X("",!0)])]),_:1},8,["scrollbar"])}}},xa=$e(Ca,[["__scopeId","data-v-8520f2eb"]]),$a=$=>(Fe("data-v-9f322e00"),$=$(),De(),$),qa={key:0,class:"loading-wrap"},La={class:"document-segmentation"},Oa={class:"page-container"},Ea={class:"page-left"},Ra={class:"page-right"},Pa={class:"document-fragment-preview"},Ta={class:"preview-header"},Ia=$a(()=>l("span",{class:"label-text"},"分段预览",-1)),Ma={class:"fragment-number"},Fa={key:1,class:"loading-box"},Da="你是一位文章分段助手，根据文章内容的语义进行合理分段，确保每个分段表述一个完整的语义，每个分段字数控制在500字左右，最大不超过1000字。请严格按照文章内容进行分段，不要对文章内容进行加工，分段完成后输出分段后的内容。",za={__name:"document-segmentation-model",props:{pdfState:{type:Object,default:()=>{}}},emits:["ok","finish","loading"],setup($,{expose:ce,emit:te}){const C=Ue(),f=te,{id:j}=C.query,x=c(!0),N=c(1);let I=!1;const ae=$,U=c(1);let r={id:j,separators_no:"",chunk_size:512,chunk_overlap:50,is_qa_doc:0,question_lable:"",answer_lable:"",enable_extract_image:!0,ai_chunk_size:5e3,ai_chunk_model:"",ai_chunk_model_config_id:"",ai_chunk_prumpt:Da,ai_chunk_task_id:""};const M=c(null),ie=n=>{typeof n.separators_no=="object"&&(n.separators_no=n.separators_no.join(",")),r={...r,...n},I?he.confirm({title:"提醒",icon:t(Se),content:"文档片段已被编辑重新获取文档片段会丢失当前修改过的文档片段内容，确定要重新获取吗？",okText:"确定",okType:"danger",cancelText:"取消",onOk(){I=!1,ge("create")},onCancel(){}}):(I=!1,ge("create"))};let E=60*10,F=0;const D=c({}),w=c(0),k=()=>{x.value||(x.value=!0),zt({id:j}).then(async n=>{const{status:O}=n.data;if(w.value=n.data.library_type,D.value=n.data,r={...r,separators_no:n.data.separators_no||"11,12",chunk_size:+n.data.chunk_size||512,ai_chunk_size:+n.data.ai_chunk_size||5e3,chunk_overlap:+n.data.chunk_overlap||50,is_qa_doc:w.value==2?1:0,question_lable:n.data.question_lable,answer_lable:n.data.answer_lable,question_column:n.data.question_column,answer_column:n.data.answer_column,enable_extract_image:n.data.enable_extract_image=="true",qa_index_type:+n.data.qa_index_type,chunk_type:+n.data.chunk_type,semantic_chunk_size:+n.data.semantic_chunk_size||512,semantic_chunk_overlap:+n.data.semantic_chunk_overlap||50,semantic_chunk_threshold:+n.data.semantic_chunk_threshold||90,semantic_chunk_use_model:n.data.semantic_chunk_use_model||"",ai_chunk_prumpt:n.data.ai_chunk_prumpt||"",ai_chunk_model:n.data.ai_chunk_model||"",semantic_chunk_model_config_id:n.data.semantic_chunk_model_config_id>0?n.data.semantic_chunk_model_config_id:"",ai_chunk_model_config_id:n.data.ai_chunk_model_config_id>0?n.data.ai_chunk_model_config_id:"",ai_chunk_task_id:n.data.ai_chunk_task_id||""},n.data.chunk_type==0&&(r={...r,separators_no:n.data.normal_chunk_default_separators_no,chunk_size:n.data.normal_chunk_default_chunk_size,chunk_overlap:n.data.normal_chunk_default_chunk_overlap,chunk_type:+n.data.default_chunk_type,semantic_chunk_size:+n.data.semantic_chunk_default_chunk_size,semantic_chunk_overlap:+n.data.semantic_chunk_default_chunk_overlap,semantic_chunk_threshold:+n.data.semantic_chunk_default_threshold,semantic_chunk_use_model:n.data.default_use_model||"",semantic_chunk_model_config_id:n.data.default_model_config_id>0?n.data.default_model_config_id:""}),O==0){if(F++,F>E){he.error({title:"提醒",content:"文档解析速度慢请稍后再试"});return}setTimeout(()=>{k()},1e3)}else(O==4||O==2)&&(x.value=!1,N.value=parseInt(n.data.is_table_file),n.data.library_id,w.value==2?(r.question_lable||r.question_column)&&ge():ge());n.data.is_table_file==1&&Q()})};Qe(async()=>{await k()});const V=c([]),Q=()=>{bn({id:j}).then(n=>{let O=[];for(let G in n.data)O.push({lable:n.data[G],value:G});V.value=O})},_e=c(!1),de=c(!1),pe=c(""),v=c(null);let W=null;const y=c([]),ne=c(0),qe=we(()=>ne.value<=0),ge=n=>{f("loading",!0);let O={...r,semantic_chunk_model_config_id:r.semantic_chunk_model_config_id?+r.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:r.ai_chunk_model_config_id?+r.ai_chunk_model_config_id:0,...ae.pdfState};return r.chunk_type==3&&(r.ai_chunk_task_id&&!n&&(O.ai_chunk_task_id=r.ai_chunk_task_id),O.ai_chunk_task_id&&n&&n==="create"&&delete O.ai_chunk_task_id),Sn(O).then(G=>{var le;y.value=G.data.list||[],ne.value=G.data.list.length||0,r.chunk_type==3&&(pe.value=((le=G.data.split_params)==null?void 0:le.ai_chunk_task_id)||"",de.value=!0,M.value.reLoading=!0,v.value=null,!r.ai_chunk_task_id&&N.value!=1||n&&n==="create"?(y.value=[],ne.value=0,_()):(de.value=!1,M.value.reLoading=!1))}).finally(()=>{r.chunk_type!=3&&(M.value.reLoading=!1),f("loading",!1)})},Te=n=>{U.value=n},b=async()=>{var n;try{const O=await H();return O.data.err_msg?(v.value=O.data.err_msg,!0):((n=O.data.list)==null?void 0:n.length)>0?(y.value=O.data.list||[],ne.value=O.data.list.length||0,!0):!1}catch{return v.value="请求异常，停止轮询",!0}};function i(n){return n.split("message:")[1]}const _=()=>{const n=async()=>{if(!await b())W=setTimeout(n,3e3);else if(de.value=!1,M.value.reLoading=!1,W!==null&&(clearTimeout(W),W=null),_e.value&&ke(),v.value){let G=i(v.value);he.error({title:"分段失败提示",content:G?`模型调用失败，失败原因：${G}`:"模型调用失败"})}};n()},H=()=>wn({id:r.id,task_id:pe.value}),p=c(null);let B=null;const R=({title:n,content:O,question:G,answer:le,images:ve},Ee)=>{B=Ee,p.value.open({title:n,content:O,question:G,answer:le,images:ve})},z=({title:n,content:O,question:G,answer:le,images:ve})=>{(y.value[B].title!=n||y.value[B].content!=O||y.value[B].question!=G||y.value[B].answer!=le)&&(I=!0),y.value[B].title=n,y.value[B].content=O,y.value[B].question=G,y.value[B].answer=le,y.value[B].images=ve,y.value[B].word_total=le.length+G.length+O.length},Y=n=>{he.confirm({title:"提醒",icon:t(Se),content:"确定要删除这个片段吗?",okText:"确定",okType:"danger",cancelText:"取消",onOk(){I=!0,y.value.splice(n,1)},onCancel(){}})},d=c(""),ee=n=>{d.value=n},q=c(!1),fe=()=>{let n=M.value.formState;n=JSON.parse(JSON.stringify(n)),typeof n.separators_no=="object"&&(n.separators_no=n.separators_no.join(",")),r={...r,...n}},ke=async()=>{if((ne.value<=0||r.chunk_type!=U.value)&&(fe(),await ge()),fe(),d.value)return ue.error(d.value);if(r.chunk_type==3&&!y.value.length)return _e.value=!0,!1;pe.value&&(r.ai_chunk_task_id=pe.value);let n={...r,semantic_chunk_model_config_id:r.semantic_chunk_model_config_id?+r.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:r.ai_chunk_model_config_id?+r.ai_chunk_model_config_id:0,is_table_file:N.value,...ae.pdfState};delete n.id;let O={id:j,word_total:ne.value,split_params:JSON.stringify(n),list:JSON.stringify(y.value),...ae.pdfState};n.is_qa_doc==1&&(O.qa_index_type=n.qa_index_type),q.value=!0,At(O).then(()=>{f("ok"),f("finish")}).finally(()=>{q.value=!1}).catch(G=>{G.data&&G.data.index&&Le(G.data.index),f("finish")})},be=c(null),Le=n=>{n=n-1;let O=be.value.querySelectorAll(".fragment-item");O.length>=n&&O[n].scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})};return Lt(()=>{W&&(clearTimeout(W),W=null)}),ce({handleSaveLibFileSplit:ke}),(n,O)=>{const G=je;return o(),g(re,null,[x.value?(o(),g("div",qa,[t(G)])):X("",!0),l("div",La,[l("div",Oa,[l("div",Ea,[t(En,{excellQaLists:V.value,libFileInfo:D.value,library_type:w.value,mode:N.value,hideSave:!0,ref_key:"segmentationSettingRef",ref:M,onChange:ie,onChangeChunkType:Te,onSave:ke,onValidate:ee},null,8,["excellQaLists","libFileInfo","library_type","mode"])]),l("div",Ra,[l("div",Pa,[l("div",Ta,[Ia,l("span",Ma,"共"+K(ne.value)+"个分段",1)]),qe.value&&!de.value?(o(),T(Rn,{key:0})):X("",!0),de.value?(o(),g("div",Fa,[t(G),S("数据处理中...")])):X("",!0),l("div",{class:"preview-box",ref_key:"previewBoxRef",ref:be},[(o(!0),g(re,null,ye(y.value,(le,ve)=>(o(),g("div",{class:"fragment-item",key:le.number},[t(Pn,{number:le.number,title:le.title,content:le.content,total:le.word_total,question:le.question,answer:le.answer,images:le.images,onDelete:Ee=>Y(ve),onEdit:Ee=>R(le,ve)},null,8,["number","title","content","total","question","answer","images","onDelete","onEdit"])]))),128))],512)])])]),t(Tn,{ref_key:"editFragmentAlertRef",ref:p,onOk:z},null,512)])],64)}}},Aa=$e(za,[["__scopeId","data-v-9f322e00"]]),Na={class:"select-box"},Ha=["onClick"],Ba={class:"title"},Ua={class:"desc"},Qa={class:"main-content-box"},Ja={__name:"re-segmentation-page",props:{detailsInfo:{type:Object,default:()=>{}}},emits:["ok","enable"],setup($,{expose:ce,emit:te}){const C=Ue().query,f=Ot(),j=$,x=c(!1),N=c(!1),I=c(""),ae=te;let U={};const r=[{title:"图文OCR解析",desc:"通过OCR文字识别提取pdf文件内容，可以兼容扫描件，但是解析速度较慢。",pdf_parse_type:2},{title:"纯文本解析",desc:"只提取Pdf中的文字内容，如果文档为扫描件可能提取不到内容。",pdf_parse_type:1},{title:"图文解析",desc:"提取PDF文档中的图片和文字",pdf_parse_type:3}],M=nt({pdf_parse_type:2,pdf_page_num:0}),ie=()=>{ae("enable")},E=c(!1),F=v=>{E.value=v},D=v=>{U={...v},M.pdf_parse_type=2,M.pdf_page_num=v.pdf_page_num,v.type==1&&(I.value=`当页(${v.pdf_page_num})重新分段`),v.type==2&&(I.value="将文档重新分段"),v.type==3&&(I.value="重新学习文档"),x.value=!0},w=v=>{M.pdf_parse_type=v.pdf_parse_type},k=c(!1),V=()=>{if(U.type==3){if(M.pdf_parse_type==1){f.push("/library/document-segmentation?document_id="+C.id+"&source=preview");return}k.value=!0,Cn({id:C.id,pdf_parse_type:M.pdf_parse_type}).then(v=>{ue.success("重新学习成功"),(M.pdf_parse_type==2||M.pdf_parse_type==3)&&f.push({path:"/library/details/knowledge-document",query:{id:j.detailsInfo.library_id}}),M.pdf_parse_type==1&&f.push("/library/document-segmentation?document_id="+C.id+"&source=preview"),x.value=!1}).finally(()=>{k.value=!1});return}x.value=!1,N.value=!0},Q=c(null),_e=()=>{k.value=!0,Q.value.handleSaveLibFileSplit()},de=()=>{ue.success("保存成功"),N.value=!1,ae("ok",U.type)},pe=()=>{k.value=!1};return ce({show:D}),(v,W)=>{const y=he;return o(),g("div",null,[t(y,{open:x.value,"onUpdate:open":W[0]||(W[0]=ne=>x.value=ne),title:I.value,onOk:V,onCancel:ie,width:720,confirmLoading:k.value},{default:a(()=>[l("div",Na,[(o(),g(re,null,ye(r,ne=>l("div",{class:Et(["select-list-item",{active:ne.pdf_parse_type==M.pdf_parse_type}]),onClick:qe=>w(ne),key:ne.pdf_parse_type},[l("div",Ba,K(ne.title),1),l("div",Ua,K(ne.desc),1)],10,Ha)),64))])]),_:1},8,["open","title","confirmLoading"]),t(y,{open:N.value,"onUpdate:open":W[1]||(W[1]=ne=>N.value=ne),onCancel:ie,title:I.value,maskClosable:!1,"ok-text":E.value?"文档解析中,请稍候...":"确定",confirmLoading:k.value||E.value,onOk:_e,width:1e3},{default:a(()=>[l("div",Qa,[N.value?(o(),T(Aa,{key:0,onOk:de,onFinish:pe,onLoading:F,pdfState:M,ref_key:"documentSegmentationModalRef",ref:Q},null,8,["pdfState"])):X("",!0)])]),_:1},8,["open","title","ok-text","confirmLoading"])])}}},ja=$e(Ja,[["__scopeId","data-v-589f4c8b"]]),Ve=$=>(Fe("data-v-b1f3fb5c"),$=$(),De(),$),Va={class:"subsection-box"},Wa={class:"qa-list-box"},Ga={class:"list-item"},Xa=Ve(()=>l("div",{class:"list-label"},"问题",-1)),Ka={class:"list-content"},Ya={key:0,class:"list-item"},Za=Ve(()=>l("div",{class:"list-label"},"相似问法",-1)),el={class:"list-content"},tl={class:"list-item"},nl=Ve(()=>l("div",{class:"list-label"},"答案",-1)),al={class:"list-content"},ll={class:"fragment-img"},ol=["src"],sl={key:0,class:"status-tag"},il={key:1,class:"status-tag complete"},cl={class:"status-tag status-error"},rl={key:3,class:"status-tag running"},ul={class:"right-opration"},_l={class:"hover-btn-box"},dl=["onClick"],pl=Ve(()=>l("div",null,"标记设置",-1)),fl=["onClick"],ml={class:"hover-btn-box"},vl=["onClick"],hl=["onClick"],gl={__name:"qa-subsection-box",props:{paragraphLists:{type:Array,default:()=>[]},total:{type:[Number,String],default:0}},emits:["handleDelParagraph","handleScrollTargetPage","openEditSubscription","handleConvert","getStatrList"],setup($,{expose:ce,emit:te}){const C=te,f=$,j=(E,F)=>{let{id:D,title:w,content:k,question:V,answer:Q,images:_e,category_id:de}=E,pe=E.similar_questions||[];he.confirm({title:"重新转换确认",icon:null,content:`确定要重新转换【分段${F+1}】吗?`,onOk(){return new Promise((v,W)=>{It({id:D,title:w,content:k,question:V,answer:Q,images:_e,category_id:de,similar_questions:JSON.stringify(pe)}).then(y=>{C("handleConvert",E),v()}).catch(()=>{v()})})},onCancel(){}})},x=E=>{C("openEditSubscription",E)},N=E=>{he.confirm({title:"提示",icon:t(Se),content:"确认是否删除该分段?",onOk(){return new Promise((F,D)=>{Mt({id:E}).then(w=>{ue.success("删除成功"),C("handleDelParagraph",E),F()}).catch(()=>{F()})})},onCancel(){}})},I=c([]),ae=()=>{Ft().then(E=>{I.value=E.data||[],C("getStatrList",E.data||[])})};ae();const U=c(null),r=()=>{U.value.show()},M=E=>{var D;let F=(D=I.value.filter(w=>w.id==E.category_id)[0])==null?void 0:D.type;return F?Be[F]:"#F4EA2A"},ie=(E,F={})=>{Dt({id:E.id,category_id:F.id||0}).then(D=>{ue.success("设置成功"),E.category_id=F.id})};return ce({handleOpenEditModal:x}),(E,F)=>{const D=Mn,w=Je,k=je,V=at,Q=lt,_e=ot,de=Fn,pe=et("viewer");return o(),g("div",Va,[t(de,{"data-source":$.paragraphLists,pagination:!1},{default:a(()=>[t(D,{key:"id","data-index":"id",width:1148},{title:a(()=>[S("问答（共"+K(f.total)+"个）",1)]),default:a(({record:v})=>[l("div",Wa,[l("div",Ga,[Xa,l("div",Ka,K(v.question),1)]),v.similar_questions&&v.similar_questions.length?(o(),g("div",Ya,[Za,l("div",el,K(v.similar_questions.join("/")),1)])):X("",!0),l("div",tl,[nl,l("div",al,K(v.answer),1)]),tt((o(),g("div",ll,[(o(!0),g(re,null,ye(v.images,(W,y)=>(o(),g("img",{key:y,src:W,alt:""},null,8,ol))),128))])),[[pe]])])]),_:1}),t(D,{title:"嵌入状态",key:"status_text","data-index":"status_text",width:128},{default:a(({record:v})=>[v.status==0?(o(),g("span",sl,[t(Z(In)),S(" 未转换")])):X("",!0),v.status==1?(o(),g("span",il,[t(Z(dn)),S(" 已转换")])):X("",!0),v.status==2?(o(),T(w,{key:2,placement:"top"},{title:a(()=>[l("span",null,K(v.errmsg),1)]),default:a(()=>[l("span",null,[l("span",cl,[t(Z(pn)),S(" 转换异常")])])]),_:2},1024)):X("",!0),v.status==3?(o(),g("span",rl,[t(k,{size:"small"}),S(" 转换中")])):X("",!0)]),_:1}),t(D,{title:"操作",key:"action","data-index":"action",width:120},{default:a(({record:v,index:W})=>[l("div",ul,[t(_e,null,{overlay:a(()=>[t(Q,null,{default:a(()=>[(o(!0),g(re,null,ye(I.value,y=>(o(),T(V,{key:y.id},{default:a(()=>[l("div",{class:"start-item",onClick:ne=>ie(v,y)},[t(Z(He),{style:Oe({color:Z(Be)[y.type]})},null,8,["style"]),l("div",null,K(y.name||"-"),1)],8,dl)]),_:2},1024))),128)),t(V,null,{default:a(()=>[l("div",{class:"start-item",onClick:r},[t(Z(Nt)),pl])]),_:1})]),_:2},1024)]),default:a(()=>[l("div",_l,[v.category_id>0?(o(),T(Z(He),{key:0,onClick:y=>ie(v,{}),style:Oe({color:M(v),"font-size":"16px"})},null,8,["onClick","style"])):(o(),T(Z(Pt),{key:1,onClick:y=>ie(v,I.value[0]),style:{"font-size":"16px"}},null,8,["onClick"]))])]),_:2},1024),t(w,null,{title:a(()=>[S("重新转换")]),default:a(()=>[l("div",{class:"hover-btn-box",onClick:y=>j(v,W)},[t(Z(Ht))],8,fl)]),_:2},1024),t(_e,{placement:"bottomRight"},{overlay:a(()=>[t(Q,null,{default:a(()=>[t(V,null,{default:a(()=>[l("div",{onClick:Ne(y=>x(v),["stop"])},"编辑",8,vl)]),_:2},1024),t(V,null,{default:a(()=>[l("div",{onClick:Ne(y=>N(v.id),["stop"])},"删除",8,hl)]),_:2},1024)]),_:2},1024)]),default:a(()=>[l("div",ml,[t(Z(Bt))])]),_:2},1024)])]),_:1})]),_:1},8,["data-source"]),t(Tt,{onOk:ae,ref_key:"classificationMarkModalRef",ref:U},null,512)])}}},kl=$e(gl,[["__scopeId","data-v-b1f3fb5c"]]),We=$=>(Fe("data-v-73931f6f"),$=$(),De(),$),yl={class:"library-preview-page"},bl={class:"breadcrumb-block"},Sl={class:"library-line1"},wl={class:"selct-star-box"},Cl={class:"document-title-block",style:{height:"22px"}},xl={class:"title"},$l={class:"search-content-block"},ql={class:"preview-box"},Ll=We(()=>l("span",null,"添加分段",-1)),Ol={key:0,class:"page-loading-box"},El={class:"content-block"},Rl={class:"content-block"},Pl={key:1,class:"pdf-view-box"},Tl={key:0,class:"pdf-mode-switch"},Il={key:0},Ml={key:1,class:"segmentation-btn"},Fl=We(()=>l("div",null,"将当页重新分段",-1)),Dl=We(()=>l("div",null,"将文档重新分段",-1)),zl=We(()=>l("div",null,"重新学习文档",-1)),Al={class:"view-content-box",style:{"padding-top":"60px"}},Nl=["onClick"],Hl={key:0,class:"content-box"},Bl={key:1,class:"content-box"},Ul=["innerHTML"],Ql={class:"fragment-img"},Jl=["src"],jl={class:"right-contnt-box"},Vl={class:"content-block"},Wl="你是一位文章分段助手，根据文章内容的语义进行合理分段，确保每个分段表述一个完整的语义，每个分段字数控制在500字左右，最大不超过1000字。请严格按照文章内容进行分段，不要对文章内容进行加工，分段完成后输出分段后的内容。",Gl={__name:"library-preview",setup($){const ce=fn(),te=we(()=>{var e;return((e=ce.companyInfo)==null?void 0:e.neo4j_status)=="true"}),C=c(!1),f=c(null),j=c(0),x=c(0),N={0:"待生成",4:"生成中",2:"生成成功",3:"生成失败"},I=c([]),ae=e=>{I.value=e},U=c({fade:!1,scrollbarTrackClickable:!0,interactive:!0,minSize:40}),r=Ue(),M=Ot(),ie=mn(),E=we(()=>k.value.is_table_file=="1"),F=we(()=>k.value.doc_type),D=we(()=>{let e=k.value.status;return!(e=="1"||e=="2")||b.value.length==0}),w=we(()=>k.value.is_qa_doc=="1"),k=c({}),V=nt({status:-1,graph_status:-1,category_id:-1}),Q=c(1),_e=we(()=>"/manage/getLibRawFile?id="+r.query.id+"&token="+ie.getToken),de=()=>{M.back()},pe=c(null),v=c(null);let W=-1;const y=(e,s=1)=>{let u,h;s==1?(u=".subsection-box .list-item",h=v.value):(u=".view-content-box .list-item",h=pe.value);const L=document.querySelectorAll(u)[e];L.classList.add("flash-border"),W>=0&&document.querySelectorAll(u)[W].classList.remove("flash-border"),setTimeout(()=>{W=-1,L.classList.remove("flash-border")},2500),W=e,h.scrollToElement({el:L,time:1e3})},ne=c(!0),qe=c(0),ge=c({page:1,size:10}),Te=c({}),b=c([]),i=c(0),_={0:"未转换",1:"已转换",2:"转换异常",3:"转换中..."},H=c(1);let p={id:r.query.id,separators_no:"",chunk_size:512,chunk_overlap:50,is_qa_doc:0,question_lable:"",similar_label:"",answer_lable:"",enable_extract_image:!0,ai_chunk_size:5e3,ai_chunk_model:"",ai_chunk_model_config_id:"",ai_chunk_prumpt:Wl,ai_chunk_task_id:""};const B=c(!1);let R=!0;(async()=>{zt({id:r.query.id}).then(e=>{qe.value=e.data.library_type,k.value={...e.data,graph_switch:e.data.graph_switch=="1"&&te.value};let s=e.data.status;s==1||s==2?q():ne.value=!1,p={...p,separators_no:e.data.separators_no||"11,12",chunk_size:+e.data.chunk_size||512,ai_chunk_size:+e.data.ai_chunk_size||5e3,chunk_overlap:+e.data.chunk_overlap||50,is_qa_doc:qe.value==2?1:0,question_lable:e.data.question_lable,similar_label:e.data.similar_label,answer_lable:e.data.answer_lable,question_column:e.data.question_column,similar_column:e.data.similar_column,answer_column:e.data.answer_column,enable_extract_image:e.data.enable_extract_image=="true",qa_index_type:+e.data.qa_index_type,chunk_type:+e.data.chunk_type,semantic_chunk_size:+e.data.semantic_chunk_size||512,semantic_chunk_overlap:+e.data.semantic_chunk_overlap||50,semantic_chunk_threshold:+e.data.semantic_chunk_threshold||90,semantic_chunk_use_model:e.data.semantic_chunk_use_model||"",ai_chunk_prumpt:e.data.ai_chunk_prumpt||"",ai_chunk_model:e.data.ai_chunk_model||"",semantic_chunk_model_config_id:e.data.semantic_chunk_model_config_id>0?e.data.semantic_chunk_model_config_id:"",ai_chunk_model_config_id:e.data.ai_chunk_model_config_id>0?e.data.ai_chunk_model_config_id:"",ai_chunk_task_id:e.data.ai_chunk_task_id||""},e.data.chunk_type==0&&(p={...p,separators_no:e.data.normal_chunk_default_separators_no,chunk_size:+e.data.normal_chunk_default_chunk_size,chunk_overlap:+e.data.normal_chunk_default_chunk_overlap,chunk_type:+e.data.default_chunk_type,semantic_chunk_size:+e.data.semantic_chunk_default_chunk_size,semantic_chunk_overlap:+e.data.semantic_chunk_default_chunk_overlap,semantic_chunk_threshold:+e.data.semantic_chunk_default_threshold,semantic_chunk_use_model:e.data.default_use_model||"",semantic_chunk_model_config_id:e.data.default_model_config_id>0?e.data.default_model_config_id:""}),(s==4||s==2)&&(H.value=parseInt(e.data.is_table_file))})})();const Y=()=>{ge.value.page=1,i.value=0,b.value=[],q()},d=e=>{V.category_id=e,Y()},ee=(e=null)=>{ge.value.page++,q(e)},q=(e=null)=>{R=!0,St({file_id:r.query.id,...ge.value,...V}).then(s=>{var m,A;ne.value=!1,R=!1;let u=s.data,h=u.list||[],L=((m=u.info)==null?void 0:m.is_qa_doc)=="1"&&((A=u.info)==null?void 0:A.is_table_file)=="1";h.forEach(me=>{me.status_text=_[me.status],me.graph_status_text=N[me.graph_status],me.isExcelQa=L,me.similar_questions&&(me.similar_questions=JSON.parse(me.similar_questions))}),Te.value=u.info,ge.value.page==1&&(b.value=[]),b.value=[...b.value,...h],i.value=u.total,typeof e=="function"&&e()})},fe=()=>{R||b.value.length>=i.value||(ee(),f.value&&f.value.loadMore())},ke=()=>{n()};let be=null;function Le(){clearInterval(be),b.value.filter(s=>s.status==3).length?be=setInterval(()=>{n()},5e3):clearInterval(be)}const n=()=>{St({file_id:r.query.id,page:1,size:b.value.length,...V}).then(e=>{var L,m;let s=e.data,u=s.list||[],h=((L=s.info)==null?void 0:L.is_qa_doc)=="1"&&((m=s.info)==null?void 0:m.is_table_file)=="1";u.forEach(A=>{A.status_text=_[A.status],A.graph_status_text=N[A.graph_status],A.isExcelQa=h,A.similar_questions&&(A.similar_questions=JSON.parse(A.similar_questions))}),b.value=u,Le()})},O=e=>{if(!e.id){ge.value.page=1,q();return}let s=b.value,u=s.findIndex(h=>h.id==e.id);if(u>-1){let h=s[u];h.title=e.title,h.content=e.content,h.question=e.question,h.answer=e.answer,h.images=e.images,h.category_id=e.category_id,h.word_total=e.question.length+e.answer.length+e.content.length,h.similar_questions=e.similar_questions.length?JSON.parse(e.similar_questions):[],s.splice(u,1,h),b.value=s}},G=e=>{let s=b.value,u=s.findIndex(h=>h.id==e);u>-1&&(s.splice(u,1),b.value=s,i.value=i.value--)},le=c(null),ve=e=>{le.value.showModal(JSON.parse(JSON.stringify(e)))},Ee=c(null),Jt=()=>{xn({id:r.query.id}).then(()=>ue.success("操作完成"))},jt=()=>{$n({id:r.query.id}).then(()=>ue.success("操作完成"))},it=c(null),Vt=()=>{it.value.show(k.value)},ct=()=>{M.push("/library/document-segmentation?document_id="+r.query.id+"&source=preview")},Wt=()=>{Ee.value.open({id:r.query.id,doc_auto_renew_frequency:k.value.doc_auto_renew_frequency})},Gt=e=>{k.value.doc_auto_renew_frequency=e},Xt=e=>{k.value.file_name=e},Kt=e=>{const s=()=>{for(let u in b.value)if(b.value[u].page_num==e){y(u);return}};if(e>b.value[b.value.length-1].page_num){ue.warning("分段数据正在加载，请稍后...");const u=()=>{e<=b.value[b.value.length-1].page_num?(ue.success("加载完成"),Ze(()=>{s()})):ee(u)};ee(u)}else s()},Yt=(e,s)=>{x.value=s,j.value=e,b.value[b.value.length-1].page_num<e&&ee()},rt=e=>{var s;if(((s=k.value)==null?void 0:s.file_ext)=="pdf"&&Q.value==1){const u=e.page_num-1,h=()=>document.querySelectorAll(".pdf-render-box > .scroll-content .vue-pdf-embed")[u],L=()=>{const A=h();A.classList.add("flash-border"),setTimeout(()=>A.classList.remove("flash-border"),2500),f.value.getScrollInstance().scrollToElement({el:A,time:1e3})};if(h())L();else{ue.warning("PDF正在加载，请稍后...");const A=()=>{h()?(ue.success("加载完成"),L()):f.value&&f.value.loadMore()};f.value&&f.value.loadMore(A)}}else y(e.index,2)},Ge=c(1);let Xe=null;const ze=c(0),Zt=e=>{ze.value=e},en=({y:e})=>{if(!Xe){const u=document.querySelectorAll(".pdf-render-box > .scroll-content .vue-pdf-embed")[0];Xe=u&&u.clientHeight}let s=Math.floor(Math.abs(e)/Xe)+1;Ge.value=Math.max(s,1)},Ke=c(null),tn=e=>{let{key:s}=e;f.value&&f.value.getScrollInstance().disable(),s==1&&Ke.value.show({type:s,pdf_page_num:Ge.value}),s==2&&ct(),s==3&&Ke.value.show({type:s,pdf_page_num:0})},ut=()=>{f.value&&f.value.getScrollInstance().enable()},nn=()=>{ut(),Y()},_t=()=>{C.value=!C.value},dt=(e,s)=>{let u=JSON.parse(JSON.stringify(e));return u.content=s,u.word_total=s.length,u},Ce=c(!1),xe=c(1),pt=({index:e,beforeContent:s,selectedContent:u,afterContent:h,isFullSelection:L})=>{const m=[...b.value];Ce.value=L,xe.value=1,L?(m.splice(e+1,0,dt(m[e],u)),m.splice(e,1)):(m[e].content=s||"",m[e].word_total=s.length||0,m.splice(e+1,0,dt(m[e],u)),h.trim()&&(m[e].content+=h||"",m[e].word_total+=h.length||0),m[e+1].images=[]),b.value=m,Re(m,e)},ft=({index:e,beforeContent:s,selectedContent:u,afterContent:h,isFullSelection:L})=>{const m=[...b.value];Ce.value=L,xe.value=2,L?(m[e+1].content=u+m[e+1].content,m[e+1].word_total+=u.length,m.splice(e,1),b.value=m,Re(m,e)):(m[e].content=s||"",m[e].word_total=s.length||0,m[e+1].content=u+m[e+1].content,h.trim()&&(m[e].content+=h||"",m[e].word_total+=h.length||0),b.value=m,Re(m,e+1))},mt=({index:e,beforeContent:s,selectedContent:u,afterContent:h,isFullSelection:L})=>{const m=[...b.value];Ce.value=L,xe.value=3,L?(m[e-1].content+=u,m[e-1].word_total+=u.length,m.splice(e,1),b.value=m,Re(m,e)):(m[e].content=s||"",m[e].word_total=s.length||0,m[e-1].content+=u,h.trim()&&(m[e].content+=h||"",m[e].word_total+=h.length||0),b.value=m,Re(m,e-1))},vt=({index:e,beforeContent:s,afterContent:u,isFullSelection:h})=>{const L=[...b.value];Ce.value=h,xe.value=4,h?L.splice(e,1):(L[e].content=s||"",L[e].word_total=s.length||0,u.trim()&&(L[e].content+=u||"",L[e].word_total+=u.length||0)),b.value=L,Re(L,e)};function an(e,s,u={},h){let L=h+1;if(!Array.isArray(e)||!Array.isArray(s))return JSON.stringify([]);const m=e.map((A,me)=>{const J={};for(const P of s){const Ie=u[P]||P,se=A[Ie];if(Object.prototype.hasOwnProperty.call(A,Ie))if(P==="number")J[P]=me+1;else if(P==="page_num"||P==="word_total")J[P]=+se;else if(P==="content"){if(!se)return null;J[P]=se}else P==="images"?xe.value==1?Ce.value?(L==J.number,J[P]=se):L+1==J.number?J[P]=[]:J[P]=se:xe.value==2?(Ce.value,L==J.number,J[P]=se):xe.value==3?Ce.value?(L-1==J.number,J[P]=se):(L==J.number,J[P]=se):xe.value==4&&(Ce.value,J[P]=se):J[P]=se}return J}).filter(A=>A!==null&&A.content!==void 0&&A.content!=="");return JSON.stringify(m)}const ln={similar_question_list:"similar_questions"},Re=async(e,s)=>{let u={...p,semantic_chunk_model_config_id:p.semantic_chunk_model_config_id?+p.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:p.ai_chunk_model_config_id?+p.ai_chunk_model_config_id:0,is_table_file:H.value};delete u.id;let h={id:r.query.id,word_total:i.value,split_params:JSON.stringify(u),list:an(e,["number","page_num","title","content","question","similar_question_list","answer","word_total","images"],ln,s)};u.is_qa_doc==1&&(h.qa_index_type=u.qa_index_type),B.value=!0,At(h).then(()=>{ue.success("操作成功"),O(e[s])}).finally(()=>{B.value=!1})};return Qe(()=>{r.query.graph_status&&(V.graph_status=r.query.graph_status,Y())}),(e,s)=>{var gt,kt,yt;const u=vn("router-link"),h=zn,L=Dn,m=qt,A=$t,me=Ut,J=Qt,P=at,Ie=lt,se=ot,on=An,sn=je,Ae=Je,ht=Hn,cn=Nn,rn=et("viewer");return o(),g("div",yl,[l("div",bl,[t(L,null,{default:a(()=>[t(h,null,{default:a(()=>[t(u,{to:"/library/list"},{default:a(()=>[S(" 知识库管理 ")]),_:1})]),_:1}),t(h,null,{default:a(()=>[t(u,{to:{path:"/library/details/knowledge-document",query:{id:k.value.library_id}}},{default:a(()=>[l("div",Sl,K(k.value.library_name)+"知识库",1)]),_:1},8,["to"])]),_:1}),t(h,null,{default:a(()=>[S("知识库详情")]),_:1})]),_:1}),l("div",wl,[t(gn,{startLists:I.value,onChange:d},null,8,["startLists"])])]),l("div",Cl,[t(Z(Bn),{onClick:de}),l("span",xl,K(k.value.file_name),1),t(ba,{detailsInfo:k.value},null,8,["detailsInfo"])]),l("div",$l,[l("div",ql,[C.value?(o(),T(A,{key:1,onClick:s[1]||(s[1]=oe=>_t())},{default:a(()=>[t(m,{class:"preview-box-icon",name:"expand"}),S(" 展开预览")]),_:1})):(o(),T(A,{key:0,onClick:s[0]||(s[0]=oe=>_t())},{default:a(()=>[t(m,{class:"preview-box-icon",name:"put-away"}),S(" 收起预览")]),_:1}))]),t(on,null,{default:a(()=>[t(J,{value:V.status,"onUpdate:value":s[2]||(s[2]=oe=>V.status=oe),placeholder:"请选择",style:{width:"160px"},onChange:Y},{default:a(()=>[t(me,{value:-1},{default:a(()=>[S("全部嵌入状态")]),_:1}),(o(),g(re,null,ye(_,(oe,Pe)=>t(me,{key:oe,value:Pe},{default:a(()=>[S(K(oe),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"]),k.value.graph_switch?(o(),T(J,{key:0,value:V.graph_status,"onUpdate:value":s[3]||(s[3]=oe=>V.graph_status=oe),placeholder:"请选择",onChange:Y,style:{width:"160px"}},{default:a(()=>[t(me,{value:-1},{default:a(()=>[S("全部知识图谱状态")]),_:1}),(o(),g(re,null,ye(N,(oe,Pe)=>t(me,{key:oe,value:Pe},{default:a(()=>[S(K(oe),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])):X("",!0),t(se,null,{overlay:a(()=>[t(Ie,null,{default:a(()=>[t(P,{onClick:Jt},{default:a(()=>[S("重新嵌入向量")]),_:1}),k.value.graph_switch?(o(),T(P,{key:0,onClick:jt},{default:a(()=>[S("重新抽取知识图谱")]),_:1})):X("",!0),t(P,{onClick:Vt},{default:a(()=>[S("重命名")]),_:1}),F.value==2?(o(),T(P,{key:1,onClick:Wt},{default:a(()=>[S("设置更新频率")]),_:1})):X("",!0)]),_:1})]),default:a(()=>[t(A,null,{default:a(()=>[S("其他操作 "),t(Z(Ct))]),_:1})]),_:1}),F.value!=3?(o(),T(A,{key:1,onClick:ct},{default:a(()=>[S("重新分段")]),_:1})):X("",!0),t(A,{onClick:s[4]||(s[4]=oe=>ve({})),type:"primary"},{icon:a(()=>[t(Z(Rt))]),default:a(()=>[Ll]),_:1})]),_:1})]),ne.value?(o(),g("div",Ol,[t(sn)])):(o(),g(re,{key:1},[w.value?(o(),g(re,{key:0},[D.value?(o(),T(Ye,{key:0,onOpenEditSubscription:ve})):(o(),T(Me,{key:1,scrollbar:{minSize:0},onOnScrollEnd:fe},{default:a(()=>[l("div",El,[t(kl,{ref:"subsectionBoxRef",total:i.value,paragraphLists:b.value,detailsInfo:k.value,onOpenEditSubscription:ve,onHandleDelParagraph:G,onHandleConvert:ke,onGetStatrList:ae},null,8,["total","paragraphLists","detailsInfo"])])]),_:1}))],64)):(o(),g(re,{key:1},[E.value||F.value==3?(o(),g(re,{key:0},[D.value?(o(),T(Ye,{key:0,onOpenEditSubscription:ve})):(o(),T(Me,{key:1,scrollbar:{minSize:0},onOnScrollEnd:fe},{default:a(()=>[l("div",Rl,[t(xt,{ref:"subsectionBoxRef",total:i.value,detailsInfo:k.value,paragraphLists:b.value,onOpenEditSubscription:ve,onHandleDelParagraph:G,onHandleConvert:ke,onHandleScrollTargetPage:rt,onGetStatrList:ae,onHandleSplit:pt,onHandleSplitNext:ft,onHandleSplitUp:mt,onHandleSplitDelete:vt},null,8,["total","detailsInfo","paragraphLists"])])]),_:1}))],64)):(o(),g("div",Pl,[l("div",{class:Et(["view-content-wrap",{collapsed:C.value}])},[((gt=k.value)==null?void 0:gt.file_ext)=="pdf"?(o(),g("div",Tl,[t(cn,{value:Q.value,"onUpdate:value":s[5]||(s[5]=oe=>Q.value=oe)},{default:a(()=>[t(ht,{value:1},{default:a(()=>[t(Ae,{placement:"right",title:"原文预览模式下，会展示pdf原始文件内容，手动编辑分段的不会展示。您可以通过原文预览模式，校验分段准确性，然后手动编辑分段。"},{default:a(()=>[S(" 原文预览 "),Q.value==1&&ze.value>0?(o(),g("span",Il,"("+K(Ge.value)+" / "+K(ze.value)+")",1)):X("",!0)]),_:1})]),_:1}),t(ht,{value:2},{default:a(()=>[S("纯文本预览")]),_:1})]),_:1},8,["value"])])):X("",!0),((kt=k.value)==null?void 0:kt.file_ext)=="pdf"?(o(),g("div",Ml,[t(se,null,{overlay:a(()=>[t(Ie,{onClick:tn},{default:a(()=>[Q.value==1&&ze.value>0?(o(),T(P,{key:1},{default:a(()=>[t(Ae,{placement:"right",title:"将当前页重新解析并分段"},{default:a(()=>[Fl]),_:1})]),_:1})):X("",!0),(o(),T(P,{key:2},{default:a(()=>[t(Ae,{placement:"right",title:"将整个文档重新分段，注意，重新分段并不会重新提取文档的内容，只是将内容重新分段。"},{default:a(()=>[Dl]),_:1})]),_:1})),(o(),T(P,{key:3},{default:a(()=>[t(Ae,{placement:"right",title:"将整个文档重新学习，包含重新解析并提取文档内容，重新分段。"},{default:a(()=>[zl]),_:1})]),_:1}))]),_:1})]),default:a(()=>[t(A,null,{default:a(()=>[S(" 重新分段 "),t(Z(Ct))]),_:1})]),_:1})])):X("",!0),((yt=k.value)==null?void 0:yt.file_ext)=="pdf"&&Q.value==1?(o(),T(xa,{key:2,ref_key:"pdfRef",ref:f,class:"scroll-box pdf-render-box",source:_e.value,onSelect:Kt,onScroll:en,onRendered:Yt,onGetTotalPage:Zt},null,8,["source"])):(o(),T(Me,{key:3,scrollbar:U.value,ref_key:"leftScrollRef",ref:pe,class:"scroll-box",onOnScrollEnd:fe},{default:a(()=>[l("div",Al,[(o(!0),g(re,null,ye(b.value,(oe,Pe)=>(o(),g("div",{class:"list-item",onClick:bt=>y(Pe),key:Pe},[oe.question?(o(),g("div",Hl,K(oe.question),1)):X("",!0),oe.answer?(o(),g("div",Bl,K(oe.answer),1)):X("",!0),l("div",{class:"content-box",innerHTML:oe.content},null,8,Ul),tt((o(),g("div",Ql,[(o(!0),g(re,null,ye(oe.images,(bt,un)=>(o(),g("img",{key:un,src:bt,alt:""},null,8,Jl))),128))])),[[rn]])],8,Nl))),128))])]),_:1},8,["scrollbar"]))],2),l("div",jl,[D.value?(o(),T(Ye,{key:0,onOpenEditSubscription:ve})):(o(),T(Me,{key:1,scrollbar:U.value,ref_key:"rightScrollRef",ref:v,onOnScrollEnd:fe},{default:a(()=>[l("div",Vl,[t(xt,{ref:"subsectionBoxRef",total:i.value,detailsInfo:k.value,paragraphLists:b.value,onOpenEditSubscription:ve,onHandleDelParagraph:G,onHandleConvert:ke,onHandleScrollTargetPage:rt,onGetStatrList:ae,onHandleSplit:pt,onHandleSplitNext:ft,onHandleSplitUp:mt,onHandleSplitDelete:vt},null,8,["total","detailsInfo","paragraphLists"])])]),_:1},8,["scrollbar"]))])]))],64))],64)),t(kn,{detailsInfo:k.value,onHandleEdit:O,ref_key:"editSubscriptionRef",ref:le},null,8,["detailsInfo"]),t(Sa,{onOk:Gt,ref_key:"updateFrequencyRef",ref:Ee},null,512),t(On,{onOk:Xt,ref_key:"renameModalRef",ref:it},null,512),t(ja,{onOk:nn,onEnable:ut,detailsInfo:k.value,ref_key:"reSegmentationPageRef",ref:Ke},null,8,["detailsInfo"])])}}},Ss=$e(Gl,[["__scopeId","data-v-73931f6f"]]);export{Ss as default};
