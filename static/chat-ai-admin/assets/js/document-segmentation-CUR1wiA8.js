import{a5 as he,a4 as ke,e as l,x as ve,b as ge,D as be,a8 as ye,M as h,N as S,k as o,a7 as O,W as c,S as k,u as Se,Z as G,Q as xe,Y as z,F as H,$ as qe,a1 as we,a2 as Fe}from"./vue-chunks-DWnFCQSz.js";import{S as Le,D as Ee,E as Te,a as Ce}from"./edit-fragment-alert-CLj7dpit.js";import{b as De,e as ze,f as Ie,s as Ne,h as Be}from"./index-DIUiarE3.js";import{b as Oe,M as I,E as K,k as X}from"../../index-UhR4yadr.js";import{B as Ae,_ as Re}from"./index-D2NjFshG.js";import{S as Ve}from"./index-BWhNhRp3.js";import{L as Me}from"./LeftOutlined-CKIj-GEZ.js";import"./empty-CzGZrENG.js";import"./model-select-6loF5tMn.js";import"./index-cS6xwXeR.js";import"./index-DrSPxL4Q.js";import"./index-9VXz7HRC.js";import"./Trigger-DcWVD-r5.js";import"./statusUtils--roYFmJe.js";import"./slide-BR5NTmcW.js";import"./index-DXeZ5ybK.js";import"./CheckOutlined-B_iCQ6FL.js";import"./DownOutlined-CvDOGKH1.js";import"./SearchOutlined-bV5WeZB5.js";import"./FormItemContext-BJa1evck.js";import"./move-cWZng2f8.js";import"./index-DzuDS3Yk.js";import"./isPlainObject-BeqP4IC7.js";import"./responsiveObserve-Bs6--9PQ.js";import"./collapseMotion-ByInPrfq.js";import"./index-kKxyythX.js";import"./colors-BiofrUQp.js";import"./QuestionCircleOutlined-CV_adx6X.js";import"./index--Qvpscnx.js";import"./Input-D7W5TJDt.js";import"./inputProps-CiDWLiIl.js";import"./index-DmSlXGTl.js";import"./Search-BRb_v-2B.js";import"./TextArea-CpTIlaWe.js";import"./Password-XreinKYD.js";import"./index-BnhNOVTI.js";import"./UpOutlined-BkQ7BaZ8.js";import"./index-RGagVdKM.js";import"./index-f5cCF1C6.js";import"./index-bg5oFZUg.js";import"./index-BJ4SSG33.js";import"./partition-CNXo-yhR.js";import"./useRefs-CH9tJ50T.js";import"./index-teqAjsuU.js";import"./index-5i8OLAzS.js";import"./shallowequal-C0Ji8tJB.js";import"./Dropdown-lzT8P96r.js";import"./pick-DFWac7Lu.js";import"./PlusOutlined-CeclvJCi.js";import"./index-DzhuYAPB.js";import"./axios-Cm0UX6qg.js";import"./qs-De-rn6vz.js";import"./crypto-js-U6t3rvpm.js";import"./dayjs-BI1HIvBC.js";import"./dropdown-CbxGUAy7.js";import"./RightOutlined-BxQrTxvt.js";const ee=x=>(we("data-v-e666dc6b"),x=x(),Fe(),x),Qe={key:0,class:"loading-wrap"},je={class:"document-segmentation"},Je={class:"breadcrumb-block"},$e={class:"page-title"},Pe=ee(()=>c("span",{class:"title"},"文档分段与清洗",-1)),We={class:"page-container"},Ue={class:"page-left"},Ye={class:"page-right"},Ze={class:"document-fragment-preview"},Ge={class:"preview-header"},He=ee(()=>c("span",{class:"label-text"},"分段预览",-1)),Ke={class:"fragment-number"},Xe={key:1,class:"loading-box"},et="你是一位文章分段助手，根据文章内容的语义进行合理分段，确保每个分段表述一个完整的语义，每个分段字数控制在500字左右，最大不超过1000字。请严格按照文章内容进行分段，不要对文章内容进行加工，分段完成后输出分段后的内容。",tt={__name:"document-segmentation",setup(x){const q=he(),N=ke(),{document_id:w}=q.query,F=l(!0),L=l(1),A=l(1);let v=!1,a={id:w,separators_no:"",chunk_size:512,chunk_overlap:50,is_qa_doc:0,question_lable:"",similar_label:"",answer_lable:"",enable_extract_image:!0,ai_chunk_size:5e3,ai_chunk_model:"",ai_chunk_model_config_id:"",ai_chunk_prumpt:et,ai_chunk_task_id:""},R=!1;const p=l(null),te=e=>{typeof e.separators_no=="object"&&(e.separators_no=e.separators_no.join(",")),R=!0,a={...a,...e},v?I.confirm({title:"提醒",icon:o(K),content:"文档片段已被编辑重新获取文档片段会丢失当前修改过的文档片段内容，确定要重新获取吗？",okText:"确定",okType:"danger",cancelText:"取消",onOk(){v=!1,y("create")},onCancel(){}}):(v=!1,y("create"))};let ae=60*10,V=0,M=null;const E=l({}),T=l(0),Q=()=>{F.value||(F.value=!0),De({id:w}).then(async e=>{const{status:t}=e.data;if(T.value=e.data.library_type,E.value=e.data,a={...a,separators_no:e.data.separators_no||"11,12",chunk_size:+e.data.chunk_size||512,ai_chunk_size:+e.data.ai_chunk_size||5e3,chunk_overlap:+e.data.chunk_overlap||50,is_qa_doc:T.value==2?1:0,question_lable:e.data.question_lable,similar_label:e.data.similar_label,answer_lable:e.data.answer_lable,question_column:e.data.question_column,similar_column:e.data.similar_column,answer_column:e.data.answer_column,enable_extract_image:e.data.enable_extract_image=="true",qa_index_type:+e.data.qa_index_type,chunk_type:+e.data.chunk_type,semantic_chunk_size:+e.data.semantic_chunk_size||512,semantic_chunk_overlap:+e.data.semantic_chunk_overlap||50,semantic_chunk_threshold:+e.data.semantic_chunk_threshold||90,semantic_chunk_use_model:e.data.semantic_chunk_use_model||"",ai_chunk_prumpt:e.data.ai_chunk_prumpt||"",ai_chunk_model:e.data.ai_chunk_model||"",semantic_chunk_model_config_id:e.data.semantic_chunk_model_config_id>0?e.data.semantic_chunk_model_config_id:"",ai_chunk_model_config_id:e.data.ai_chunk_model_config_id>0?e.data.ai_chunk_model_config_id:"",ai_chunk_task_id:e.data.ai_chunk_task_id||""},e.data.chunk_type==0&&(a={...a,separators_no:e.data.normal_chunk_default_separators_no,chunk_size:e.data.normal_chunk_default_chunk_size,chunk_overlap:e.data.normal_chunk_default_chunk_overlap,chunk_type:+e.data.default_chunk_type,semantic_chunk_size:+e.data.semantic_chunk_default_chunk_size,semantic_chunk_overlap:+e.data.semantic_chunk_default_chunk_overlap,semantic_chunk_threshold:+e.data.semantic_chunk_default_threshold,semantic_chunk_use_model:e.data.default_use_model||"",semantic_chunk_model_config_id:e.data.default_model_config_id>0?e.data.default_model_config_id:""}),t==0){if(V++,V>ae){I.error({title:"提醒",content:"文档解析速度慢请稍后再试"});return}setTimeout(()=>{Q()},1e3)}else t==4||t==2?(F.value=!1,L.value=parseInt(e.data.is_table_file),M=e.data.library_id,T.value==2?(a.question_lable||a.question_column)&&y():y()):N.replace("/library/details?id="+e.data.library_id);e.data.is_table_file==1&&ne()})};ve(async()=>{await Q()});const j=l([]),ne=()=>{ze({id:w}).then(e=>{let t=[];for(let n in e.data)t.push({lable:e.data[n],value:n});j.value=t})},J=l(!1),g=l(!1),C=l(""),b=l(null);let r=null;const i=l([]),d=l(0),ie=ge(()=>d.value<=0),y=e=>{let t={...a,semantic_chunk_model_config_id:a.semantic_chunk_model_config_id?+a.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:a.ai_chunk_model_config_id?+a.ai_chunk_model_config_id:0};return a.chunk_type==3&&(a.ai_chunk_task_id&&!e&&(t.ai_chunk_task_id=a.ai_chunk_task_id),t.ai_chunk_task_id&&e&&e==="create"&&delete t.ai_chunk_task_id),Ie(t).then(n=>{var u;i.value=n.data.list||[],d.value=n.data.list.length||0,a.chunk_type==3&&(C.value=((u=n.data.split_params)==null?void 0:u.ai_chunk_task_id)||"",g.value=!0,p.value.reLoading=!0,b.value=null,!a.ai_chunk_task_id&&L.value!=1||e&&e==="create"?(i.value=[],d.value=0,se()):(g.value=!1,p.value.reLoading=!1))}).finally(()=>{a.chunk_type!=3&&(p.value.reLoading=!1)})},le=e=>{A.value=e},oe=async()=>{var e;try{const t=await ce();return t.data.err_msg?(b.value=t.data.err_msg,!0):((e=t.data.list)==null?void 0:e.length)>0?(i.value=t.data.list||[],d.value=t.data.list.length||0,!0):!1}catch{return b.value="请求异常，停止轮询",!0}};function _e(e){return e.split("message:")[1]}const se=()=>{const e=async()=>{if(!await oe())r=setTimeout(e,3e3);else if(g.value=!1,p.value.reLoading=!1,r!==null&&(clearTimeout(r),r=null),J.value&&U(),b.value){let n=_e(b.value);I.error({title:"分段失败提示",content:n?`模型调用失败，失败原因：${n}`:"模型调用失败"})}};e()},ce=()=>Be({id:a.id,task_id:C.value}),$=l(null);let _=null;const ue=(e,t)=>{let{title:n,content:u,question:m,answer:f,images:s,similar_question_list:D}=e;_=t,$.value.open({title:n,content:u,question:m,answer:f,images:s,similar_question_list:D})},re=({title:e,content:t,question:n,answer:u,images:m,similar_question_list:f})=>{(i.value[_].title!=e||i.value[_].content!=t||i.value[_].question!=n||i.value[_].answer!=u)&&(v=!0),i.value[_].title=e,i.value[_].content=t,i.value[_].question=n,i.value[_].answer=u,i.value[_].images=m,i.value[_].similar_question_list=f?f.split(`
`):[],i.value[_].word_total=u.length+n.length+t.length},de=e=>{I.confirm({title:"提醒",icon:o(K),content:"确定要删除这个片段吗?",okText:"确定",okType:"danger",cancelText:"取消",onOk(){v=!0,i.value.splice(e,1)},onCancel(){}})},B=l(""),me=e=>{B.value=e},P=l(!1),W=()=>{let e=p.value.formState;e=JSON.parse(JSON.stringify(e)),typeof e.separators_no=="object"&&(e.separators_no=e.separators_no.join(",")),a={...a,...e}},U=async()=>{if((d.value<=0||a.chunk_type!=A.value)&&(W(),await y()),W(),B.value)return X.error(B.value);if(a.chunk_type==3&&!i.value.length)return J.value=!0,!1;C.value&&(a.ai_chunk_task_id=C.value);let e={...a,semantic_chunk_model_config_id:a.semantic_chunk_model_config_id?+a.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:a.ai_chunk_model_config_id?+a.ai_chunk_model_config_id:0,is_table_file:L.value};delete e.id;let t={id:w,word_total:d.value,split_params:JSON.stringify(e),list:JSON.stringify(i.value)};e.is_qa_doc==1&&(t.qa_index_type=e.qa_index_type),P.value=!0,Ne(t).then(()=>{if(X.success("保存成功"),q.query.source=="preview"&&!R){Z();return}let n=1;q.query.page&&(n=q.query.page),N.replace("/library/details?id="+M+"&page="+n)}).finally(()=>{P.value=!1}).catch(n=>{n.data&&n.data.index&&pe(n.data.index)})},Y=l(null),pe=e=>{e=e-1;let t=Y.value.querySelectorAll(".fragment-item");t.length>=e&&t[e].scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},Z=()=>{N.back()};return be(()=>{r&&(clearTimeout(r),r=null)}),(e,t)=>{const n=Ve,u=ye("router-link"),m=Re,f=Ae;return h(),S(H,null,[F.value?(h(),S("div",Qe,[o(n)])):O("",!0),c("div",je,[c("div",Je,[o(f,null,{default:k(()=>[o(m,null,{default:k(()=>[o(u,{to:"/library/list"},{default:k(()=>[z(" 知识库管理 ")]),_:1})]),_:1}),o(m,null,{default:k(()=>[o(u,{to:{path:"/library/details/knowledge-document",query:{id:E.value.library_id}}},{default:k(()=>[z(G(E.value.library_name)+"知识库",1)]),_:1},8,["to"])]),_:1}),o(m,null,{default:k(()=>[z("分段设置")]),_:1})]),_:1})]),c("div",$e,[o(Se(Me),{onClick:Z}),Pe]),c("div",We,[c("div",Ue,[o(Le,{excellQaLists:j.value,libFileInfo:E.value,library_type:T.value,mode:L.value,ref_key:"segmentationSettingRef",ref:p,onChange:te,onChangeChunkType:le,onSave:U,onValidate:me},null,8,["excellQaLists","libFileInfo","library_type","mode"])]),c("div",Ye,[c("div",Ze,[c("div",Ge,[He,c("span",Ke,"共"+G(d.value)+"个分段",1)]),ie.value&&!g.value?(h(),xe(Ce,{key:0})):O("",!0),g.value?(h(),S("div",Xe,[o(n),z("数据处理中...")])):O("",!0),c("div",{class:"preview-box",ref_key:"previewBoxRef",ref:Y},[(h(!0),S(H,null,qe(i.value,(s,D)=>(h(),S("div",{class:"fragment-item",key:s.number},[o(Ee,{number:s.number,title:s.title,content:s.content,total:s.word_total,question:s.question,answer:s.answer,images:s.images,similar_question_list:s.similar_question_list,onDelete:fe=>de(D),onEdit:fe=>ue(s,D)},null,8,["number","title","content","total","question","answer","images","similar_question_list","onDelete","onEdit"])]))),128))],512)])])]),o(Te,{ref_key:"editFragmentAlertRef",ref:$,onOk:re},null,512)])],64)}}},ia=Oe(tt,[["__scopeId","data-v-e666dc6b"]]);export{ia as default};
